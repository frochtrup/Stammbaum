<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Stammbaum">
<title>Stammbaum</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:        #18140f;
  --surface:   #211c14;
  --surface2:  #2a2318;
  --surface3:  #342c1e;
  --border:    #3e3424;
  --gold:      #c8a84a;
  --gold-lt:   #e5c96e;
  --gold-dim:  #7a6328;
  --gold-glow: rgba(200,168,74,0.15);
  --text:      #f2e8d4;
  --text-dim:  #a0906e;
  --text-muted:#5a4e38;
  --blue:      #4a7ab5;
  --blue-dim:  #2a4a72;
  --pink:      #a84a6e;
  --pink-dim:  #6e2a42;
  --green:     #4a9060;
  --red:       #c04040;
  --radius:    14px;
  --radius-sm: 9px;
}

* { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Source Serif 4', serif;
  font-weight: 300;
  min-height: 100dvh;
  overscroll-behavior: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOPBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  position: sticky; top: 0; z-index: 200;
  background: rgba(24,20,15,0.96);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  padding: env(safe-area-inset-top, 0px) 16px 0;
  display: flex; align-items: center;
  min-height: 52px;
  gap: 10px;
}
.topbar-inner {
  display: flex; align-items: center; gap: 10px;
  width: 100%; padding: 10px 0;
}
.topbar-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.05rem; color: var(--gold);
  letter-spacing: 0.06em; flex: 1;
}
.topbar-btn {
  background: none; border: none;
  color: var(--gold); font-size: 0.9rem;
  cursor: pointer; padding: 6px 10px;
  border-radius: var(--radius-sm);
  font-family: 'Source Serif 4', serif;
  transition: background 0.15s;
  white-space: nowrap;
}
.topbar-btn:active { background: var(--surface2); }
.topbar-btn.back { color: var(--text-dim); }
.topbar-btn.primary { color: var(--gold-lt); font-weight: 600; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIEWS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.view { display: none; }
.view.active { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAMMBAUM-ANSICHT (SANDUHR)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tree-scroll {
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  height: calc(100dvh - 52px - 57px - env(safe-area-inset-bottom, 0px));
  background: var(--bg);
}
.tree-wrap { position: relative; }
.tree-svg  { position: absolute; top: 0; left: 0; pointer-events: none; }

.tree-card {
  position: absolute;
  width: 96px; height: 64px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  padding: 5px 7px;
  display: flex; flex-direction: column;
  justify-content: center; gap: 1px;
  transition: border-color 0.12s, background 0.12s;
  user-select: none;
}
.tree-card:not(.tree-card-empty):active { border-color: var(--gold); background: var(--surface3); }
.tree-card-center {
  width: 120px; height: 80px;
  border-color: var(--gold);
  background: var(--surface3);
}
.tree-card-empty {
  opacity: 0.18; cursor: default;
  border-style: dashed;
  align-items: center; justify-content: center;
}
.tree-sex  { font-size: 0.65rem; color: var(--text-muted); line-height: 1; }
.tree-name {
  font-size: 0.7rem; color: var(--text);
  overflow: hidden; line-height: 1.2;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
}
.tree-card-center .tree-name { font-size: 0.82rem; color: var(--gold-lt); font-weight: 600; }
.tree-yr   { font-size: 0.62rem; color: var(--text-dim); line-height: 1; }
.tree-card-half {
  border-style: dashed;
  border-color: var(--gold-dim);
  background: var(--bg);
}
.tree-card-half .tree-name { color: var(--text-dim); }
.tree-half-badge {
  position: absolute;
  bottom: 3px; right: 5px;
  font-size: 0.6rem; color: var(--gold-dim);
  font-family: 'Playfair Display', serif;
  font-style: italic; line-height: 1;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#v-landing {
  display: none; flex-direction: column;
  align-items: center; justify-content: center;
  min-height: 100dvh; gap: 28px;
  padding: 48px 24px;
  text-align: center;
}
#v-landing.active { display: flex; }

.brand h1 {
  font-family: 'Playfair Display', serif;
  font-size: 3rem; font-weight: 700;
  color: var(--gold); letter-spacing: 0.04em;
  line-height: 1;
}
.brand p {
  margin-top: 8px; color: var(--text-dim);
  font-style: italic; font-size: 0.95rem;
}
.ornament { color: var(--gold-dim); letter-spacing: 0.4em; font-size: 1.2rem; }

.upload-box {
  width: 100%; max-width: 340px;
  border: 2px dashed var(--gold-dim);
  border-radius: var(--radius);
  padding: 32px 20px; cursor: pointer;
  background: var(--surface);
  transition: all 0.2s;
}
.upload-box:active, .upload-box.drag { border-color: var(--gold); background: var(--surface2); }
.upload-box .ub-icon { font-size: 2.2rem; margin-bottom: 10px; }
.upload-box h3 {
  font-family: 'Playfair Display', serif;
  color: var(--gold-lt); font-size: 1rem; margin-bottom: 5px;
}
.upload-box p { color: var(--text-muted); font-size: 0.82rem; line-height: 1.5; }
#fileInput { display: none; }

.icloud-hint {
  max-width: 340px; text-align: left;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  font-size: 0.82rem; color: var(--text-dim);
  line-height: 1.6;
}
.icloud-hint strong { color: var(--gold-lt); }

.btn-ghost {
  background: none; border: 1px solid var(--border);
  color: var(--text-muted); padding: 8px 22px;
  border-radius: 20px; cursor: pointer;
  font-family: 'Source Serif 4', serif;
  font-size: 0.85rem; transition: all 0.2s;
}
.btn-ghost:active { border-color: var(--gold-dim); color: var(--text-dim); }

.landing-tagline {
  color: var(--text-muted); font-size: 0.78rem;
  text-align: center; max-width: 300px;
  line-height: 1.7; font-style: italic;
}
.btn-link {
  background: none; border: none;
  color: var(--gold-dim); font-size: 0.82rem;
  cursor: pointer; text-decoration: underline;
  font-family: 'Source Serif 4', serif;
  padding: 0;
}
.btn-link:active { color: var(--gold); }

/* â”€â”€ Place Autocomplete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.place-input-wrap { position: relative; }
.place-dropdown {
  position: absolute; z-index: 600; top: 100%; left: 0; right: 0;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 0 0 8px 8px; max-height: 180px; overflow-y: auto;
  display: none; box-shadow: 0 4px 16px rgba(0,0,0,.45);
}
.place-dropdown-item {
  padding: 9px 12px; cursor: pointer;
  font-size: 0.85rem; color: var(--text);
  border-bottom: 1px solid rgba(255,255,255,.04);
}
.place-dropdown-item:last-child { border-bottom: none; }
.place-dropdown-item:hover { background: rgba(255,255,255,.07); color: var(--gold-lt); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  z-index: 400;
  background: rgba(24,20,15,0.97);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-top: 1px solid var(--border);
  display: flex;
  padding-bottom: env(safe-area-inset-bottom, 0px);
}
.bnav-btn {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 8px 2px 10px; border: none; background: none;
  cursor: pointer; gap: 3px;
  color: var(--text-muted);
  transition: color 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.bnav-btn.active { color: var(--gold); }
.bnav-btn:active { opacity: 0.7; }
.bnav-icon { font-size: 1.2rem; line-height: 1; }
.bnav-lbl  { font-size: 0.62rem; font-family: 'Source Serif 4', serif; letter-spacing: 0.02em; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEARCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.search-wrap {
  padding: 10px 14px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
}
.search-input {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 9px 13px;
  color: var(--text);
  font-family: 'Source Serif 4', serif;
  font-size: 0.95rem; outline: none;
  transition: border-color 0.2s;
}
.search-input:focus { border-color: var(--gold-dim); }
.search-input::placeholder { color: var(--text-muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSON LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#personList { padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px)); }

.alpha-sep {
  padding: 4px 14px;
  font-size: 0.68rem; color: var(--gold-dim);
  background: var(--bg);
  font-family: 'Playfair Display', serif;
  letter-spacing: 0.08em;
}
.person-row {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  cursor: pointer; transition: background 0.12s;
}
.person-row:active { background: var(--surface2); }
.p-avatar {
  width: 44px; height: 44px; border-radius: 50%;
  background: var(--surface2); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; flex-shrink: 0; color: var(--text-muted);
}
.p-avatar.m { border-color: var(--blue-dim); color: var(--blue); }
.p-avatar.f { border-color: var(--pink-dim); color: var(--pink); }
.p-info { flex: 1; min-width: 0; }
.p-name {
  font-family: 'Playfair Display', serif;
  font-size: 0.98rem; color: var(--text);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.p-meta {
  font-size: 0.76rem; color: var(--text-muted); margin-top: 2px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.p-arrow { color: var(--text-muted); font-size: 0.85rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#v-detail { padding-bottom: calc(100px + env(safe-area-inset-bottom, 0px)); }
#v-detail.active { display: block; }

.detail-hero {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 24px 16px; text-align: center;
}
.detail-avatar {
  width: 76px; height: 76px; border-radius: 50%;
  background: var(--surface2); border: 2px solid var(--gold-dim);
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem; margin: 0 auto 14px; color: var(--gold-dim);
}
.detail-avatar.m { border-color: var(--blue); color: var(--blue); }
.detail-avatar.f { border-color: var(--pink); color: var(--pink); }
.detail-name {
  font-family: 'Playfair Display', serif;
  font-size: 1.55rem; color: var(--gold-lt); line-height: 1.2;
}
.detail-id { font-size: 0.72rem; color: var(--text-muted); margin-top: 4px; }

.section {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
}
.section-head {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 12px;
}
.section-title {
  font-size: 0.68rem; text-transform: uppercase;
  letter-spacing: 0.16em; color: var(--gold-dim);
  font-family: 'Source Serif 4', serif; font-weight: 400;
}
.section-add {
  background: none; border: 1px solid var(--border);
  color: var(--text-muted); font-size: 0.75rem;
  padding: 3px 10px; border-radius: 12px; cursor: pointer;
  font-family: 'Source Serif 4', serif; transition: all 0.15s;
}
.section-add:active { border-color: var(--gold-dim); color: var(--gold-dim); }

.fact-row {
  display: flex; gap: 10px; margin-bottom: 9px; font-size: 0.88rem;
}
.fact-lbl { color: var(--text-muted); min-width: 88px; flex-shrink: 0; font-style: italic; }
.fact-val { color: var(--text); }

.rel-row {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 0; border-bottom: 1px solid var(--border);
  cursor: pointer; transition: opacity 0.15s;
}
.rel-row:last-child { border-bottom: none; }
.rel-row:active { opacity: 0.6; }
.rel-avatar {
  width: 34px; height: 34px; border-radius: 50%;
  background: var(--surface2); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 0.9rem; flex-shrink: 0; color: var(--text-muted);
}
.rel-avatar.m { border-color: var(--blue-dim); color: var(--blue); }
.rel-avatar.f { border-color: var(--pink-dim); color: var(--pink); }
.rel-info { flex: 1; }
.rel-name {
  font-family: 'Playfair Display', serif;
  font-size: 0.92rem; color: var(--text);
}
.rel-role { font-size: 0.72rem; color: var(--text-muted); font-style: italic; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM FAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fab {
  position: fixed;
  bottom: calc(68px + env(safe-area-inset-bottom, 0px));
  right: 20px; z-index: 300;
  width: 56px; height: 56px; border-radius: 50%;
  background: var(--gold);
  border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.6rem; color: var(--bg);
  box-shadow: 0 4px 20px rgba(200,168,74,0.4);
  transition: transform 0.15s, box-shadow 0.15s;
}
.fab:active { transform: scale(0.94); box-shadow: 0 2px 10px rgba(200,168,74,0.3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL / SHEET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(0,0,0,0.7);
  display: none; align-items: flex-end;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.modal-overlay.open { display: flex; }

.sheet {
  width: 100%; background: var(--surface);
  border-radius: 20px 20px 0 0;
  border-top: 1px solid var(--border);
  padding: 0 0 env(safe-area-inset-bottom, 16px);
  max-height: 90dvh;
  overflow-y: auto;
  animation: slideUp 0.28s cubic-bezier(0.32,0.72,0,1);
}
@keyframes slideUp {
  from { transform: translateY(100%); }
  to   { transform: translateY(0); }
}

.sheet-handle {
  width: 36px; height: 4px; border-radius: 2px;
  background: var(--border); margin: 12px auto 0;
}
.sheet-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.1rem; color: var(--gold-lt);
  padding: 16px 20px 0;
}
.sheet-body { padding: 16px 20px; }

/* Form elements */
.form-group { margin-bottom: 16px; }
.form-label {
  display: block; font-size: 0.72rem;
  text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--text-muted); margin-bottom: 6px;
  font-family: 'Source Serif 4', serif;
}
.form-input, .form-select {
  width: 100%; background: var(--bg);
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 10px 12px; color: var(--text);
  font-family: 'Source Serif 4', serif; font-size: 0.95rem;
  outline: none; transition: border-color 0.2s;
  -webkit-appearance: none; appearance: none;
}
.form-input:focus, .form-select:focus { border-color: var(--gold-dim); }
.form-input::placeholder { color: var(--text-muted); }
.form-row { display: flex; gap: 10px; }
.form-row .form-group { flex: 1; }

.btn-row { display: flex; gap: 10px; margin-top: 20px; }

/* Source widget */
.src-widget { margin-bottom: 16px; }
.src-tags { display: flex; flex-wrap: wrap; gap: 6px; min-height: 28px; margin-bottom: 8px; }
.src-tag {
  display: inline-flex; align-items: center; gap: 5px;
  background: var(--surface2); border: 1px solid var(--gold-dim);
  border-radius: 20px; padding: 3px 10px 3px 12px;
  font-size: 0.78rem; color: var(--gold); cursor: default;
  font-family: 'Source Serif 4', serif;
}
.src-page-input {
  width: 64px; font-size: 0.7rem; font-family: 'Source Serif 4', serif;
  background: var(--surface3); border: 1px solid var(--border);
  border-radius: 4px; padding: 1px 5px; color: var(--text-dim);
}
.src-page-input::placeholder { color: var(--text-muted); }
.src-tag-x {
  background: none; border: none; color: var(--text-muted);
  cursor: pointer; font-size: 0.9rem; padding: 0; line-height: 1;
}
.src-tag-x:active { color: var(--red); }
.src-add-btn {
  display: inline-flex; align-items: center; gap: 4px;
  background: none; border: 1px dashed var(--border);
  border-radius: 20px; padding: 3px 10px;
  font-size: 0.78rem; color: var(--text-muted);
  cursor: pointer; font-family: 'Source Serif 4', serif;
}
.src-add-btn:active { border-color: var(--gold-dim); color: var(--gold); }
/* Source picker inside modal */
.src-picker { display:none; margin-top:6px; }
.src-picker.open { display:block; }
.src-picker-list {
  background: var(--bg); border: 1px solid var(--border);
  border-radius: var(--radius-sm); max-height: 180px; overflow-y: auto;
}
.src-picker-item {
  padding: 9px 12px; cursor: pointer; font-size: 0.85rem;
  border-bottom: 1px solid var(--border); color: var(--text-dim);
  display: flex; justify-content: space-between;
}
.src-picker-item:last-child { border-bottom: none; }
.src-picker-item:active { background: var(--surface2); }
.src-picker-item.selected { color: var(--gold); }
.src-picker-empty { padding: 12px; color: var(--text-muted); font-size: 0.82rem; text-align: center; }
.btn {
  flex: 1; padding: 12px;
  border-radius: var(--radius-sm); border: none;
  cursor: pointer; font-family: 'Source Serif 4', serif;
  font-size: 0.95rem; font-weight: 400;
  transition: opacity 0.15s;
}
.btn:active { opacity: 0.7; }
.btn-cancel { background: var(--surface2); color: var(--text-dim); }
.btn-save { background: var(--gold); color: var(--bg); font-weight: 600; }
.btn-danger { background: var(--red); color: #fff; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.export-bar {
  position: fixed;
  bottom: 0; left: 0; right: 0; z-index: 100;
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 10px 16px calc(10px + env(safe-area-inset-bottom, 0px));
  display: flex; gap: 10px;
}
.export-btn {
  flex: 1; padding: 11px;
  border-radius: var(--radius-sm); border: none;
  cursor: pointer; font-family: 'Source Serif 4', serif;
  font-size: 0.88rem; transition: opacity 0.15s;
}
.export-btn:active { opacity: 0.7; }
.export-btn.icloud { background: var(--gold); color: var(--bg); font-weight: 600; }
.export-btn.new-person { background: var(--surface2); color: var(--text-dim); border: 1px solid var(--border); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast {
  position: fixed; bottom: calc(68px + env(safe-area-inset-bottom, 0px)); left: 50%;
  transform: translateX(-50%);
  background: var(--surface2); border: 1px solid var(--gold-dim);
  color: var(--text); padding: 9px 18px; border-radius: 20px;
  font-size: 0.83rem; opacity: 0; transition: opacity 0.25s;
  z-index: 1000; white-space: nowrap; pointer-events: none;
}
.toast.show { opacity: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOURCES VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.source-card {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  cursor: pointer; transition: background 0.12s;
}
.source-card:active { background: var(--surface2); }
.source-title {
  font-family: 'Playfair Display', serif;
  font-size: 0.95rem; color: var(--text);
}
.source-meta { font-size: 0.76rem; color: var(--text-muted); margin-top: 3px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUELLEN-BADGE (kompakt)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.src-badge {
  display: inline-flex; align-items: center;
  background: none;
  border: 1px solid var(--gold-dim);
  border-radius: 8px; padding: 0px 5px;
  font-size: 0.62rem; color: var(--gold-dim);
  cursor: pointer; margin: 1px 2px 1px 5px;
  font-family: 'Source Serif 4', serif;
  vertical-align: middle; line-height: 1.6;
  transition: color 0.12s, border-color 0.12s;
}
.src-badge:active { color: var(--gold); border-color: var(--gold); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHANGED INDICATOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.changed-dot {
  display: inline-block; width: 7px; height: 7px;
  border-radius: 50%; background: var(--gold);
  margin-left: 6px; vertical-align: middle;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FAMILY LINK ROW (in Detail-Ansicht)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.family-nav-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 0; margin-bottom: 4px;
  color: var(--gold-lt); font-size: 0.82rem;
  cursor: pointer; border-bottom: 1px solid var(--border);
  font-family: 'Source Serif 4', serif;
}
.family-nav-row:active { opacity: 0.6; }
.family-nav-row .fnr-label { display: flex; align-items: center; gap: 6px; }
.family-nav-row .fnr-icon { font-size: 1rem; }
.row-arrow { color: var(--gold-dim); font-size: 1.15rem; line-height: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIST TAB CONTENT PADDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#tab-families, #tab-sources, #tab-places {
  padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty { padding: 40px 24px; text-align: center; color: var(--text-muted); font-style: italic; font-size: 0.9rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeUp {
  from { opacity:0; transform:translateY(12px); }
  to   { opacity:1; transform:translateY(0); }
}
.fade-up { animation: fadeUp 0.3s ease both; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LANDING VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="v-landing" class="view active">
  <div class="brand">
    <div class="ornament">âœ¦  âœ¦  âœ¦</div>
    <h1>Stammbaum</h1>
    <p>GEDCOM Â· Viewer &amp; Editor</p>
  </div>

  <div class="upload-box" id="uploadBox">
    <div class="ub-icon">ğŸ“œ</div>
    <h3>GEDCOM-Datei Ã¶ffnen</h3>
    <p>Tippen Sie hier oder ziehen Sie<br>eine .ged Datei hierher</p>
    <input type="file" id="fileInput" accept="*/*">
  </div>

  <p class="landing-tagline">VollstÃ¤ndig im Browser Â· Keine Installation Â· Keine Cloud</p>

  <button class="btn-ghost" onclick="loadDemo()">Demo laden</button>
  <button class="btn-link" onclick="openModal('modalHelp')">Hilfe &amp; Anleitung â€º</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN VIEW (Tabs: Personen / Quellen)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="v-main" class="view">
  <div class="topbar">
    <div class="topbar-inner">
      <span class="topbar-title">âš˜ Stammbaum <span id="changedIndicator" style="display:none" class="changed-dot"></span></span>
      <button class="topbar-btn" onclick="exportGEDCOM()" title="Speichern">â˜ï¸</button>
      <button class="topbar-btn" onclick="openModal('modalMenu')" title="MenÃ¼" style="font-size:1.2rem; padding: 6px 8px;">â˜°</button>
    </div>
  </div>

  <div id="tab-persons">
    <div class="search-wrap">
      <input class="search-input" type="search" id="searchInput" placeholder="Name, Ort, Datum, Berufâ€¦" oninput="filterPersonsDebounced(this.value)">
    </div>
    <div id="personList"></div>
  </div>

  <div id="tab-families" style="display:none">
    <div class="search-wrap">
      <input class="search-input" type="search" id="searchFamilies" placeholder="Name, Datum, Ortâ€¦" oninput="filterFamiliesDebounced(this.value)">
    </div>
    <div id="familyList"></div>
  </div>

  <div id="tab-sources" style="display:none">
    <div class="search-wrap">
      <input class="search-input" type="search" id="searchSources" placeholder="Titel, Autorâ€¦" oninput="filterSourcesDebounced(this.value)">
    </div>
    <div id="sourceList"></div>
  </div>

  <div id="tab-places" style="display:none">
    <div class="search-wrap">
      <input class="search-input" type="search" id="searchPlaces" placeholder="Ortsnameâ€¦" oninput="filterPlacesDebounced(this.value)">
    </div>
    <div id="placeList"></div>
  </div>

  <button class="fab" id="fabBtn" onclick="showAddSheet()" title="Neu hinzufÃ¼gen">ï¼‹</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DETAIL VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="v-detail" class="view">
  <div class="topbar">
    <div class="topbar-inner">
      <button class="topbar-btn back" onclick="goBack()">â† ZurÃ¼ck</button>
      <span class="topbar-title" id="detailTopTitle"></span>
      <button class="topbar-btn" id="treeBtn" style="display:none;font-size:1rem" title="Sanduhr-Ansicht">â§–</button>
      <button class="topbar-btn primary" onclick="showEditSheet()" id="editBtn">Bearbeiten</button>
    </div>
  </div>
  <div id="detailContent"></div>
</div>

<!-- Stammbaum-Ansicht (Sanduhr) -->
<div id="v-tree" class="view">
  <div class="topbar">
    <div class="topbar-inner">
      <span class="topbar-title" id="treeTopTitle"></span>
      <button class="topbar-btn" onclick="exportGEDCOM()" title="Speichern">â˜ï¸</button>
      <button class="topbar-btn" onclick="openModal('modalMenu')" title="MenÃ¼" style="font-size:1.2rem; padding: 6px 8px;">â˜°</button>
    </div>
  </div>
  <div class="tree-scroll" id="treeScroll">
    <div class="tree-wrap" id="treeWrap">
      <svg class="tree-svg" id="treeSvg"></svg>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GLOBALE BOTTOM NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="bottom-nav" id="bottomNav" style="display:none">
  <button class="bnav-btn" id="bnav-tree" onclick="bnavTree()">
    <span class="bnav-icon">â§–</span>
    <span class="bnav-lbl">Baum</span>
  </button>
  <button class="bnav-btn" id="bnav-persons" onclick="bnavTab('persons')">
    <span class="bnav-icon">â™»</span>
    <span class="bnav-lbl">Personen</span>
  </button>
  <button class="bnav-btn" id="bnav-families" onclick="bnavTab('families')">
    <span class="bnav-icon">âš­</span>
    <span class="bnav-lbl">Familien</span>
  </button>
  <button class="bnav-btn" id="bnav-sources" onclick="bnavTab('sources')">
    <span class="bnav-icon">Â§</span>
    <span class="bnav-lbl">Quellen</span>
  </button>
  <button class="bnav-btn" id="bnav-places" onclick="bnavTab('places')">
    <span class="bnav-icon">ğŸ“</span>
    <span class="bnav-lbl">Orte</span>
  </button>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Add chooser -->
<div class="modal-overlay" id="modalAdd">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Neu hinzufÃ¼gen</div>
    <div class="sheet-body">
      <div class="btn-row" style="flex-direction:column; gap:10px">
        <button class="btn btn-save" onclick="closeModal('modalAdd'); showPersonForm(null)">ğŸ‘¤ Neue Person</button>
        <button class="btn btn-save" style="background:var(--surface2);color:var(--text-dim);border:1px solid var(--border)" onclick="closeModal('modalAdd'); showFamilyForm(null)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Neue Familie</button>
        <button class="btn btn-save" style="background:var(--surface2);color:var(--text-dim);border:1px solid var(--border)" onclick="closeModal('modalAdd'); showSourceForm(null)">ğŸ“– Neue Quelle</button>
        <button class="btn btn-save" style="background:var(--surface2);color:var(--text-dim);border:1px solid var(--border)" onclick="closeModal('modalAdd'); showNewPlaceForm()">ğŸ“ Neuer Ort</button>
        <button class="btn btn-cancel" onclick="closeModal('modalAdd')">Abbrechen</button>
      </div>
    </div>
  </div>
</div>

<!-- Person form -->
<div class="modal-overlay" id="modalPerson">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="personFormTitle">Person bearbeiten</div>
    <div class="sheet-body">
      <input type="hidden" id="pf-id">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Vorname</label>
          <input class="form-input" id="pf-given" placeholder="Anna">
        </div>
        <div class="form-group">
          <label class="form-label">Nachname</label>
          <input class="form-input" id="pf-surname" placeholder="MÃ¼ller">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Geschlecht</label>
        <select class="form-select" id="pf-sex">
          <option value="U">Unbekannt</option>
          <option value="M">MÃ¤nnlich</option>
          <option value="F">Weiblich</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Beruf</label>
        <input class="form-input" id="pf-occu" placeholder="BÃ¤ckermeister">
      </div>
      <div class="form-group">
        <label class="form-label">Notiz</label>
        <input class="form-input" id="pf-note" placeholder="Weitere Informationenâ€¦">
      </div>
      <div class="src-widget" id="pf-src-widget">
        <label class="form-label">Quellen</label>
        <div class="src-tags" id="pf-src-tags"></div>
        <button type="button" class="src-add-btn" onclick="toggleSrcPicker('pf')">ï¼‹ Quelle hinzufÃ¼gen</button>
        <div class="src-picker" id="pf-src-picker">
          <div class="src-picker-list" id="pf-src-list"></div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-cancel" onclick="closeModal('modalPerson')">Abbrechen</button>
        <button class="btn btn-save" onclick="savePerson()">Speichern</button>
      </div>
      <div style="margin-top:10px">
        <button class="btn btn-danger" id="deletePersonBtn" onclick="deletePerson()" style="width:100%">Person lÃ¶schen</button>
      </div>
    </div>
  </div>
</div>

<!-- Family form -->
<div class="modal-overlay" id="modalFamily">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="familyFormTitle">Familie bearbeiten</div>
    <div class="sheet-body">
      <input type="hidden" id="ff-id">
      <div class="form-group">
        <label class="form-label">Ehemann / Vater</label>
        <select class="form-select" id="ff-husb"><option value="">â€“ keiner â€“</option></select>
      </div>
      <div class="form-group">
        <label class="form-label">Ehefrau / Mutter</label>
        <select class="form-select" id="ff-wife"><option value="">â€“ keine â€“</option></select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Heiratsdatum</label>
          <input class="form-input" id="ff-mdate" placeholder="10 JUN 1920">
        </div>
        <div class="form-group">
          <label class="form-label">Heiratsort</label>
          <div class="place-input-wrap">
            <input class="form-input" id="ff-mplace" placeholder="MÃ¼nchen" autocomplete="off">
            <div class="place-dropdown" id="ff-mplace-dd"></div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Kinder (IDs, kommagetrennt)</label>
        <input class="form-input" id="ff-children" placeholder="@I003@, @I004@">
      </div>
      <div class="src-widget" id="ff-src-widget">
        <label class="form-label">Quellen (Heirat)</label>
        <div class="src-tags" id="ff-src-tags"></div>
        <button type="button" class="src-add-btn" onclick="toggleSrcPicker('ff')">ï¼‹ Quelle hinzufÃ¼gen</button>
        <div class="src-picker" id="ff-src-picker">
          <div class="src-picker-list" id="ff-src-list"></div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-cancel" onclick="closeModal('modalFamily')">Abbrechen</button>
        <button class="btn btn-save" onclick="saveFamily()">Speichern</button>
      </div>
      <div style="margin-top:10px">
        <button class="btn btn-danger" id="deleteFamilyBtn" onclick="deleteFamily()" style="width:100%">Familie lÃ¶schen</button>
      </div>
    </div>
  </div>
</div>

<!-- Source form -->
<div class="modal-overlay" id="modalSource">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="sourceFormTitle">Quelle bearbeiten</div>
    <div class="sheet-body">
      <input type="hidden" id="sf-id">
      <div class="form-group">
        <label class="form-label">Kurzname (ABBR)</label>
        <input class="form-input" id="sf-abbr" placeholder="KB MÃ¼nchen St. Peter">
      </div>
      <div class="form-group">
        <label class="form-label">Titel</label>
        <input class="form-input" id="sf-title" placeholder="Kirchenbuch MÃ¼nchen St. Peter 1850â€“1900">
      </div>
      <div class="form-group">
        <label class="form-label">Autor / Institution</label>
        <input class="form-input" id="sf-auth" placeholder="Pfarramt St. Peter">
      </div>
      <div class="form-group">
        <label class="form-label">Datum / Jahr</label>
        <input class="form-input" id="sf-date" placeholder="1890">
      </div>
      <div class="form-group">
        <label class="form-label">Verlag / Publikation</label>
        <input class="form-input" id="sf-publ" placeholder="Archiv MÃ¼nchen, 2001">
      </div>
      <div class="form-group">
        <label class="form-label">Aufbewahrungsort</label>
        <input class="form-input" id="sf-repo" placeholder="Stadtarchiv MÃ¼nchen">
      </div>
      <div class="form-group">
        <label class="form-label">Notiz / Beschreibung</label>
        <textarea class="form-input" id="sf-text" rows="3" placeholder="Weitere Detailsâ€¦" style="resize:vertical;box-sizing:border-box"></textarea>
      </div>
      <div class="btn-row">
        <button class="btn btn-cancel" onclick="closeModal('modalSource')">Abbrechen</button>
        <button class="btn btn-save" onclick="saveSource()">Speichern</button>
      </div>
      <div style="margin-top:10px">
        <button class="btn btn-danger" id="deleteSourceBtn" onclick="deleteSource()" style="width:100%">Quelle lÃ¶schen</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Event to person -->
<div class="modal-overlay" id="modalEvent">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Ereignis hinzufÃ¼gen</div>
    <div class="sheet-body">
      <input type="hidden" id="ef-pid">
      <input type="hidden" id="ef-evidx">
      <div class="form-group">
        <label class="form-label">Ereignistyp</label>
        <select class="form-select" id="ef-type" onchange="onEventTypeChange()">
          <option value="BIRT">Geburt</option>
          <option value="CHR">Taufe</option>
          <option value="DEAT">Tod</option>
          <option value="BURI">Beerdigung</option>
          <option value="OCCU">Beruf</option>
          <option value="RESI">Wohnort</option>
          <option value="EDUC">Bildung</option>
          <option value="RELI">Religion</option>
          <option value="EMIG">Auswanderung</option>
          <option value="IMMI">Einwanderung</option>
          <option value="NATU">EinbÃ¼rgerung</option>
          <option value="EVEN">Sonstiges</option>
        </select>
      </div>
      <div class="form-group" id="ef-val-group">
        <label class="form-label">Wert / Beschreibung</label>
        <input class="form-input" id="ef-val" placeholder="z.B. Schreiner">
      </div>
      <div class="form-group" id="ef-cause-group" style="display:none">
        <label class="form-label">Todesursache</label>
        <input class="form-input" id="ef-cause" placeholder="z.B. Typhus">
      </div>
      <div class="form-group" id="ef-addr-group" style="display:none">
        <label class="form-label">Adresse</label>
        <textarea class="form-input" id="ef-addr" rows="2" placeholder="HauptstraÃŸe 5&#10;80331 MÃ¼nchen" style="resize:vertical;box-sizing:border-box"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Datum</label>
          <input class="form-input" id="ef-date" placeholder="1910">
        </div>
        <div class="form-group">
          <label class="form-label">Ort</label>
          <div class="place-input-wrap">
            <input class="form-input" id="ef-place" placeholder="MÃ¼nchen" autocomplete="off">
            <div class="place-dropdown" id="ef-place-dd"></div>
          </div>
        </div>
      </div>
      <div class="src-widget" id="ef-src-widget">
        <label class="form-label">Quellen</label>
        <div class="src-tags" id="ef-src-tags"></div>
        <button type="button" class="src-add-btn" onclick="toggleSrcPicker('ef')">ï¼‹ Quelle hinzufÃ¼gen</button>
        <div class="src-picker" id="ef-src-picker">
          <div class="src-picker-list" id="ef-src-list"></div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-cancel" onclick="closeModal('modalEvent')">Abbrechen</button>
        <button class="btn btn-save" id="saveEventBtn" onclick="saveEvent()">HinzufÃ¼gen</button>
      </div>
    </div>
  </div>
</div>

<!-- Place rename form -->
<div class="modal-overlay" id="modalPlace">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Ort umbenennen</div>
    <div class="sheet-body">
      <input type="hidden" id="pl-old">
      <div class="form-group">
        <label class="form-label">Ortsname</label>
        <input class="form-input" id="pl-name">
      </div>
      <div class="btn-row">
        <button class="btn btn-cancel" onclick="closeModal('modalPlace')">Abbrechen</button>
        <button class="btn btn-save" onclick="savePlace()">Speichern</button>
      </div>
    </div>
  </div>
</div>

<!-- Neuer Ort -->
<div class="modal-overlay" id="modalNewPlace">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Neuer Ort</div>
    <div class="sheet-body">
      <div class="form-group">
        <label class="form-label">Ortsname *</label>
        <div class="place-input-wrap">
          <input class="form-input" id="np-name" placeholder="MÃ¼nchen, Bayern" autocomplete="off">
          <div class="place-dropdown" id="np-name-dd"></div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Breitengrad</label>
          <input class="form-input" id="np-lati" type="number" step="any" placeholder="48.1374">
        </div>
        <div class="form-group">
          <label class="form-label">LÃ¤ngengrad</label>
          <input class="form-input" id="np-long" type="number" step="any" placeholder="11.5755">
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-cancel" onclick="closeModal('modalNewPlace')">Abbrechen</button>
        <button class="btn btn-save" onclick="saveNewPlace()">HinzufÃ¼gen</button>
      </div>
    </div>
  </div>
</div>

<!-- Menu drawer -->
<div class="modal-overlay" id="modalMenu">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">MenÃ¼</div>
    <div class="sheet-body">
      <div class="btn-row" style="flex-direction:column; gap:10px">
        <button class="btn" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);text-align:left;padding:14px 16px;" onclick="closeModal('modalMenu'); document.getElementById('fileInput2').click()">
          ğŸ“‚ &nbsp; Andere Datei laden
        </button>
        <button class="btn" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);text-align:left;padding:14px 16px;" onclick="closeModal('modalMenu'); exportGEDCOM()">
          â˜ï¸ &nbsp; Als GEDCOM speichern
        </button>
        <button id="backupMenuBtn" class="btn" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);text-align:left;padding:14px 16px;" onclick="closeModal('modalMenu'); downloadBackup()">
          ğŸ—„ &nbsp; <span>Original-Backup herunterladen</span>
        </button>
        <button id="dirMenuBtn" class="btn" style="display:none;background:var(--surface2);color:var(--text);border:1px solid var(--border);text-align:left;padding:14px 16px;" onclick="closeModal('modalMenu'); pickSaveDir()">
          ğŸ“ &nbsp; <span id="dirMenuLabel">Speicher-Verzeichnis wÃ¤hlen</span>
        </button>
        <button class="btn" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);text-align:left;padding:14px 16px;" onclick="closeModal('modalMenu'); loadDemo()">
          ğŸ—‚ &nbsp; Demo-Daten laden
        </button>
        <button class="btn" style="background:var(--surface2);color:var(--text-muted);border:1px solid var(--border);text-align:left;padding:14px 16px;" onclick="closeModal('modalMenu'); confirmNewFile()">
          ğŸ—‘ &nbsp; Datei schlieÃŸen / neu beginnen
        </button>
        <button class="btn btn-cancel" onclick="closeModal('modalMenu')">Abbrechen</button>
      </div>
    </div>
  </div>
</div>
<input type="file" id="fileInput2" accept="*/*" style="display:none">

<!-- Hilfe-Modal -->
<div class="modal-overlay" id="modalHelp">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Hilfe &amp; Anleitung</div>
    <div class="sheet-body">
      <div style="font-size:0.75rem;color:var(--text-muted);text-align:center;margin-bottom:14px;letter-spacing:0.04em">
        Stammbaum PWA Â· Version 1.0 Â· MÃ¤rz 2026
      </div>
      <div style="font-size:0.85rem;color:var(--text-dim);line-height:1.7">
        <p style="margin-bottom:12px"><strong style="color:var(--gold-lt)">GEDCOM-Datei Ã¶ffnen</strong><br>
        Tippen Sie auf â€GEDCOM-Datei Ã¶ffnen" auf dem Startbildschirm. Auf dem iPhone navigieren Sie im Dateipicker zu iCloud Drive â†’ Genealogie â†’ Ihre .ged-Datei.</p>
        <p style="margin-bottom:12px"><strong style="color:var(--gold-lt)">Speichern (iPhone / iPad)</strong><br>
        Tippen Sie auf das â˜ï¸-Symbol oben rechts. Die .ged-Datei wird heruntergeladen â€” legen Sie sie in iCloud Drive ab.</p>
        <p style="margin-bottom:12px"><strong style="color:var(--gold-lt)">Speichern (Desktop / Mac)</strong><br>
        WÃ¤hlen Sie im MenÃ¼ â€Speicher-Verzeichnis wÃ¤hlen". Danach speichert â˜ï¸ direkt in Ihr Verzeichnis inkl. automatischem Backup.</p>
        <p style="margin-bottom:12px"><strong style="color:var(--gold-lt)">Navigation</strong><br>
        Nutzen Sie die untere Navigationsleiste um zwischen Baum, Personen, Familien, Quellen und Orten zu wechseln. Aus der Detailansicht gelangen Sie mit â€â† ZurÃ¼ck" wieder zur Liste.</p>
        <p style="margin-bottom:0"><strong style="color:var(--gold-lt)">Datenschutz</strong><br>
        Alle Daten bleiben auf Ihrem GerÃ¤t. Es wird nichts hochgeladen oder geteilt.</p>
      </div>
      <div class="btn-row" style="margin-top:20px">
        <button class="btn btn-cancel" onclick="closeModal('modalHelp')">SchlieÃŸen</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let db = { individuals: {}, families: {}, sources: {}, extraPlaces: {} };
let changed = false;
let _placesCache = null;  // Cache fÃ¼r collectPlaces(); wird in markChanged() geleert
let _originalGedText = null;   // In-memory backup des zuletzt geladenen Originals
let _dirHandle = null;         // FileSystemDirectoryHandle (Desktop-Speichern)
let currentPersonId = null;
let currentFamilyId = null;
let currentSourceId = null;
let currentTab = 'persons';
let idCounter = 1000;

// â”€â”€â”€ Navigations-History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ErmÃ¶glicht "ZurÃ¼ck" durch verschachtelte Detail-Ansichten
const _navHistory = [];       // Stack von {type, id|name}
let _skipHistoryPush = false; // gesetzt wÃ¤hrend goBack() navigiert

function nextId(prefix) {
  idCounter++;
  return `@${prefix}${idCounter}@`;
}

// Globale Label-Map fÃ¼r GEDCOM-Ereignis-Typen (DRY: wird in showDetail + showPlaceDetail genutzt)
const EVENT_LABELS = {
  Geburt:'Geburt', Tod:'Tod', Taufe:'Taufe', Beerdigung:'Beerdigung', Heirat:'Heirat',
  OCCU:'Beruf', RESI:'Wohnort', EDUC:'Bildung', RELI:'Religion',
  EMIG:'Auswanderung', IMMI:'Einwanderung', NATU:'EinbÃ¼rgerung',
  EVEN:'Ereignis', GRAD:'Abschluss', ADOP:'Adoption', TITL:'Titel'
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GEDCOM PARSER  (v3 â€“ geo fixed)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseGEDCOM(text) {
  text = text.replace(/^\uFEFF/, '');
  const lines = text.split(/\r?\n/);

  const individuals = {}, families = {}, sources = {}, notes = {};
  let cur = null, curType = null;
  // Simple flat context tracking
  let lv1tag = '';   // current level-1 tag
  let lv2tag = '';   // current level-2 tag
  let lv3tag = '';   // current level-3 tag
  let evIdx  = -1;   // current event index in cur.events
  let inMap  = false; // are we inside a MAP block?
  let mapParent = ''; // which lv1 tag owns current MAP (BIRT/DEAT/etc.)
  let lastSourVal = ''; // last seen 2 SOUR @id@ value (for 3 PAGE lookup)

  for (let raw of lines) {
    const line = raw.trim();
    if (!line) continue;
    const m = line.match(/^(\d+)\s+(\S+)(.*)?$/);
    if (!m) continue;
    const lv  = parseInt(m[1]);
    const tag = m[2].trim();
    const val = (m[3] || '').trim();

    // â”€â”€ Level 0 â”€â”€
    if (lv === 0) {
      lv1tag = lv2tag = lv3tag = '';
      evIdx = -1; inMap = false; mapParent = '';
      if (tag.startsWith('@') && val.trim() === 'INDI') {
        cur = {
          id: tag, name:'', surname:'', given:'', prefix:'', suffix:'',
          sex:'U', uid:'', topSources:[],
          birth:{ date:'', place:'', lati:null, long:null, sources:[], sourcePages:{} },
          death:{ date:'', place:'', lati:null, long:null, sources:[], sourcePages:{}, cause:'' },
          chr:{ date:'', place:'', lati:null, long:null, sources:[], sourcePages:{} },
          buri:{ date:'', place:'', lati:null, long:null, sources:[], sourcePages:{} },
          events:[], famc:[], fams:[],
          noteRefs:[], noteText:'',
          media:[], titl:'', reli:'', lastChanged:'',
          nameSources:[], sourceRefs: new Set()
        };
        individuals[tag] = cur; curType = 'INDI';
      } else if (tag.startsWith('@') && val.trim() === 'FAM') {
        cur = { id:tag, husb:null, wife:null, children:[], marr:{date:'',place:'',lati:null,long:null}, engag:{}, noteText:'', sourceRefs: new Set() };
        families[tag] = cur; curType = 'FAM';
      } else if (tag.startsWith('@') && val.trim() === 'SOUR') {
        cur = { id:tag, title:'', abbr:'', author:'', date:'', publ:'', repo:'', text:'', media:[] };
        sources[tag] = cur; curType = 'SOUR';
      } else if (tag.startsWith('@') && val.trim() === 'NOTE') {
        cur = { id:tag, text:'' };
        notes[tag] = cur; curType = 'NOTE';
      } else { curType = null; cur = null; }
      continue;
    }
    if (!cur) continue;

    // Track context tags
    if (lv === 1) { lv1tag = tag; lv2tag = ''; lv3tag = ''; inMap = false; mapParent = ''; lastSourVal = ''; }
    if (lv === 2) { lv2tag = tag; lv3tag = ''; if (tag !== 'MAP') inMap = false; if (tag === 'SOUR') lastSourVal = val; }
    if (lv === 3) { lv3tag = tag; if (tag === 'MAP') { inMap = true; mapParent = lv1tag; } else { inMap = false; } }

    // â”€â”€ INDIVIDUAL â”€â”€
    if (curType === 'INDI') {

      if (lv === 1) {
        evIdx = -1;
        if (tag === 'NAME') {
          const sn = val.match(/\/([^\/]*)\//) || [];
          cur.surname = sn[1] ? sn[1].trim() : '';
          cur.given   = val.replace(/\/[^\/]*\//, '').trim();
          cur.name    = (cur.given + (cur.surname ? ' ' + cur.surname : '')).trim() || val.replace(/\//g,'').trim();
        }
        else if (tag === 'SEX')  cur.sex  = val;
        else if (tag === 'TITL') cur.titl = val;
        else if (tag === 'RELI') cur.reli = val;
        else if (tag === 'FAMC') cur.famc.push({ famId:val, frel:'', mrel:'' });
        else if (tag === 'FAMS') cur.fams.push(val);
        else if (tag === 'NOTE') { if (!val.startsWith('@')) cur.noteText += val; else cur.noteRefs.push(val); }
        else if (tag === '_UID') cur.uid = val;
        else if (tag === 'SOUR' && val.startsWith('@')) { cur.topSources.push(val); cur.sourceRefs.add(val); }
        else if (tag === 'OBJE') cur.media.push({ file:'', title:'' });
        else if (['OCCU','RESI','EDUC','EMIG','IMMI','NATU','EVEN','GRAD','ADOP'].includes(tag)) {
          cur.events.push({ type:tag, value:val, date:'', place:'', lati:null, long:null, eventType:'', note:'', addr:'', sources:[], sourcePages:{} });
          evIdx = cur.events.length - 1;
        }
      }

      else if (lv === 2) {
        // Name parts
        if (lv1tag === 'NAME') {
          if (tag === 'GIVN') { cur.given = val; cur.name = (cur.given + (cur.surname ? ' '+cur.surname : '')).trim(); }
          if (tag === 'SURN') { cur.surname = val; cur.name = (cur.given + (cur.surname ? ' '+cur.surname : '')).trim(); }
          if (tag === 'NPFX') cur.prefix = val;
          if (tag === 'NSFX') cur.suffix = val;
          if (tag === 'SOUR' && val.startsWith('@')) { cur.nameSources.push(val); cur.sourceRefs.add(val); }
        }
        // Vital events
        else if (lv1tag === 'BIRT') {
          if (tag==='DATE') cur.birth.date=val;
          if (tag==='PLAC') cur.birth.place=val;
          if (tag==='SOUR' && val.startsWith('@')) { cur.birth.sources.push(val); cur.sourceRefs.add(val); }
        }
        else if (lv1tag === 'DEAT') {
          if (tag==='DATE') cur.death.date=val;
          if (tag==='PLAC') cur.death.place=val;
          if (tag==='CAUS') cur.death.cause=val;
          if (tag==='SOUR' && val.startsWith('@')) { cur.death.sources.push(val); cur.sourceRefs.add(val); }
        }
        else if (lv1tag === 'CHR') {
          if (tag==='DATE') cur.chr.date=val;
          if (tag==='PLAC') cur.chr.place=val;
          if (tag==='SOUR' && val.startsWith('@')) { cur.chr.sources.push(val); cur.sourceRefs.add(val); }
        }
        else if (lv1tag === 'BURI') {
          if (tag==='DATE') cur.buri.date=val;
          if (tag==='PLAC') cur.buri.place=val;
          if (tag==='SOUR' && val.startsWith('@')) { cur.buri.sources.push(val); cur.sourceRefs.add(val); }
        }
        // Other events
        else if (evIdx >= 0 && cur.events[evIdx]) {
          const ev = cur.events[evIdx];
          if (tag==='DATE')  ev.date = val;
          if (tag==='PLAC')  ev.place = val;
          if (tag==='TYPE')  ev.eventType = val;
          if (tag==='NOTE')  ev.note += (ev.note ? '\n' : '') + val;
          if (tag==='ADDR')  ev.addr = (ev.addr ? ev.addr + '\n' : '') + val;
          if (tag==='CONC'||tag==='CONT') ev.value += (tag==='CONT'?'\n':'') + val;
          if (tag==='SOUR' && val.startsWith('@')) { ev.sources.push(val); cur.sourceRefs.add(val); }
        }
        // Family relationship
        if (lv1tag === 'FAMC' && cur.famc.length) {
          const fref = cur.famc[cur.famc.length-1];
          if (tag==='_FREL') fref.frel = val;
          if (tag==='_MREL') fref.mrel = val;
        }
        // Media
        if (lv1tag === 'OBJE' && cur.media.length) {
          if (tag==='FILE') cur.media[cur.media.length-1].file = val;
        }
        // Last changed
        if (lv1tag === 'CHAN' && tag==='DATE') cur.lastChanged = val;
        // Collect source references at level 2
        if (tag === 'SOUR' && val.startsWith('@')) cur.sourceRefs.add(val);
      }

      else if (lv === 3) {
        // Media title/form
        if (lv1tag === 'OBJE' && lv2tag === 'FILE' && tag === 'TITL' && cur.media.length)
          cur.media[cur.media.length-1].title = val;
        if (lv1tag === 'OBJE' && tag === 'TITL' && cur.media.length)
          cur.media[cur.media.length-1].title = val;
        // Event note continuation
        if (evIdx >= 0 && lv2tag === 'NOTE' && (tag==='CONC'||tag==='CONT'))
          cur.events[evIdx].note += (tag==='CONT'?'\n':'') + val;
        // 3 PAGE under 2 SOUR â€” Seitenangabe fÃ¼r Quellenreferenz
        if (lv2tag === 'SOUR' && tag === 'PAGE' && lastSourVal.startsWith('@')) {
          if      (lv1tag === 'BIRT') { if (!cur.birth.sourcePages) cur.birth.sourcePages={}; cur.birth.sourcePages[lastSourVal] = val; }
          else if (lv1tag === 'DEAT') { if (!cur.death.sourcePages) cur.death.sourcePages={}; cur.death.sourcePages[lastSourVal] = val; }
          else if (lv1tag === 'CHR')  { if (!cur.chr.sourcePages)   cur.chr.sourcePages={};   cur.chr.sourcePages[lastSourVal]   = val; }
          else if (lv1tag === 'BURI') { if (!cur.buri.sourcePages)  cur.buri.sourcePages={};  cur.buri.sourcePages[lastSourVal]  = val; }
          else if (evIdx >= 0 && cur.events[evIdx]) {
            if (!cur.events[evIdx].sourcePages) cur.events[evIdx].sourcePages = {};
            cur.events[evIdx].sourcePages[lastSourVal] = val;
          }
        }
        // Collect source references at level 3
        if (tag === 'SOUR' && val.startsWith('@')) cur.sourceRefs.add(val);
      }

      else if (lv === 4) {
        // GEO: MAP is at lv3, so LATI/LONG are at lv4
        if (inMap) {
          const coord = parseGeoCoord(val);
          if (mapParent === 'BIRT') { if (tag==='LATI') cur.birth.lati=coord; if (tag==='LONG') cur.birth.long=coord; }
          else if (mapParent === 'DEAT') { if (tag==='LATI') cur.death.lati=coord; if (tag==='LONG') cur.death.long=coord; }
          else if (mapParent === 'CHR')  { if (tag==='LATI') cur.chr.lati=coord;   if (tag==='LONG') cur.chr.long=coord; }
          else if (mapParent === 'BURI') { if (tag==='LATI') cur.buri.lati=coord;  if (tag==='LONG') cur.buri.long=coord; }
          else if (evIdx >= 0 && cur.events[evIdx]) {
            if (tag==='LATI') cur.events[evIdx].lati = coord;
            if (tag==='LONG') cur.events[evIdx].long = coord;
          }
        }
        // Collect source references at level 4
        if (tag === 'SOUR' && val.startsWith('@')) cur.sourceRefs.add(val);
      }

      // CONC/CONT for inline notes at any level
      if (lv1tag === 'NOTE' && lv > 1 && (tag==='CONC'||tag==='CONT'))
        cur.noteText += (tag==='CONT'?'\n':'') + val;
    }

    // â”€â”€ FAMILY â”€â”€
    if (curType === 'FAM') {
      if (lv === 1) {
        if (tag==='HUSB') cur.husb = val;
        else if (tag==='WIFE') cur.wife = val;
        else if (tag==='CHIL') cur.children.push(val);
        else if (tag==='NOTE') { if (!val.startsWith('@')) cur.noteText = val; }
        else if (tag==='SOUR' && val.startsWith('@')) cur.sourceRefs.add(val);
      }
      else if (lv === 2) {
        if (lv1tag==='MARR') {
          if (tag==='DATE') cur.marr.date=val;
          if (tag==='PLAC') cur.marr.place=val;
          if (tag==='SOUR' && val.startsWith('@')) { cur.marr.sources = cur.marr.sources||[]; cur.marr.sources.push(val); cur.sourceRefs.add(val); }
        }
        if (lv1tag==='ENGA') {
          if (tag==='DATE') cur.engag.date = val;
          if (tag==='PLAC') cur.engag.place = val;
        }
        if (lv1tag==='NOTE' && (tag==='CONC'||tag==='CONT')) cur.noteText += (tag==='CONT'?'\n':'') + val;
        if (tag==='SOUR' && val.startsWith('@')) cur.sourceRefs.add(val);
      }
      else if (lv === 3) {
        if (tag==='SOUR' && val.startsWith('@')) cur.sourceRefs.add(val);
      }
      else if (lv === 4 && inMap && mapParent === 'MARR') {
        const coord = parseGeoCoord(val);
        if (tag==='LATI') cur.marr.lati = coord;
        if (tag==='LONG') cur.marr.long = coord;
      }
    }

    // â”€â”€ SOURCE â”€â”€
    if (curType === 'SOUR') {
      if (lv === 1) {
        if (tag==='TITL')      cur.title  = val;
        else if (tag==='ABBR') cur.abbr   = val;
        else if (tag==='AUTH') cur.author = val;
        else if (tag==='DATE') cur.date   = val;
        else if (tag==='PUBL') cur.publ   = val;
        else if (tag==='REPO') cur.repo   = val;
        else if (tag==='TEXT') cur.text   = val;
        else if (tag==='OBJE') cur.media.push({ file:'', title:'' });
      }
      else if (lv === 2) {
        if (lv1tag==='TITL' && (tag==='CONC'||tag==='CONT')) cur.title += (tag==='CONT'?'\n':'') + val;
        if (lv1tag==='OBJE' && cur.media.length) {
          if (tag==='FILE') cur.media[cur.media.length-1].file  = val;
          if (tag==='TITL') cur.media[cur.media.length-1].title = val;
        }
        if (lv1tag==='CHAN' && tag==='DATE') cur.lastChanged = val;
      }
    }

    // â”€â”€ NOTE record â”€â”€
    if (curType === 'NOTE') {
      if (tag==='CONC') cur.text += val;
      else if (tag==='CONT') cur.text += '\n' + val;
    }
  }

  // Resolve NOTE references
  for (const p of Object.values(individuals)) {
    for (const ref of p.noteRefs) {
      if (ref && notes[ref]) p.noteText += (p.noteText ? '\n' : '') + notes[ref].text;
    }
  }

  return { individuals, families, sources, notes };
}



// Parse GEDCOM geo coordinate: N52.15 â†’ 52.15, W3.48 â†’ -3.48
function parseGeoCoord(val) {
  if (!val) return null;
  const m = val.match(/^([NSEW])([\d.]+)$/i);
  if (!m) return parseFloat(val) || null;
  const sign = (m[1].toUpperCase() === 'S' || m[1].toUpperCase() === 'W') ? -1 : 1;
  return sign * parseFloat(m[2]);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GEDCOM WRITER  (v2 â€“ vollstÃ¤ndig)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function writeGEDCOM() {
  const lines = [];
  const d = new Date();
  const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  const dateStr = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;

  lines.push('0 HEAD');
  lines.push('1 SOUR Stammbaum-App');
  lines.push('2 VERS 1.0');
  lines.push('1 GEDC');
  lines.push('2 VERS 5.5.1');
  lines.push('1 CHAR UTF-8');
  lines.push(`1 DATE ${dateStr}`);

  function geoLines(obj, indent) {
    if (obj && obj.lati !== null && obj.long !== null) {
      lines.push(`${indent} MAP`);
      const latStr = (obj.lati >= 0 ? 'N' : 'S') + Math.abs(obj.lati);
      const lonStr = (obj.long >= 0 ? 'E' : 'W') + Math.abs(obj.long);
      lines.push(`${indent+1} LATI ${latStr}`);
      lines.push(`${indent+1} LONG ${lonStr}`);
    }
  }

  function eventBlock(tag, obj, lv) {
    if (!obj || (!obj.date && !obj.place && !obj.cause && !(obj.sources && obj.sources.length))) return;
    lines.push(`${lv} ${tag}`);
    if (obj.date)  lines.push(`${lv+1} DATE ${obj.date}`);
    if (obj.cause) lines.push(`${lv+1} CAUS ${obj.cause}`);
    if (obj.place) {
      lines.push(`${lv+1} PLAC ${obj.place}`);
      geoLines(obj, lv+2);
    }
    if (obj.sources) for (const s of obj.sources) {
      lines.push(`${lv+1} SOUR ${s}`);
      if (obj.sourcePages && obj.sourcePages[s]) lines.push(`${lv+2} PAGE ${obj.sourcePages[s]}`);
    }
  }

  for (const p of Object.values(db.individuals)) {
    lines.push(`0 ${p.id} INDI`);
    // Name with sub-tags
    const nameStr = (p.given || '') + (p.surname ? ' /' + p.surname + '/' : '');
    lines.push(`1 NAME ${nameStr.trim()}`);
    if (p.given)   lines.push(`2 GIVN ${p.given}`);
    if (p.surname) lines.push(`2 SURN ${p.surname}`);
    if (p.prefix)  lines.push(`2 NPFX ${p.prefix}`);
    if (p.suffix)  lines.push(`2 NSFX ${p.suffix}`);
    for (const s of (p.nameSources || [])) lines.push(`2 SOUR ${s}`);
    if (p.titl)    lines.push(`1 TITL ${p.titl}`);
    if (p.reli)    lines.push(`1 RELI ${p.reli}`);
    if (p.sex && p.sex !== 'U') lines.push(`1 SEX ${p.sex}`);
    for (const s of (p.topSources || [])) lines.push(`1 SOUR ${s}`);

    eventBlock('BIRT', p.birth, 1);
    eventBlock('CHR',  p.chr,   1);
    eventBlock('DEAT', p.death, 1);
    eventBlock('BURI', p.buri,  1);

    for (const ev of p.events) {
      lines.push(`1 ${ev.type}${ev.value ? ' ' + ev.value : ''}`);
      if (ev.eventType) lines.push(`2 TYPE ${ev.eventType}`);
      if (ev.date)  lines.push(`2 DATE ${ev.date}`);
      if (ev.place) {
        lines.push(`2 PLAC ${ev.place}`);
        geoLines(ev, 3);
      }
      if (ev.note) {
        const nl = ev.note.split('\n');
        lines.push(`2 NOTE ${nl[0]}`);
        for (let i = 1; i < nl.length; i++) lines.push(`3 CONT ${nl[i]}`);
      }
      if (ev.addr && ev.type === 'RESI') {
        const al = ev.addr.split('\n');
        lines.push(`2 ADDR ${al[0]}`);
        for (let i = 1; i < al.length; i++) lines.push(`3 CONT ${al[i]}`);
      }
      if (ev.sources) for (const s of ev.sources) {
        lines.push(`2 SOUR ${s}`);
        if (ev.sourcePages && ev.sourcePages[s]) lines.push(`3 PAGE ${ev.sourcePages[s]}`);
      }
    }

    if (p.noteText) {
      const noteLines = p.noteText.split('\n');
      lines.push(`1 NOTE ${noteLines[0]}`);
      for (let i = 1; i < noteLines.length; i++) lines.push(`2 CONT ${noteLines[i]}`);
    }

    for (const fref of p.famc) {
      const famId = typeof fref === 'string' ? fref : fref.famId;
      lines.push(`1 FAMC ${famId}`);
      if (typeof fref === 'object' && fref.frel) lines.push(`2 _FREL ${fref.frel}`);
      if (typeof fref === 'object' && fref.mrel) lines.push(`2 _MREL ${fref.mrel}`);
    }
    for (const f of p.fams) lines.push(`1 FAMS ${f}`);
    for (const m of p.media) {
      lines.push(`1 OBJE`);
      if (m.file)  lines.push(`2 FILE ${m.file}`);
      if (m.title) lines.push(`3 TITL ${m.title}`);
    }
    if (p.uid) lines.push(`1 _UID ${p.uid}`);
    if (p.lastChanged) {
      lines.push(`1 CHAN`);
      lines.push(`2 DATE ${p.lastChanged}`);
    }
  }

  for (const f of Object.values(db.families)) {
    lines.push(`0 ${f.id} FAM`);
    if (f.husb) lines.push(`1 HUSB ${f.husb}`);
    if (f.wife) lines.push(`1 WIFE ${f.wife}`);
    for (const c of f.children) lines.push(`1 CHIL ${c}`);
    eventBlock('MARR', f.marr, 1);
    if (f.engag && (f.engag.date || f.engag.place)) {
      lines.push(`1 ENGA`);
      if (f.engag.date)  lines.push(`2 DATE ${f.engag.date}`);
      if (f.engag.place) lines.push(`2 PLAC ${f.engag.place}`);
      if (f.engag.sources) for (const s of f.engag.sources) lines.push(`2 SOUR ${s}`);
    }
    if (f.noteText) {
      const noteLines = f.noteText.split('\n');
      lines.push(`1 NOTE ${noteLines[0]}`);
      for (let i = 1; i < noteLines.length; i++) lines.push(`2 CONT ${noteLines[i]}`);
    }
  }

  for (const s of Object.values(db.sources)) {
    lines.push(`0 ${s.id} SOUR`);
    if (s.abbr)   lines.push(`1 ABBR ${s.abbr}`);
    if (s.title)  lines.push(`1 TITL ${s.title}`);
    if (s.author) lines.push(`1 AUTH ${s.author}`);
    if (s.date)   lines.push(`1 DATE ${s.date}`);
    if (s.publ)   lines.push(`1 PUBL ${s.publ}`);
    if (s.repo)   lines.push(`1 REPO ${s.repo}`);
    if (s.text)   lines.push(`1 TEXT ${s.text}`);
    if (s.lastChanged) {
      lines.push(`1 CHAN`);
      lines.push(`2 DATE ${s.lastChanged}`);
    }
  }

  lines.push('0 TRLR');
  return lines.join('\r\n');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  INDEXEDDB HELPERS (fÃ¼r Dir-Handle)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _idb = null;
function _getIDB() {
  if (_idb) return Promise.resolve(_idb);
  return new Promise((res, rej) => {
    const r = indexedDB.open('stammbaum_app', 1);
    r.onupgradeneeded = e => e.target.result.createObjectStore('kv');
    r.onsuccess = e => { _idb = e.target.result; res(_idb); };
    r.onerror = rej;
  });
}
function idbGet(key) {
  return _getIDB().then(d => new Promise((res, rej) => {
    const r = d.transaction('kv','readonly').objectStore('kv').get(key);
    r.onsuccess = e => res(e.target.result); r.onerror = rej;
  }));
}
function idbPut(key, val) {
  return _getIDB().then(d => new Promise((res, rej) => {
    const r = d.transaction('kv','readwrite').objectStore('kv').put(val, key);
    r.onsuccess = () => res(); r.onerror = rej;
  }));
}
function idbDel(key) {
  return _getIDB().then(d => new Promise((res, rej) => {
    const r = d.transaction('kv','readwrite').objectStore('kv').delete(key);
    r.onsuccess = () => res(); r.onerror = rej;
  }));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FILE SYSTEM ACCESS (Desktop-Speichern)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDirMenuBtn() {
  const btn = document.getElementById('dirMenuBtn');
  if (!btn || !('showDirectoryPicker' in window)) return;
  btn.style.display = '';
  document.getElementById('dirMenuLabel').textContent =
    _dirHandle ? `Speicher-Verzeichnis: ${_dirHandle.name}` : 'Speicher-Verzeichnis wÃ¤hlen';
}

async function restoreDirHandle() {
  if (!('showDirectoryPicker' in window)) return;
  try {
    const h = await idbGet('dirHandle');
    if (!h) return;
    const perm = await h.queryPermission({ mode: 'readwrite' });
    if (perm === 'granted') { _dirHandle = h; updateDirMenuBtn(); }
  } catch(e) {}
}

async function pickSaveDir() {
  if (!('showDirectoryPicker' in window)) return;
  try {
    _dirHandle = await window.showDirectoryPicker({ mode: 'readwrite', startIn: 'documents' });
    await idbPut('dirHandle', _dirHandle);
    updateDirMenuBtn();
    showToast('âœ“ Verzeichnis: ' + _dirHandle.name);
  } catch(e) {
    if (e.name !== 'AbortError') showToast('âš  Kein Verzeichnis gewÃ¤hlt');
  }
}

async function saveToDirectory() {
  const gedText  = writeGEDCOM();
  const filename = localStorage.getItem('stammbaum_filename') || 'stammbaum.ged';
  const basename = filename.replace(/\.ged$/i, '');

  // Verzeichnis holen (einmalig wÃ¤hlen)
  if (!_dirHandle) {
    try {
      _dirHandle = await window.showDirectoryPicker({ mode: 'readwrite', startIn: 'documents' });
      await idbPut('dirHandle', _dirHandle);
      updateDirMenuBtn();
    } catch(e) {
      if (e.name !== 'AbortError') showToast('âš  Kein Verzeichnis gewÃ¤hlt');
      return false;
    }
  }

  // Schreibrecht sicherstellen
  let perm = await _dirHandle.queryPermission({ mode: 'readwrite' });
  if (perm === 'prompt') perm = await _dirHandle.requestPermission({ mode: 'readwrite' });
  if (perm !== 'granted') {
    _dirHandle = null; await idbDel('dirHandle'); updateDirMenuBtn();
    showToast('âš  Kein Schreibzugriff â€“ bitte Verzeichnis neu wÃ¤hlen');
    return false;
  }

  try {
    // 1. Hauptdatei Ã¼berschreiben
    const mainHandle = await _dirHandle.getFileHandle(filename, { create: true });
    const mainWriter = await mainHandle.createWritable();
    await mainWriter.write(gedText);
    await mainWriter.close();

    // 2. backup/-Unterordner anlegen
    const backupDir = await _dirHandle.getDirectoryHandle('backup', { create: true });

    // 3. NÃ¤chste Versionsnummer ermitteln
    const today  = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    const prefix = `${basename}_${today}_`;
    let n = 1;
    for await (const name of backupDir.keys()) {
      if (name.startsWith(prefix) && name.endsWith('.ged')) n++;
    }
    const backupName = `${prefix}${String(n).padStart(3, '0')}.ged`;

    // 4. Versioniertes Backup schreiben
    const backupHandle = await backupDir.getFileHandle(backupName, { create: true });
    const backupWriter = await backupHandle.createWritable();
    await backupWriter.write(gedText);
    await backupWriter.close();

    // 5. State
    try { localStorage.setItem('stammbaum_ged', gedText); } catch(e) {}
    changed = false; updateChangedIndicator();
    showToast(`âœ“ ${filename} Â· Backup: backup/${backupName}`);
    return true;
  } catch(e) {
    showToast('âš  Fehler: ' + e.message);
    return false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  EXPORT / DOWNLOAD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportGEDCOM() {
  // Desktop mit File System Access API â†’ direkt ins Verzeichnis
  if ('showDirectoryPicker' in window) {
    saveToDirectory();
    return;
  }

  // iOS / Fallback
  const content  = writeGEDCOM();
  const filename = localStorage.getItem('stammbaum_filename') || 'stammbaum.ged';
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

  if (isIOS && navigator.canShare) {
    const basename   = filename.replace(/\.ged$/i, '');
    const now        = new Date();
    const today      = now.toISOString().slice(0, 10);
    const time       = now.toTimeString().slice(0, 8).replace(/:/g, '');
    const backupName = `${basename}_${today}_${time}.ged`;
    const mainFile   = new File([content], filename,   { type: 'text/plain' });
    const backupFile = new File([content], backupName, { type: 'text/plain' });
    if (navigator.canShare({ files: [mainFile] })) {
      navigator.share({ files: [mainFile, backupFile], title: filename })
        .then(() => { changed = false; updateChangedIndicator(); showToast('âœ“ Gespeichert'); })
        .catch(err => { if (err.name !== 'AbortError') showToast('âš  Fehler beim Teilen'); });
      return;
    }
  }

  // Download-Fallback
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = filename; a.style.display = 'none';
  document.body.appendChild(a); a.click();
  setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 200);
  changed = false; updateChangedIndicator();
  try { localStorage.setItem('stammbaum_ged', content); } catch(e) {}
  showToast('âœ“ Datei heruntergeladen');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FILE LOADING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('uploadBox').addEventListener('click', () => document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change', e => {
  if (e.target.files[0]) readFile(e.target.files[0]);
});
document.getElementById('uploadBox').addEventListener('dragover', e => {
  e.preventDefault(); e.currentTarget.classList.add('drag');
});
document.getElementById('uploadBox').addEventListener('dragleave', e => e.currentTarget.classList.remove('drag'));
document.getElementById('uploadBox').addEventListener('drop', e => {
  e.preventDefault(); e.currentTarget.classList.remove('drag');
  if (e.dataTransfer.files[0]) readFile(e.dataTransfer.files[0]);
});

document.getElementById('fileInput2').addEventListener('change', e => {
  if (e.target.files[0]) readFile(e.target.files[0]);
});

function confirmNewFile() {
  if (changed) {
    if (!confirm('Sie haben ungespeicherte Ã„nderungen. Trotzdem fortfahren?')) return;
  }
  db = { individuals: {}, families: {}, sources: {}, extraPlaces: loadExtraPlaces() };
  changed = false;
  updateChangedIndicator();
  _originalGedText = null;
  try {
    localStorage.removeItem('stammbaum_ged'); localStorage.removeItem('stammbaum_filename');
    localStorage.removeItem('stammbaum_ged_backup'); localStorage.removeItem('stammbaum_backup_filename'); localStorage.removeItem('stammbaum_backup_date');
  } catch(e) {}
  updateBackupBtn();
  showView('v-landing');
}

function readFile(file) {
  if (file.size > 50 * 1024 * 1024) { showToast('âš  Datei zu groÃŸ (max. 50 MB)'); return; }
  const reader = new FileReader();
  reader.onload = e => {
    try {
      db = parseGEDCOM(e.target.result);
      db.extraPlaces = loadExtraPlaces();
      _originalGedText = e.target.result;
      const backupDate = new Date().toLocaleDateString('de-DE');
      const tryLS = (k, v) => { try { localStorage.setItem(k, v); } catch(e) {} };
      tryLS('stammbaum_ged',             e.target.result);
      tryLS('stammbaum_filename',        file.name);
      tryLS('stammbaum_ged_backup',      e.target.result);
      tryLS('stammbaum_backup_filename', file.name);
      tryLS('stammbaum_backup_date',     backupDate);
      updateBackupBtn();
      showStartView(); showToast('âœ“ ' + file.name + ' geladen');
    } catch(err) { showToast('âš  Fehler beim Laden'); }
  };
  reader.readAsText(file, 'UTF-8');
}

function loadDemo() {
  const demo = `0 HEAD\n1 SOUR Demo\n1 GEDC\n2 VERS 5.5.1\n1 CHAR UTF-8\n0 @I001@ INDI\n1 NAME Johann /MÃ¼ller/\n1 SEX M\n1 BIRT\n2 DATE 12 MAR 1845\n2 PLAC MÃ¼nchen, Bayern\n1 DEAT\n2 DATE 3 NOV 1912\n2 PLAC MÃ¼nchen, Bayern\n1 OCCU BÃ¤ckermeister\n1 FAMS @F001@\n0 @I002@ INDI\n1 NAME Maria /Huber/\n1 SEX F\n1 BIRT\n2 DATE 5 JUN 1850\n2 PLAC Augsburg, Bayern\n1 DEAT\n2 DATE 20 FEB 1930\n2 PLAC MÃ¼nchen, Bayern\n1 FAMS @F001@\n0 @I003@ INDI\n1 NAME Heinrich /MÃ¼ller/\n1 SEX M\n1 BIRT\n2 DATE 8 JAN 1872\n2 PLAC MÃ¼nchen, Bayern\n1 DEAT\n2 DATE 15 APR 1940\n2 PLAC MÃ¼nchen, Bayern\n1 OCCU Kaufmann\n1 FAMC @F001@\n1 FAMS @F002@\n0 @I004@ INDI\n1 NAME Anna /Schmidt/\n1 SEX F\n1 BIRT\n2 DATE 22 SEP 1875\n2 PLAC NÃ¼rnberg, Bayern\n1 FAMS @F002@\n0 @I005@ INDI\n1 NAME Karl /MÃ¼ller/\n1 SEX M\n1 BIRT\n2 DATE 14 JUL 1900\n2 PLAC MÃ¼nchen, Bayern\n1 FAMC @F002@\n0 @I006@ INDI\n1 NAME Elisabeth /MÃ¼ller/\n1 SEX F\n1 BIRT\n2 DATE 3 MAR 1903\n2 PLAC MÃ¼nchen, Bayern\n1 FAMC @F002@\n0 @S001@ SOUR\n1 TITL Kirchenbuch MÃ¼nchen St. Peter\n1 AUTH Stadtarchiv MÃ¼nchen\n1 DATE 1845-1912\n0 @F001@ FAM\n1 HUSB @I001@\n1 WIFE @I002@\n1 CHIL @I003@\n1 MARR\n2 DATE 10 JUN 1870\n2 PLAC MÃ¼nchen, Bayern\n0 @F002@ FAM\n1 HUSB @I003@\n1 WIFE @I004@\n1 CHIL @I005@\n1 CHIL @I006@\n1 MARR\n2 DATE 5 APR 1898\n2 PLAC MÃ¼nchen, Bayern\n0 TRLR`;
  db = parseGEDCOM(demo);
  db.extraPlaces = loadExtraPlaces();
  showStartView(); showToast('âœ“ Demo geladen');
}

// Auto-load last file from localStorage on startup
function tryAutoLoad() {
  try {
    const saved = localStorage.getItem('stammbaum_ged');
    const fname = localStorage.getItem('stammbaum_filename') || 'gespeicherte Datei';
    if (saved && saved.length > 10) {
      db = parseGEDCOM(saved);
      db.extraPlaces = loadExtraPlaces();
      _originalGedText = localStorage.getItem('stammbaum_ged_backup') || saved;
      showStartView();
      updateBackupBtn();
      showToast('âœ“ ' + fname + ' automatisch geladen');
      return true;
    }
  } catch(e) { /* no storage or parse error */ }
  return false;
}
window.addEventListener('load', () => { tryAutoLoad(); restoreDirHandle(); updateDirMenuBtn(); });

function updateBackupBtn() {
  const btn = document.getElementById('backupMenuBtn');
  if (!btn) return;
  const fname = localStorage.getItem('stammbaum_backup_filename') || '';
  const date  = localStorage.getItem('stammbaum_backup_date') || '';
  const hasBackup = !!(_originalGedText || localStorage.getItem('stammbaum_ged_backup'));
  btn.style.opacity = hasBackup ? '1' : '0.4';
  btn.querySelector('span').textContent = hasBackup
    ? `Original-Backup herunterladen${date ? ' (' + date + ')' : ''}`
    : 'Original-Backup (keines vorhanden)';
}

function downloadBackup() {
  const backup = _originalGedText || localStorage.getItem('stammbaum_ged_backup');
  if (!backup) { showToast('âš  Kein Backup vorhanden'); return; }
  const fname = localStorage.getItem('stammbaum_backup_filename') || 'stammbaum.ged';
  const backupName = fname.replace(/\.ged$/i, '') + '_original.ged';
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  if (isIOS && navigator.canShare) {
    const file = new File([backup], backupName, { type: 'text/plain' });
    if (navigator.canShare({ files: [file] })) {
      navigator.share({ files: [file], title: backupName }).catch(() => {});
      return;
    }
  }
  const blob = new Blob([backup], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = backupName; a.style.display = 'none';
  document.body.appendChild(a); a.click();
  setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 200);
  showToast('âœ“ Original-Backup heruntergeladen');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  NAVIGATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
  // Bottom-Nav: sichtbar in v-main und v-tree, ausgeblendet in v-landing und v-detail
  const showNav = (id === 'v-main' || id === 'v-tree');
  document.getElementById('bottomNav').style.display = showNav ? 'flex' : 'none';
  // FAB: sichtbar in v-main (alle Tabs inkl. Orte)
  document.getElementById('fabBtn').style.display = (id === 'v-main') ? '' : 'none';
}

// Bottom-Nav: aktiven Button hervorheben
function setBnavActive(name) {
  document.querySelectorAll('.bnav-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('bnav-' + name);
  if (btn) btn.classList.add('active');
}

// Bottom-Nav: Baum-Tab
function bnavTree() {
  setBnavActive('tree');
  const id = currentTreeId || smallestPersonId();
  if (id) showTree(id);
  else { showView('v-main'); setBnavActive('persons'); }
}

// Bottom-Nav: Listen-Tabs
function bnavTab(name) {
  currentTab = name;
  setBnavActive(name);
  showView('v-main');
  switchTab(name);
}

function showMain() {
  _navHistory.length = 0; // Liste = frischer Start, History lÃ¶schen
  setBnavActive(currentTab || 'persons');
  showView('v-main');
  updateStats();
  renderTab();
}

// â”€â”€â”€ History-Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Muss am Anfang jeder showDetail/showFamilyDetail/showSourceDetail/
// showPlaceDetail stehen.
function _beforeDetailNavigate() {
  if (_skipHistoryPush) return; // RÃ¼ckwÃ¤rts-Navigation, nichts pushen
  if (document.getElementById('v-detail').classList.contains('active')) {
    // Detail â†’ Detail: aktuellen Zustand in History sichern
    if      (currentPersonId) _navHistory.push({ type: 'person', id: currentPersonId });
    else if (currentFamilyId) _navHistory.push({ type: 'family', id: currentFamilyId });
    else if (currentSourceId) _navHistory.push({ type: 'source', id: currentSourceId });
    // Place: Name liegt nicht in einer ID-Variable â€“ Ã¼ber detailTopTitle rekonstruieren
    else {
      const title = document.getElementById('detailTopTitle')?.textContent;
      if (title && title !== 'ğŸ“ Ort') _navHistory.push({ type: 'place', name: title });
    }
  } else {
    _navHistory.length = 0;
    // Baum â†’ Detail: Tree-Eintrag pushen damit ZurÃ¼ck zum Baum fÃ¼hrt
    if (document.getElementById('v-tree').classList.contains('active') && currentTreeId) {
      _navHistory.push({ type: 'tree', id: currentTreeId });
    }
  }
}

// "â† ZurÃ¼ck" â€“ geht zur vorherigen Detail-Ansicht, zum Baum oder zur Liste
function goBack() {
  const prev = _navHistory.pop();
  if (!prev) { showMain(); return; }
  _skipHistoryPush = true;
  if      (prev.type === 'person') showDetail(prev.id);
  else if (prev.type === 'family') showFamilyDetail(prev.id);
  else if (prev.type === 'source') showSourceDetail(prev.id);
  else if (prev.type === 'place')  showPlaceDetail(prev.name);
  else if (prev.type === 'tree')   showTree(prev.id);
  else showMain();
  _skipHistoryPush = false;
}

// Kleinste numerische Personen-ID
function smallestPersonId() {
  const ids = Object.keys(db.individuals || {});
  if (!ids.length) return null;
  return ids.sort((a, b) => {
    const na = parseInt(a.replace(/\D/g, '')) || 0;
    const nb = parseInt(b.replace(/\D/g, '')) || 0;
    return na - nb;
  })[0];
}

// Startansicht nach Datei-Load: Tree der Person mit kleinster ID
function showStartView() {
  currentTab = 'persons';
  showMain();
  const startId = smallestPersonId();
  if (startId) showTree(startId);
}

function switchTab(tab) {
  currentTab = tab;
  document.getElementById('tab-persons').style.display = tab === 'persons' ? 'block' : 'none';
  document.getElementById('tab-families').style.display = tab === 'families' ? 'block' : 'none';
  document.getElementById('tab-sources').style.display = tab === 'sources' ? 'block' : 'none';
  document.getElementById('tab-places').style.display = tab === 'places' ? 'block' : 'none';
  document.getElementById('fabBtn').style.display = '';
  renderTab();
}

function renderTab() {
  if (currentTab === 'persons') renderPersonList(Object.values(db.individuals));
  else if (currentTab === 'families') renderFamilyList();
  else if (currentTab === 'sources') renderSourceList();
  else if (currentTab === 'places') renderPlaceList();
}

function updateStats() {
  // Stats-Leiste entfernt â€“ Funktion bleibt als No-op erhalten
}

function updateChangedIndicator() {
  document.getElementById('changedIndicator').style.display = changed ? 'inline-block' : 'none';
}

function markChanged() { changed = true; _placesCache = null; updateChangedIndicator(); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PERSON LIST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPersonList(persons) {
  const sorted = [...persons].sort((a, b) =>
    (a.surname || a.given || a.name || '').localeCompare(b.surname || b.given || b.name || '', 'de')
  );
  const list = document.getElementById('personList');
  if (!sorted.length) { list.innerHTML = '<div class="empty">Noch keine Personen</div>'; return; }

  let html = '', lastLetter = '';
  for (const p of sorted) {
    const fl = (p.surname || p.given || p.name || '?')[0].toUpperCase();
    if (fl !== lastLetter) { html += `<div class="alpha-sep">${fl}</div>`; lastLetter = fl; }
    const sc = p.sex === 'M' ? 'm' : p.sex === 'F' ? 'f' : '';
    const ic = p.sex === 'M' ? 'â™‚' : p.sex === 'F' ? 'â™€' : 'â—‡';
    let meta = '';
    if (p.birth.date) meta += '* ' + p.birth.date;
    if (p.birth.place) meta += (meta ? ', ' : '') + p.birth.place;
    if (p.death.date) meta += (meta ? '  â€  ' : 'â€  ') + p.death.date;
    html += `<div class="person-row" onclick="showDetail('${p.id}')">
      <div class="p-avatar ${sc}">${ic}</div>
      <div class="p-info">
        <div class="p-name">${esc(p.name || p.id)}</div>
        <div class="p-meta">${esc(meta) || '&nbsp;'}</div>
      </div>
      <span class="p-arrow">â€º</span>
    </div>`;
  }
  list.innerHTML = html;
}

function filterPersons(q) {
  const lower = q.toLowerCase().trim();
  const all = Object.values(db.individuals);
  if (!lower) { renderPersonList(all); return; }

  renderPersonList(all.filter(p => {
    // Name
    if ((p.name||'').toLowerCase().includes(lower)) return true;
    if ((p.surname||'').toLowerCase().includes(lower)) return true;
    if ((p.given||'').toLowerCase().includes(lower)) return true;
    if ((p.prefix||'').toLowerCase().includes(lower)) return true;
    if ((p.titl||'').toLowerCase().includes(lower)) return true;
    // Birth / death / burial / chr
    if ((p.birth.date||'').toLowerCase().includes(lower)) return true;
    if ((p.birth.place||'').toLowerCase().includes(lower)) return true;
    if ((p.death.date||'').toLowerCase().includes(lower)) return true;
    if ((p.death.place||'').toLowerCase().includes(lower)) return true;
    if ((p.chr.place||'').toLowerCase().includes(lower)) return true;
    if ((p.buri.place||'').toLowerCase().includes(lower)) return true;
    // Events: value, place, date, eventType
    for (const ev of p.events) {
      if ((ev.value||'').toLowerCase().includes(lower)) return true;
      if ((ev.place||'').toLowerCase().includes(lower)) return true;
      if ((ev.date||'').toLowerCase().includes(lower)) return true;
      if ((ev.eventType||'').toLowerCase().includes(lower)) return true;
    }
    // Notes
    if ((p.noteText||'').toLowerCase().includes(lower)) return true;
    // Religion
    if ((p.reli||'').toLowerCase().includes(lower)) return true;
    return false;
  }));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FAMILY LIST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFamilyList(fams) {
  const el = document.getElementById('familyList');
  if (!fams) fams = Object.values(db.families);
  if (!fams.length) { el.innerHTML = '<div class="empty">Keine Familien gefunden</div>'; return; }

  let html = '';
  for (const f of fams) {
    const husb = f.husb ? db.individuals[f.husb] : null;
    const wife = f.wife ? db.individuals[f.wife] : null;
    const title = [husb?.name, wife?.name].filter(Boolean).join(' & ') || f.id;
    let meta = '';
    if (f.marr.date) meta += 'âš­ ' + f.marr.date;
    if (f.marr.place) meta += (meta ? ', ' : 'âš­ ') + f.marr.place;
    if (f.children.length) meta += (meta ? '  ' : '') + f.children.length + ' Kind' + (f.children.length > 1 ? 'er' : '');
    html += `<div class="person-row" data-fid="${f.id}" onclick="showFamilyDetail(this.dataset.fid)">
      <div class="p-avatar">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
      <div class="p-info">
        <div class="p-name">${esc(title)}</div>
        <div class="p-meta">${esc(meta) || '&nbsp;'}</div>
      </div>
      <span class="p-arrow">â€º</span>
    </div>`;
  }
  el.innerHTML = html;
}

function filterFamilies(q) {
  const lower = q.toLowerCase().trim();
  const all = Object.values(db.families);
  if (!lower) { renderFamilyList(all); return; }
  renderFamilyList(all.filter(f => {
    const husb = f.husb ? db.individuals[f.husb] : null;
    const wife = f.wife ? db.individuals[f.wife] : null;
    if (husb && (husb.name||'').toLowerCase().includes(lower)) return true;
    if (wife && (wife.name||'').toLowerCase().includes(lower)) return true;
    if ((f.marr.date||'').toLowerCase().includes(lower)) return true;
    if ((f.marr.place||'').toLowerCase().includes(lower)) return true;
    return false;
  }));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SOURCE LIST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSourceList(srcs) {
  const el = document.getElementById('sourceList');
  if (!srcs) srcs = Object.values(db.sources);
  if (!srcs.length) { el.innerHTML = '<div class="empty">Keine Quellen gefunden</div>'; return; }

  let html = '';
  for (const s of srcs) {
    const refCount = Object.values(db.individuals).filter(p => p.sourceRefs && p.sourceRefs.has(s.id)).length
                   + Object.values(db.families).filter(f => f.sourceRefs && f.sourceRefs.has(s.id)).length;
    html += `<div class="source-card" data-sid="${s.id}" onclick="showSourceDetail(this.dataset.sid)">
      <div class="source-title">${esc(s.abbr || s.title || s.id)}</div>
      <div class="source-meta">${esc([s.author, s.date].filter(Boolean).join(' Â· ')) || '&nbsp;'}${refCount ? ` Â· ${refCount} Ref.` : ''}</div>
    </div>`;
  }
  el.innerHTML = html;
}

function filterSources(q) {
  const lower = q.toLowerCase().trim();
  const all = Object.values(db.sources);
  if (!lower) { renderSourceList(all); return; }
  renderSourceList(all.filter(s =>
    (s.title||'').toLowerCase().includes(lower) ||
    (s.abbr||'').toLowerCase().includes(lower)  ||
    (s.author||'').toLowerCase().includes(lower)
  ));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PLACE LIST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function collectPlaces() {
  if (_placesCache) return _placesCache;
  const places = new Map();

  function addPlace(placeName, personId, eventType, lati, long) {
    if (!placeName || !placeName.trim()) return;
    const key = placeName.trim();
    if (!places.has(key)) places.set(key, { name: key, personIds: new Set(), eventTypes: new Set(), lati: null, long: null });
    const pl = places.get(key);
    if (personId) pl.personIds.add(personId);
    if (eventType) pl.eventTypes.add(eventType);
    // Store first found geo coords
    if (pl.lati === null && lati !== null && lati !== undefined) { pl.lati = lati; pl.long = long; }
  }

  for (const p of Object.values(db.individuals)) {
    addPlace(p.birth.place, p.id, 'Geburt', p.birth.lati, p.birth.long);
    addPlace(p.death.place, p.id, 'Tod', p.death.lati, p.death.long);
    addPlace(p.chr.place,   p.id, 'Taufe', null, null);
    addPlace(p.buri.place,  p.id, 'Beerdigung', p.buri.lati, p.buri.long);
    for (const ev of p.events) addPlace(ev.place, p.id, ev.eventType || ev.type, ev.lati, ev.long);
  }
  for (const f of Object.values(db.families)) {
    addPlace(f.marr.place, f.husb, 'Heirat', f.marr.lati, f.marr.long);
    addPlace(f.marr.place, f.wife, 'Heirat', f.marr.lati, f.marr.long);
  }
  // Manuell hinzugefÃ¼gte Orte (extraPlaces) einmischen â€” nur wenn noch nicht vorhanden
  for (const ep of Object.values(db.extraPlaces)) {
    if (!places.has(ep.name))
      places.set(ep.name, { name: ep.name, personIds: new Set(), eventTypes: new Set(), lati: ep.lati ?? null, long: ep.long ?? null });
  }
  _placesCache = places;
  return places;
}

function renderPlaceList(sorted) {
  const el = document.getElementById('placeList');
  if (!sorted) {
    const places = collectPlaces();
    if (!places.size) { el.innerHTML = '<div class="empty">Keine Orte in den Daten gefunden</div>'; return; }
    sorted = [...places.values()].sort((a, b) => a.name.localeCompare(b.name, 'de'));
  }
  if (!sorted.length) { el.innerHTML = '<div class="empty">Keine Orte gefunden</div>'; return; }

  let html = '';
  let lastLetter = '';
  for (const place of sorted) {
    const fl = place.name[0].toUpperCase();
    if (fl !== lastLetter) { html += `<div class="alpha-sep">${fl}</div>`; lastLetter = fl; }
    const count = place.personIds.size;
    const hasGeo = place.lati !== null;
    const geoIcon = hasGeo ? 'ğŸ“' : 'Â·';
    html += `<div class="person-row" onclick="showPlaceDetail('${esc(place.name)}')">
      <div class="p-avatar" style="font-size:1.1rem">${geoIcon}</div>
      <div class="p-info">
        <div class="p-name">${esc(place.name)}</div>
        <div class="p-meta">${count} Person${count !== 1 ? 'en' : ''}${hasGeo ? ' Â· Karte verfÃ¼gbar' : ''}</div>
      </div>
      <span class="p-arrow">â€º</span>
    </div>`;
  }
  el.innerHTML = html;
}

function filterPlaces(q) {
  const lower = q.toLowerCase().trim();
  const all = [...collectPlaces().values()].sort((a, b) => a.name.localeCompare(b.name, 'de'));
  if (!lower) { renderPlaceList(all); return; }
  renderPlaceList(all.filter(pl => pl.name.toLowerCase().includes(lower)));
}

function showPlaceForm(placeName) {
  document.getElementById('pl-old').value  = placeName;
  document.getElementById('pl-name').value = placeName;
  openModal('modalPlace');
}

function savePlace() {
  const oldName = document.getElementById('pl-old').value;
  const newName = document.getElementById('pl-name').value.trim();
  if (!newName) { showToast('âš  Ortsname darf nicht leer sein'); return; }
  closeModal('modalPlace');
  if (newName === oldName) return;
  for (const p of Object.values(db.individuals)) {
    if (p.birth.place  === oldName) p.birth.place  = newName;
    if (p.chr.place    === oldName) p.chr.place    = newName;
    if (p.death.place  === oldName) p.death.place  = newName;
    if (p.buri.place   === oldName) p.buri.place   = newName;
    for (const ev of p.events) if (ev.place === oldName) ev.place = newName;
  }
  for (const f of Object.values(db.families)) {
    if (f.marr.place        === oldName) f.marr.place        = newName;
    if (f.engag?.place      === oldName) f.engag.place       = newName;
  }
  // extraPlaces mitumbenennen
  if (db.extraPlaces[oldName]) {
    db.extraPlaces[newName] = { ...db.extraPlaces[oldName], name: newName };
    delete db.extraPlaces[oldName];
    saveExtraPlaces();
  }
  markChanged();
  showToast('âœ“ Ort umbenannt');
  showPlaceDetail(newName);
}

function showNewPlaceForm() {
  document.getElementById('np-name').value = '';
  document.getElementById('np-lati').value = '';
  document.getElementById('np-long').value = '';
  openModal('modalNewPlace');
}

function saveNewPlace() {
  const name = document.getElementById('np-name').value.trim();
  if (!name) { showToast('âš  Ortsname erforderlich'); return; }
  if (collectPlaces().has(name)) { showToast('âš  Ort bereits vorhanden'); return; }
  const lati = parseFloat(document.getElementById('np-lati').value) || null;
  const long = parseFloat(document.getElementById('np-long').value) || null;
  db.extraPlaces[name] = { name, lati, long };
  saveExtraPlaces();
  _placesCache = null;
  closeModal('modalNewPlace');
  showToast('âœ“ Ort hinzugefÃ¼gt');
  renderTab();
}

function deleteExtraPlace(name) {
  if (!confirm('Ort wirklich entfernen?')) return;
  delete db.extraPlaces[name];
  saveExtraPlaces();
  _placesCache = null;
  goBack();
  showToast('âœ“ Ort entfernt');
  renderTab();
}

function showPlaceDetail(placeName) {
  const places = collectPlaces();
  const place = places.get(placeName);
  if (!place) return;
  _beforeDetailNavigate();
  currentPersonId = null; currentFamilyId = null; currentSourceId = null;
  document.getElementById('detailTopTitle').textContent = 'ğŸ“ Ort';
  document.getElementById('editBtn').style.display = '';
  document.getElementById('editBtn').onclick = () => showPlaceForm(placeName);
  document.getElementById('treeBtn').style.display = 'none';

  let html = `<div class="detail-hero fade-up">
    <div class="detail-avatar" style="font-size:1.8rem; border-color:var(--gold-dim)">ğŸ“</div>
    <div class="detail-name">${esc(placeName)}</div>
    <div class="detail-id">${place.personIds.size} Person${place.personIds.size !== 1 ? 'en' : ''}</div>
  </div>`;

  // LÃ¶sch-Button fÃ¼r manuell hinzugefÃ¼gte Orte ohne verknÃ¼pfte Personen
  if (place.personIds.size === 0 && db.extraPlaces[placeName]) {
    html += `<div style="padding:4px 0 12px">
      <button class="btn btn-danger" style="width:100%"
        data-pname="${placeName.replace(/"/g,'&quot;')}"
        onclick="deleteExtraPlace(this.dataset.pname)">Ort entfernen</button>
    </div>`;
  }

  // Map link if geo available
  if (place.lati !== null) {
    html += `<div class="section fade-up">
      <div class="section-title">Standort</div>
      <a href="https://maps.apple.com/?ll=${place.lati},${place.long}&q=${encodeURIComponent(placeName)}"
         target="_blank"
         style="display:flex;align-items:center;gap:10px;padding:10px 0;color:var(--gold);text-decoration:none;font-size:0.9rem">
        ğŸ—º In Apple Maps Ã¶ffnen
        <span style="font-size:0.75rem;color:var(--text-muted)">${place.lati.toFixed(4)}, ${place.long.toFixed(4)}</span>
      </a>
    </div>`;
  }

  // Build detailed list: person + which event connects them to this place
  const entries = [];
  for (const p of Object.values(db.individuals)) {
    if (p.birth.place && p.birth.place.trim() === placeName)
      entries.push({ person: p, role: 'Geburt' + (p.birth.date ? ' Â· ' + p.birth.date : '') });
    if (p.death.place && p.death.place.trim() === placeName)
      entries.push({ person: p, role: 'Tod' + (p.death.date ? ' Â· ' + p.death.date : '') });
    if (p.chr.place && p.chr.place.trim() === placeName)
      entries.push({ person: p, role: 'Taufe' + (p.chr.date ? ' Â· ' + p.chr.date : '') });
    if (p.buri.place && p.buri.place.trim() === placeName)
      entries.push({ person: p, role: 'Beerdigung' + (p.buri.date ? ' Â· ' + p.buri.date : '') });
    for (const ev of p.events) {
      if (ev.place && ev.place.trim() === placeName)
        entries.push({ person: p, role: (ev.eventType || EVENT_LABELS[ev.type] || ev.type) + (ev.date ? ' Â· ' + ev.date : '') });
    }
  }
  for (const f of Object.values(db.families)) {
    if (f.marr.place && f.marr.place.trim() === placeName) {
      for (const pid of [f.husb, f.wife]) {
        if (!pid) continue;
        const p = db.individuals[pid];
        if (p) entries.push({ person: p, role: 'Heirat' + (f.marr.date ? ' Â· ' + f.marr.date : '') });
      }
    }
  }

  entries.sort((a, b) => (a.person.name || '').localeCompare(b.person.name || '', 'de'));

  html += `<div class="section fade-up">
    <div class="section-title">Personen an diesem Ort</div>`;
  for (const e of entries) {
    html += relRow(e.person, e.role);
  }
  html += `</div>`;

  document.getElementById('detailContent').innerHTML = html;
  showView('v-detail');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STAMMBAUM-ANSICHT (SANDUHR)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getParentIds(pid) {
  const p = db.individuals[pid];
  if (!p?.famc?.length) return { father: null, mother: null };
  const ref   = p.famc[0];
  const famId = typeof ref === 'string' ? ref : ref.famId;
  const fam   = db.families[famId];
  return { father: fam?.husb || null, mother: fam?.wife || null };
}

function getChildIds(pid) {
  const p = db.individuals[pid];
  if (!p) return [];
  return (p.fams || []).flatMap(famId => db.families[famId]?.children || []);
}

let currentTreeId = null;

function showTree(personId) {
  const p = db.individuals[personId];
  if (!p) return;
  currentPersonId = personId;
  currentTreeId   = personId;
  setBnavActive('tree');

  const CW = 120, CH = 80;      // Zentrum-Karte
  const W  = 96,  H  = 64;      // regulÃ¤re Karte
  const HGAP = 10, VGAP = 44;
  const MGAP = 20;               // LÃ¼cke Person â†” Ehepartner
  const SLOT = W + HGAP;
  const PAD  = 20;
  const ROW  = H + VGAP;

  // â”€â”€ Vorfahren (2 Ebenen) â”€â”€
  const par0  = getParentIds(personId);
  const anc1  = [par0.father, par0.mother];
  const par_f = par0.father ? getParentIds(par0.father) : { father: null, mother: null };
  const par_m = par0.mother ? getParentIds(par0.mother) : { father: null, mother: null };
  const anc2  = [par_f.father, par_f.mother, par_m.father, par_m.mother];

  // â”€â”€ Erster Ehepartner aus fams (mit Familien-ID) â”€â”€
  let spouseFamId = null;
  const spouseId = (() => {
    for (const famId of (p.fams || [])) {
      const fam = db.families[famId];
      if (!fam) continue;
      if (fam.husb && fam.husb !== personId) { spouseFamId = famId; return fam.husb; }
      if (fam.wife && fam.wife !== personId) { spouseFamId = famId; return fam.wife; }
    }
    return null;
  })();

  // â”€â”€ Kinder: Hauptfamilie vs. Halbgeschwister â”€â”€
  // Hauptfamilie = Familie mit dargestelltem Ehepartner;
  // fehlt ein Partner, gilt die erste fams-Einheit als Hauptfamilie.
  if (!spouseFamId && p.fams && p.fams.length > 0) spouseFamId = p.fams[0];
  const mainChildren = spouseFamId ? (db.families[spouseFamId]?.children || []) : [];
  const halfChildren = (p.fams || [])
    .filter(fid => fid !== spouseFamId)
    .flatMap(fid => db.families[fid]?.children || []);
  const children = [...mainChildren, ...halfChildren];
  const halfSiblingSet = new Set(halfChildren);

  const MAX_CHILD_COLS = 4;
  const childRows = [];
  for (let i = 0; i < children.length; i += MAX_CHILD_COLS) {
    childRows.push(children.slice(i, i + MAX_CHILD_COLS));
  }

  // â”€â”€ Layout-Breite â”€â”€
  // familyCX liegt bei cx + familyOffset (= Mitte zwischen Person und Ehepartner).
  // Kinder sind um familyCX zentriert â†’ Canvas muss diesen Rechts-Offset kompensieren.
  const familyOffset = spouseId ? (CW / 2 + MGAP + W / 2) / 2 : 0;  // 64px bei Ehepartner
  const ancW    = 4 * SLOT;
  const coupleW = spouseId ? CW + MGAP + W : CW;
  const childMaxCols = childRows.length > 0 ? Math.max(...childRows.map(r => r.length)) : 0;
  const childW  = childMaxCols > 0 ? childMaxCols * SLOT + 2 * familyOffset : 0;
  const totalW  = Math.max(ancW, childW, coupleW) + PAD * 2;
  const cx      = totalW / 2;   // Layout-Zentrum (= Mitte Personen-Karte)

  // â”€â”€ Y-Positionen â”€â”€
  const baseY = PAD + 2 * ROW;
  function ry(lv) {
    if (lv <= 0) return baseY + lv * ROW;
    return baseY + CH + VGAP + (lv - 1) * ROW;
  }
  const totalH = ry(1) + Math.max(childRows.length, 1) * ROW - VGAP + PAD;

  // â”€â”€ X-Positionen Vorfahren (4 GP-Slots, zentriert bei cx) â”€â”€
  function gpCX(i)  { return cx - 2 * SLOT + (i + 0.5) * SLOT; }
  function gpX(i)   { return gpCX(i) - W / 2; }
  function parCX(i) { return (gpCX(i * 2) + gpCX(i * 2 + 1)) / 2; }
  function parX(i)  { return parCX(i) - W / 2; }

  // â”€â”€ Person immer bei cx, Ehepartner rechts â”€â”€
  const personCX = cx;
  const personX  = cx - CW / 2;
  const spouseX  = cx + CW / 2 + MGAP;
  const spouseCX = spouseX + W / 2;

  // Kind-Zeilen zentriert zwischen Person und Ehepartner
  const familyCX = spouseId ? (personCX + spouseCX) / 2 : personCX;
  function childRowCX(row, i) {
    return familyCX - (row.length * SLOT) / 2 + (i + 0.5) * SLOT;
  }
  function childRowX(row, i) { return childRowCX(row, i) - W / 2; }

  // â”€â”€ DOM aufbauen â”€â”€
  document.getElementById('treeTopTitle').textContent = p.name || personId;

  const wrap = document.getElementById('treeWrap');
  wrap.style.width  = totalW + 'px';
  wrap.style.height = totalH + 'px';
  wrap.querySelectorAll('.tree-card').forEach(el => el.remove());

  const svg = document.getElementById('treeSvg');
  svg.setAttribute('width',   totalW);
  svg.setAttribute('height',  totalH);
  svg.setAttribute('viewBox', `0 0 ${totalW} ${totalH}`);
  svg.innerHTML = '';

  function line(x1, y1, x2, y2) {
    const mid = (y1 + y2) / 2;
    const el  = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    el.setAttribute('d', `M${x1},${y1} C${x1},${mid} ${x2},${mid} ${x2},${y2}`);
    el.setAttribute('stroke', 'var(--border)');
    el.setAttribute('stroke-width', '1.5');
    el.setAttribute('fill', 'none');
    svg.appendChild(el);
  }

  function lineHalf(x1, y1, x2, y2) {
    const mid = (y1 + y2) / 2;
    const el  = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    el.setAttribute('d', `M${x1},${y1} C${x1},${mid} ${x2},${mid} ${x2},${y2}`);
    el.setAttribute('stroke', 'var(--gold-dim)');
    el.setAttribute('stroke-width', '1.5');
    el.setAttribute('stroke-dasharray', '4 3');
    el.setAttribute('fill', 'none');
    svg.appendChild(el);
  }

  function mkCard(id, x, y, isCenter, isHalf = false) {
    const div = document.createElement('div');
    div.className = 'tree-card' +
      (isCenter ? ' tree-card-center' : '') +
      (isHalf   ? ' tree-card-half'   : '');
    div.style.left = Math.round(x) + 'px';
    div.style.top  = Math.round(y) + 'px';
    if (!id) {
      div.classList.add('tree-card-empty');
      div.innerHTML = '<span style="color:var(--text-muted);font-size:0.8rem">?</span>';
      wrap.appendChild(div);
      return;
    }
    const q    = db.individuals[id];
    if (!q) return;
    const icon = q.sex === 'M' ? 'â™‚' : q.sex === 'F' ? 'â™€' : 'â—‡';
    const nm   = q.name || id;
    const by   = (q.birth?.date || '').replace(/.*(\d{4}).*/, '$1');
    const dy   = (q.death?.date || '').replace(/.*(\d{4}).*/, '$1');
    const yr   = [by ? '*' + by : '', dy ? 'â€ ' + dy : ''].filter(Boolean).join(' ');
    div.innerHTML =
      `<div class="tree-sex">${icon}</div>` +
      `<div class="tree-name">${esc(nm)}</div>` +
      (yr ? `<div class="tree-yr">${yr}</div>` : '') +
      (isHalf ? `<div class="tree-half-badge">Â½</div>` : '');
    div.onclick = isCenter ? () => showDetail(id) : () => showTree(id);
    wrap.appendChild(div);
  }

  // â”€â”€ GroÃŸeltern + Linien zu Eltern â”€â”€
  anc2.forEach((id, i) => {
    mkCard(id, gpX(i), ry(-2), false);
    line(gpCX(i), ry(-2) + H, parCX(Math.floor(i / 2)), ry(-1));
  });

  // â”€â”€ Eltern + Linien zu Person â”€â”€
  anc1.forEach((id, i) => {
    mkCard(id, parX(i), ry(-1), false);
    line(parCX(i), ry(-1) + H, personCX + (i === 0 ? -CW * 0.18 : CW * 0.18), ry(0));
  });

  // â”€â”€ Zentrum â”€â”€
  mkCard(personId, personX, ry(0), true);

  // â”€â”€ Ehepartner + gestrichelte Verbindungslinie â”€â”€
  if (spouseId) {
    mkCard(spouseId, spouseX, ry(0) + (CH - H) / 2, false);
    const el = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    el.setAttribute('x1', personX + CW);
    el.setAttribute('y1', ry(0) + CH / 2);
    el.setAttribute('x2', spouseX);
    el.setAttribute('y2', ry(0) + CH / 2);
    el.setAttribute('stroke', 'var(--gold)');
    el.setAttribute('stroke-width', '1.5');
    el.setAttribute('stroke-dasharray', '5 3');
    svg.appendChild(el);
  }

  // â”€â”€ Kinder + Linien (mehrere Zeilen mÃ¶glich) â”€â”€
  childRows.forEach((row, rowIdx) => {
    const rowY = ry(1) + rowIdx * ROW;
    row.forEach((id, i) => {
      const cxI   = childRowCX(row, i);
      const isHalf = halfSiblingSet.has(id);
      mkCard(id, childRowX(row, i), rowY, false, isHalf);
      if (isHalf) lineHalf(familyCX, ry(0) + CH, cxI, rowY);
      else        line(familyCX, ry(0) + CH, cxI, rowY);
    });
  });

  showView('v-tree');
  setTimeout(() => {
    const sc = document.getElementById('treeScroll');
    sc.scrollLeft = Math.max(0, cx - sc.clientWidth / 2);
    sc.scrollTop  = Math.max(0, ry(-2) - PAD);
  }, 60);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DETAIL: PERSON
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDetail(id) {
  const p = db.individuals[id];
  if (!p) return;
  _beforeDetailNavigate();
  currentPersonId = id;
  currentFamilyId = null;
  currentSourceId = null;

  document.getElementById('detailTopTitle').textContent = p.name || id;
  document.getElementById('editBtn').style.display = '';
  document.getElementById('editBtn').onclick = () => showPersonForm(id);
  document.getElementById('treeBtn').style.display = '';
  document.getElementById('treeBtn').onclick = () => showTree(id);

  const sc = p.sex === 'M' ? 'm' : p.sex === 'F' ? 'f' : '';
  const ic = p.sex === 'M' ? 'â™‚' : p.sex === 'F' ? 'â™€' : 'â—‡';

  const fullName = [p.prefix, p.name].filter(Boolean).join(' ');

  let html = `<div class="detail-hero fade-up">
    <div class="detail-avatar ${sc}">${ic}</div>
    <div class="detail-name">${esc(fullName || id)}</div>
    <div class="detail-id">${id}${p.lastChanged ? ' Â· geÃ¤ndert ' + p.lastChanged : ''}</div>
  </div>`;

  // Life data
  html += `<div class="section fade-up">
    <div class="section-head">
      <div class="section-title">Lebensdaten</div>
      <button class="section-add" data-pid="${id}" onclick="showEventForm(this.dataset.pid)">+ Ereignis</button>
    </div>`;

  if (p.birth.date || p.birth.place) {
    const geoBtn = (p.birth.lati !== null && p.birth.lati !== undefined)
      ? `<a href="https://maps.apple.com/?ll=${p.birth.lati},${p.birth.long}" target="_blank" style="color:var(--gold-dim);font-size:0.75rem;text-decoration:none;margin-left:5px">ğŸ“</a>` : '';
    html += `<div class="fact-row" data-pid="${id}" data-ev="BIRT" onclick="showEventForm(this.dataset.pid,this.dataset.ev)" style="cursor:pointer"><span class="fact-lbl">Geburt</span><span class="fact-val">${esc([p.birth.date, p.birth.place].filter(Boolean).join(', '))}${geoBtn}${sourceTagsHtml(p.birth.sources)}</span></div>`;
  }
  if (p.chr.date || p.chr.place) {
    html += `<div class="fact-row" data-pid="${id}" data-ev="CHR" onclick="showEventForm(this.dataset.pid,this.dataset.ev)" style="cursor:pointer"><span class="fact-lbl">Taufe</span><span class="fact-val">${esc([p.chr.date, p.chr.place].filter(Boolean).join(', '))}${sourceTagsHtml(p.chr.sources)}</span></div>`;
  }
  if (p.death.date || p.death.place) {
    const geoBtn = (p.death.lati !== null && p.death.lati !== undefined)
      ? `<a href="https://maps.apple.com/?ll=${p.death.lati},${p.death.long}" target="_blank" style="color:var(--gold-dim);font-size:0.75rem;text-decoration:none;margin-left:5px">ğŸ“</a>` : '';
    html += `<div class="fact-row" data-pid="${id}" data-ev="DEAT" onclick="showEventForm(this.dataset.pid,this.dataset.ev)" style="cursor:pointer"><span class="fact-lbl">Tod</span><span class="fact-val">${esc([p.death.date, p.death.place, p.death.cause].filter(Boolean).join(', '))}${geoBtn}${sourceTagsHtml(p.death.sources)}</span></div>`;
  }
  if (p.buri.date || p.buri.place) {
    const geoBtn = (p.buri.lati !== null && p.buri.lati !== undefined)
      ? `<a href="https://maps.apple.com/?ll=${p.buri.lati},${p.buri.long}" target="_blank" style="color:var(--gold-dim);font-size:0.75rem;text-decoration:none;margin-left:5px">ğŸ“</a>` : '';
    html += `<div class="fact-row" data-pid="${id}" data-ev="BURI" onclick="showEventForm(this.dataset.pid,this.dataset.ev)" style="cursor:pointer"><span class="fact-lbl">Beerdigung</span><span class="fact-val">${esc([p.buri.date, p.buri.place].filter(Boolean).join(', '))}${geoBtn}${sourceTagsHtml(p.buri.sources)}</span></div>`;
  }

  p.events.forEach((ev, idx) => {
    const label = ev.eventType || EVENT_LABELS[ev.type] || ev.type;
    const geoBtn = (ev.lati !== null && ev.lati !== undefined)
      ? `<a href="https://maps.apple.com/?ll=${ev.lati},${ev.long}" target="_blank" style="color:var(--gold-dim);font-size:0.75rem;text-decoration:none;margin-left:5px">ğŸ“</a>` : '';
    const parts = [ev.value, ev.date, ev.place].filter(Boolean).join(', ');
    html += `<div class="fact-row" data-pid="${id}" data-ev="${idx}" onclick="showEventForm(this.dataset.pid,this.dataset.ev)" style="cursor:pointer">
      <span class="fact-lbl">${esc(label)}</span>
      <span class="fact-val">${esc(parts)}${geoBtn}${sourceTagsHtml(ev.sources || [])}</span>
    </div>`;
  });

  if (p.titl) html += factRow('Titel', p.titl);
  if (p.reli) html += factRow('Religion', p.reli);

  if (!p.birth.date && !p.death.date && !p.events.length && !p.chr.date && !p.buri.date)
    html += `<div style="color:var(--text-muted);font-style:italic;font-size:0.85rem">Keine Lebensdaten eingetragen</div>`;

  html += `</div>`;

  // Notes
  if (p.noteText) {
    html += `<div class="section fade-up"><div class="section-title">Notizen</div>
      <div style="font-size:0.88rem;color:var(--text-dim);line-height:1.6;white-space:pre-wrap">${esc(p.noteText)}</div>
    </div>`;
  }

  // Media
  if (p.media && p.media.length) {
    html += `<div class="section fade-up"><div class="section-title">Medien (${p.media.length})</div>`;
    for (const m of p.media) {
      const fname = m.file ? m.file.split(/[\\/]/).pop() : 'â€“';
      html += `<div class="fact-row">
        <span class="fact-lbl">ğŸ“·</span>
        <span class="fact-val" style="font-size:0.82rem">${esc(m.title || fname)}</span>
      </div>`;
    }
    html += `</div>`;
  }

  // As spouse
  if (p.fams.length) {
    html += `<div class="section fade-up">
      <div class="section-head"><div class="section-title">Ehepartner &amp; Kinder</div></div>`;
    for (const famId of p.fams) {
      const fam = db.families[famId];
      if (!fam) continue;
      const marriageLabel = fam.marr.date ? fam.marr.date : famId;
      html += `<div class="family-nav-row" onclick="showFamilyDetail('${famId}')">
        <span class="fnr-label"><span class="fnr-icon">âš­</span> Familie Â· ${esc(marriageLabel)}</span>
        <span class="row-arrow">â€º</span>
      </div>`;
      const partnerId = p.sex === 'M' ? fam.wife : fam.husb;
      const partner = partnerId ? db.individuals[partnerId] : null;
      if (partner) html += relRow(partner, 'Ehepartner' + (fam.marr.date ? ' Â· ' + fam.marr.date : ''));
      for (const cid of fam.children) {
        const child = db.individuals[cid];
        if (child) html += relRow(child, 'Kind' + (child.birth.date ? ' Â· * ' + child.birth.date : ''));
      }
    }
    html += `</div>`;
  }

  // Parents
  if (p.famc.length) {
    html += `<div class="section fade-up"><div class="section-head"><div class="section-title">Eltern</div></div>`;
    for (const fref of p.famc) {
      const famId = typeof fref === 'string' ? fref : fref.famId;
      const fam = db.families[famId];
      if (!fam) continue;
      html += `<div class="family-nav-row" onclick="showFamilyDetail('${famId}')">
        <span class="fnr-label"><span class="fnr-icon">âš­</span> Herkunftsfamilie Â· ${famId}</span>
        <span class="row-arrow">â€º</span>
      </div>`;
      for (const pid of [fam.husb, fam.wife]) {
        if (!pid) continue;
        const parent = db.individuals[pid];
        if (parent) html += relRow(parent, parent.sex === 'M' ? 'Vater' : parent.sex === 'F' ? 'Mutter' : 'Elternteil');
      }
    }
    html += `</div>`;
  }

  document.getElementById('detailContent').innerHTML = html;
  showView('v-detail');
}

function showFamilyDetail(id) {
  const f = db.families[id];
  if (!f) return;
  _beforeDetailNavigate();
  currentFamilyId = id;
  currentPersonId = null;
  currentSourceId = null;

  const husb = f.husb ? db.individuals[f.husb] : null;
  const wife = f.wife ? db.individuals[f.wife] : null;
  const title = [husb?.name, wife?.name].filter(Boolean).join(' & ') || id;

  document.getElementById('detailTopTitle').textContent = 'Familie';
  document.getElementById('editBtn').style.display = '';
  document.getElementById('editBtn').onclick = () => showFamilyForm(id);
  const _famTreeTarget = f.husb || f.wife || null;
  document.getElementById('treeBtn').style.display = _famTreeTarget ? '' : 'none';
  if (_famTreeTarget) document.getElementById('treeBtn').onclick = () => showTree(_famTreeTarget);

  let html = `<div class="detail-hero fade-up">
    <div class="detail-avatar" style="font-size:1.8rem">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
    <div class="detail-name">${esc(title)}</div>
    <div class="detail-id">${id}</div>
  </div>`;

  if (f.marr.date || f.marr.place) {
    html += `<div class="section fade-up"><div class="section-title">Heirat</div>`;
    const marrSrc = (f.marr.sources?.length) ? f.marr.sources : (f.sourceRefs?.length ? [...f.sourceRefs] : null);
    if (f.marr.date) html += factRow('Datum', f.marr.date, '', f.marr.place ? null : marrSrc);
    if (f.marr.place) {
      const geoBtn = (f.marr.lati !== null && f.marr.lati !== undefined)
        ? `<a href="https://maps.apple.com/?ll=${f.marr.lati},${f.marr.long}" target="_blank" style="color:var(--gold-dim);font-size:0.75rem;text-decoration:none;margin-left:5px">ğŸ“</a>` : '';
      html += factRow('Ort', f.marr.place, geoBtn, marrSrc);
    }
    html += `</div>`;
  }

  html += `<div class="section fade-up"><div class="section-title">Mitglieder</div>`;
  if (husb) html += relRow(husb, 'Ehemann / Vater');
  if (wife) html += relRow(wife, 'Ehefrau / Mutter');
  for (const cid of f.children) {
    const child = db.individuals[cid];
    if (child) html += relRow(child, 'Kind');
  }
  html += `</div>`;

  document.getElementById('detailContent').innerHTML = html;
  showView('v-detail');
}

function showSourceDetail(id) {
  const s = db.sources[id];
  if (!s) return;
  _beforeDetailNavigate();
  currentSourceId = id;
  currentPersonId = null;
  currentFamilyId = null;

  document.getElementById('detailTopTitle').textContent = 'Quelle';
  document.getElementById('editBtn').style.display = '';
  document.getElementById('editBtn').onclick = () => showSourceForm(id);
  document.getElementById('treeBtn').style.display = 'none';

  // Collect all persons and families referencing this source
  const refPersons = Object.values(db.individuals).filter(p => p.sourceRefs && p.sourceRefs.has(id));
  const refFamilies = Object.values(db.families).filter(f => f.sourceRefs && f.sourceRefs.has(id));

  let html = `<div class="detail-hero fade-up">
    <div class="detail-avatar" style="font-size:1.8rem">ğŸ“–</div>
    <div class="detail-name">${esc(s.abbr || s.title || id)}</div>
    <div class="detail-id">${id} Â· ${refPersons.length + refFamilies.length} Referenzen${s.lastChanged ? ' Â· geÃ¤ndert ' + s.lastChanged : ''}</div>
  </div>`;

  // Source details
  html += `<div class="section fade-up"><div class="section-title">Details</div>`;
  if (s.abbr)                          html += factRow('Kurzname', s.abbr);
  if (s.title && s.title !== s.abbr)   html += factRow('Titel', s.title);
  if (s.author) html += factRow('Autor', s.author);
  if (s.date)   html += factRow('Datum', s.date);
  if (s.publ)   html += factRow('Verlag', s.publ);
  if (s.repo)   html += factRow('Aufbewahrung', s.repo);
  if (s.text)   html += `<div class="fact-row"><span class="fact-lbl">Notiz</span><span class="fact-val" style="white-space:pre-wrap;line-height:1.5">${esc(s.text)}</span></div>`;
  if (!s.abbr && !s.title && !s.author && !s.date && !s.publ && !s.repo && !s.text)
    html += `<div style="color:var(--text-muted);font-style:italic;font-size:0.85rem">Keine Details eingetragen</div>`;
  html += `</div>`;

  // Referencing persons
  if (refPersons.length) {
    const sorted = [...refPersons].sort((a, b) => (a.name||'').localeCompare(b.name||'', 'de'));
    html += `<div class="section fade-up">
      <div class="section-title">Personen (${refPersons.length})</div>`;
    for (const p of sorted) {
      let meta = '';
      if (p.birth.date) meta += '* ' + p.birth.date;
      if (p.death.date) meta += (meta ? '  â€  ' : 'â€  ') + p.death.date;
      html += relRow(p, meta || 'â€“');
    }
    html += `</div>`;
  }

  // Referencing families
  if (refFamilies.length) {
    html += `<div class="section fade-up">
      <div class="section-title">Familien (${refFamilies.length})</div>`;
    for (const f of refFamilies) {
      const husb = f.husb ? db.individuals[f.husb] : null;
      const wife = f.wife ? db.individuals[f.wife] : null;
      const title = [husb?.name, wife?.name].filter(Boolean).join(' & ') || f.id;
      const meta = f.marr.date ? 'âš­ ' + f.marr.date : '';
      html += `<div class="rel-row" onclick="showFamilyDetail('${f.id}')">
        <div class="rel-avatar" style="font-size:0.9rem">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
        <div class="rel-info">
          <div class="rel-name">${esc(title)}</div>
          <div class="rel-role">${esc(meta) || 'â€“'}</div>
        </div>
        <span class="p-arrow">â€º</span>
      </div>`;
    }
    html += `</div>`;
  }

  if (!refPersons.length && !refFamilies.length) {
    html += `<div class="section fade-up"><div class="empty" style="padding:16px 0">Keine Referenzen gefunden</div></div>`;
  }

  document.getElementById('detailContent').innerHTML = html;
  showView('v-detail');
}

function factRow(label, value, rawSuffix, srcIds) {
  const badges = srcIds ? sourceTagsHtml(srcIds) : '';
  return `<div class="fact-row"><span class="fact-lbl">${esc(label)}</span><span class="fact-val">${esc(value)}${rawSuffix||''}${badges}</span></div>`;
}

// Extrahiert die Quellennummer aus einer GEDCOM-ID (@S042@ â†’ 42)
function srcNum(sid) {
  const m = sid.match(/\d+/);
  return m ? parseInt(m[0], 10) : sid;
}

// Kompakte Quellen-Badges: Â§42 â€” inline in fact-val einbettbar
function sourceTagsHtml(sourceIds) {
  if (!sourceIds) return '';
  const ids = sourceIds instanceof Set ? [...sourceIds] : (Array.isArray(sourceIds) ? sourceIds : []);
  if (!ids.length) return '';
  return ids.map(sid => {
    const s = db.sources[sid];
    if (!s) return '';
    const tooltip = esc((s.abbr || s.title || sid).substring(0, 60));
    return `<span class="src-badge" data-sid="${sid}" onclick="event.stopPropagation();showSourceDetail(this.dataset.sid)" title="${tooltip}">Â§${srcNum(sid)}</span>`;
  }).filter(Boolean).join('');
}

function relRow(person, role) {
  const sc = person.sex === 'M' ? 'm' : person.sex === 'F' ? 'f' : '';
  const ic = person.sex === 'M' ? 'â™‚' : person.sex === 'F' ? 'â™€' : 'â—‡';
  return `<div class="rel-row" data-pid="${person.id}" onclick="showDetail(this.dataset.pid)">
    <div class="rel-avatar ${sc}">${ic}</div>
    <div class="rel-info">
      <div class="rel-name">${esc(person.name || person.id)}</div>
      <div class="rel-role">${esc(role)}</div>
    </div>
    <span class="p-arrow">â€º</span>
  </div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SOURCE WIDGET
//  srcState[prefix] = Set of source IDs currently selected
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const srcState = {};
const srcPageState = {};  // {prefix: {sid: page}} â€” Seitenangaben pro Quelle

function updateSrcPage(prefix, sid, value) {
  if (!srcPageState[prefix]) srcPageState[prefix] = {};
  srcPageState[prefix][sid] = value;
}

function initSrcWidget(prefix, selectedIds, pageMap) {
  const ids = selectedIds instanceof Set ? [...selectedIds] : (Array.isArray(selectedIds) ? selectedIds : []);
  srcState[prefix] = new Set(ids);
  srcPageState[prefix] = pageMap ? { ...pageMap } : {};
  renderSrcTags(prefix);
  renderSrcPicker(prefix);
  document.getElementById(prefix + '-src-picker').classList.remove('open');
}

function renderSrcTags(prefix) {
  const container = document.getElementById(prefix + '-src-tags');
  const selected = srcState[prefix] || new Set();
  if (!selected.size) {
    container.innerHTML = '<span style="font-size:0.8rem;color:var(--text-muted);font-style:italic">Keine Quellen zugewiesen</span>';
    return;
  }
  const pages = srcPageState[prefix] || {};
  container.innerHTML = [...selected].map(sid => {
    const s = db.sources[sid];
    const label = s ? (s.abbr || s.title || sid) : sid;
    const pageVal = pages[sid] || '';
    const pageField = prefix === 'ef'
      ? `<input type="text" class="src-page-input" value="${esc(pageVal)}" placeholder="Seiteâ€¦"
           oninput="updateSrcPage('${prefix}','${sid.replace(/'/g,"\\'").replace(/"/g,'&quot;')}',this.value)">`
      : '';
    return `<span class="src-tag">
      ${esc(label.length > 25 ? label.slice(0,23)+'â€¦' : label)}
      ${pageField}
      <button type="button" onclick="removeSrc('${prefix}','${sid}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;padding:0 0 0 4px;font-size:0.85rem">âœ•</button>
    </span>`;
  }).join('');
}

function renderSrcPicker(prefix) {
  const list = document.getElementById(prefix + '-src-list');
  const selected = srcState[prefix] || new Set();
  const srcs = Object.values(db.sources).sort((a,b) => (a.abbr||a.title||'').localeCompare(b.abbr||b.title||'','de'));
  if (!srcs.length) {
    list.innerHTML = '<div class="src-picker-empty">Noch keine Quellen vorhanden</div>';
    return;
  }
  list.innerHTML = srcs.map(s => {
    const label = s.abbr || s.title || s.id;
    const isSel = selected.has(s.id);
    return `<div class="src-picker-item ${isSel ? 'selected' : ''}" onclick="toggleSrc('${prefix}','${s.id}')">
      ${isSel ? 'âœ“ ' : ''}${esc(label)}
    </div>`;
  }).join('');
}

function toggleSrcPicker(prefix) {
  const picker = document.getElementById(prefix + '-src-picker');
  picker.classList.toggle('open');
  if (picker.classList.contains('open')) renderSrcPicker(prefix);
}

function toggleSrc(prefix, sid) {
  const set = srcState[prefix] || (srcState[prefix] = new Set());
  if (set.has(sid)) set.delete(sid); else set.add(sid);
  renderSrcTags(prefix);
  renderSrcPicker(prefix);
}

function removeSrc(prefix, sid) {
  if (srcState[prefix]) srcState[prefix].delete(sid);
  renderSrcTags(prefix);
  renderSrcPicker(prefix);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FORMS: PERSON
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAddSheet() { openModal('modalAdd'); }
function showEditSheet() {
  if (currentPersonId) showPersonForm(currentPersonId);
  else if (currentFamilyId) showFamilyForm(currentFamilyId);
  else if (currentSourceId) showSourceForm(currentSourceId);
}

function showPersonForm(id) {
  closeModal('modalAdd');
  const p = id ? db.individuals[id] : null;
  document.getElementById('personFormTitle').textContent = p ? 'Person bearbeiten' : 'Neue Person';
  document.getElementById('pf-id').value = id || '';
  document.getElementById('pf-given').value = p?.given || '';
  document.getElementById('pf-surname').value = p?.surname || '';
  document.getElementById('pf-sex').value = p?.sex || 'U';
  document.getElementById('pf-occu').value = p?.events?.find(e => e.type === 'OCCU')?.value || '';
  document.getElementById('pf-note').value = p?.noteText || '';
  document.getElementById('deletePersonBtn').style.display = p ? 'block' : 'none';
  initSrcWidget('pf', p?.sourceRefs || []);
  openModal('modalPerson');
}

function savePerson() {
  const id = document.getElementById('pf-id').value || nextId('I');
  const given = document.getElementById('pf-given').value.trim();
  const surname = document.getElementById('pf-surname').value.trim();
  const sex = document.getElementById('pf-sex').value;
  const occu = document.getElementById('pf-occu').value.trim();
  const note = document.getElementById('pf-note').value.trim();

  if (!given && !surname) { showToast('âš  Bitte Namen eingeben'); return; }

  const existing = db.individuals[id] || {};
  const events = existing.events ? existing.events.filter(e => e.type !== 'OCCU') : [];
  if (occu) events.unshift({ type: 'OCCU', value: occu, date: '', place: '', lati:null, long:null, eventType:'' });

  db.individuals[id] = {
    ...existing,
    id, given, surname,
    name: (given + (surname ? ' ' + surname : '')).trim(),
    sex,
    birth: existing.birth || { date:'', place:'', lati:null, long:null, sources:[], sourcePages:{} },
    death: existing.death || { date:'', place:'', lati:null, long:null, sources:[], sourcePages:{}, cause:'' },
    chr:   existing.chr   || { date:'', place:'', lati:null, long:null, sources:[], sourcePages:{} },
    buri:  existing.buri  || { date:'', place:'', lati:null, long:null, sources:[], sourcePages:{} },
    events,
    noteText: note,
    noteRefs: existing.noteRefs || [],
    famc: existing.famc || [],
    fams: existing.fams || [],
    media: existing.media || [],
    titl: existing.titl || '',
    reli: existing.reli || '',
    lastChanged: existing.lastChanged || '',
    sourceRefs: srcState['pf'] || new Set()
  };

  closeModal('modalPerson');
  markChanged();
  updateStats();
  renderTab();
  showToast('âœ“ Person gespeichert');

  if (currentPersonId === id) showDetail(id);
}

function deletePerson() {
  const id = document.getElementById('pf-id').value;
  if (!id || !db.individuals[id]) return;
  if (!confirm(`${db.individuals[id].name || id} wirklich lÃ¶schen?`)) return;

  // Remove from families
  for (const f of Object.values(db.families)) {
    if (f.husb === id) f.husb = null;
    if (f.wife === id) f.wife = null;
    f.children = f.children.filter(c => c !== id);
  }
  delete db.individuals[id];
  closeModal('modalPerson');
  markChanged(); updateStats();
  showMain(); showToast('âœ“ Person gelÃ¶scht');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FORMS: FAMILY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showFamilyForm(id) {
  closeModal('modalAdd');
  const f = id ? db.families[id] : null;
  document.getElementById('familyFormTitle').textContent = f ? 'Familie bearbeiten' : 'Neue Familie';
  document.getElementById('ff-id').value = id || '';

  // Populate person selects
  const persons = Object.values(db.individuals).sort((a,b) => (a.name||'').localeCompare(b.name||'','de'));
  const optionsAll = '<option value="">â€“ keine â€“</option>' + persons.map(p =>
    `<option value="${p.id}">${esc(p.name || p.id)}</option>`
  ).join('');
  document.getElementById('ff-husb').innerHTML = optionsAll;
  document.getElementById('ff-wife').innerHTML = optionsAll;

  document.getElementById('ff-husb').value = f?.husb || '';
  document.getElementById('ff-wife').value = f?.wife || '';
  document.getElementById('ff-mdate').value = f?.marr?.date || '';
  document.getElementById('ff-mplace').value = f?.marr?.place || '';
  document.getElementById('ff-children').value = f?.children?.join(', ') || '';
  document.getElementById('deleteFamilyBtn').style.display = f ? 'block' : 'none';
  initSrcWidget('ff', f?.marr?.sources || f?.sourceRefs || []);
  openModal('modalFamily');
}

function saveFamily() {
  const id = document.getElementById('ff-id').value || nextId('F');
  const husb = document.getElementById('ff-husb').value || null;
  const wife = document.getElementById('ff-wife').value || null;
  if (!husb && !wife) { showToast('âš  Mindestens ein Elternteil erforderlich'); return; }
  const mdate = document.getElementById('ff-mdate').value.trim();
  const mplace = document.getElementById('ff-mplace').value.trim();
  const childrenRaw = document.getElementById('ff-children').value;
  const children = childrenRaw.split(',').map(s => s.trim()).filter(Boolean);

  const existingFam = db.families[id] || {};
  db.families[id] = {
    ...existingFam,
    id, husb, wife, children,
    marr: { ...(existingFam.marr||{}), date: mdate, place: mplace, sources: [...(srcState['ff'] || [])] },
    noteText: existingFam.noteText || '',
    sourceRefs: srcState['ff'] || new Set()
  };

  // Update FAMS/FAMC references
  // famc entries are objects {famId, frel, mrel}, fams entries are strings
  const famcId = f => (typeof f === 'string' ? f : f.famId);
  for (const p of Object.values(db.individuals)) {
    p.fams = p.fams.filter(f => f !== id);
    p.famc = p.famc.filter(f => famcId(f) !== id);
  }
  if (husb && db.individuals[husb]) { if (!db.individuals[husb].fams.includes(id)) db.individuals[husb].fams.push(id); }
  if (wife && db.individuals[wife]) { if (!db.individuals[wife].fams.includes(id)) db.individuals[wife].fams.push(id); }
  for (const cid of children) {
    if (db.individuals[cid]) {
      if (!db.individuals[cid].famc.some(f => famcId(f) === id))
        db.individuals[cid].famc.push({ famId: id, frel: '', mrel: '' });
    }
  }

  closeModal('modalFamily');
  markChanged(); updateStats();
  renderTab();
  showToast('âœ“ Familie gespeichert');
  if (currentFamilyId === id) showFamilyDetail(id);
}

function deleteFamily() {
  const id = document.getElementById('ff-id').value;
  if (!id) return;
  if (!confirm('Familie wirklich lÃ¶schen?')) return;
  const famcId2 = f => (typeof f === 'string' ? f : f.famId);
  for (const p of Object.values(db.individuals)) {
    p.fams = p.fams.filter(f => f !== id);
    p.famc = p.famc.filter(f => famcId2(f) !== id);
  }
  delete db.families[id];
  closeModal('modalFamily');
  markChanged(); updateStats();
  showMain(); showToast('âœ“ Familie gelÃ¶scht');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FORMS: SOURCE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSourceForm(id) {
  closeModal('modalAdd');
  const s = id ? db.sources[id] : null;
  document.getElementById('sourceFormTitle').textContent = s ? 'Quelle bearbeiten' : 'Neue Quelle';
  document.getElementById('sf-id').value    = id || '';
  document.getElementById('sf-abbr').value  = s?.abbr   || '';
  document.getElementById('sf-title').value = s?.title  || '';
  document.getElementById('sf-auth').value  = s?.author || '';
  document.getElementById('sf-date').value  = s?.date   || '';
  document.getElementById('sf-publ').value  = s?.publ   || '';
  document.getElementById('sf-repo').value  = s?.repo   || '';
  document.getElementById('sf-text').value  = s?.text   || '';
  document.getElementById('deleteSourceBtn').style.display = s ? 'block' : 'none';
  openModal('modalSource');
}

function saveSource() {
  const id = document.getElementById('sf-id').value || nextId('S');
  const existing = db.sources[id] || {};
  const abbr  = document.getElementById('sf-abbr').value.trim();
  const title = document.getElementById('sf-title').value.trim();
  if (!abbr && !title) { showToast('âš  Kurzname oder Titel erforderlich'); return; }
  const now = new Date();
  const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  const gedDate = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
  db.sources[id] = {
    id,
    abbr,
    title,
    author:      document.getElementById('sf-auth').value.trim(),
    date:        document.getElementById('sf-date').value.trim(),
    publ:        document.getElementById('sf-publ').value.trim(),
    repo:        document.getElementById('sf-repo').value.trim(),
    text:        document.getElementById('sf-text').value.trim(),
    lastChanged: gedDate
  };
  closeModal('modalSource');
  markChanged(); updateStats();
  renderTab();
  showToast('âœ“ Quelle gespeichert');
  if (currentSourceId === id) showSourceDetail(id);
}

function deleteSource() {
  const id = document.getElementById('sf-id').value;
  if (!id) return;
  if (!confirm('Quelle wirklich lÃ¶schen?')) return;
  delete db.sources[id];
  closeModal('modalSource');
  markChanged(); updateStats();
  showMain(); showToast('âœ“ Quelle gelÃ¶scht');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FORMS: EVENT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _SPECIAL_OBJ = { BIRT:'birth', CHR:'chr', DEAT:'death', BURI:'buri' };
const _SPECIAL_LBL = { BIRT:'Geburt', CHR:'Taufe', DEAT:'Tod', BURI:'Beerdigung' };

function onEventTypeChange() {
  const t = document.getElementById('ef-type').value;
  document.getElementById('ef-val-group').style.display   = (t in _SPECIAL_OBJ || t === 'RESI') ? 'none' : '';
  document.getElementById('ef-cause-group').style.display = (t === 'DEAT')       ? ''     : 'none';
  document.getElementById('ef-addr-group').style.display  = (t === 'RESI')       ? ''     : 'none';
}

function showEventForm(personId, evIdx) {
  // data-Attribute liefern immer Strings â€” numerische Indizes zurÃ¼ckkonvertieren
  if (typeof evIdx === 'string' && evIdx !== '' && !(evIdx in _SPECIAL_OBJ) && !isNaN(evIdx)) evIdx = +evIdx;
  const p = db.individuals[personId];
  const isSpecial  = typeof evIdx === 'string' && evIdx in _SPECIAL_OBJ;
  const isExisting = typeof evIdx === 'number';
  const typeEl = document.getElementById('ef-type');

  document.getElementById('ef-pid').value    = personId;
  document.getElementById('ef-evidx').value  = isExisting ? evIdx : '';

  if (isSpecial) {
    const obj = p[_SPECIAL_OBJ[evIdx]] || {};
    typeEl.value = evIdx; typeEl.disabled = true;
    document.getElementById('ef-val').value   = '';
    document.getElementById('ef-date').value  = obj.date  || '';
    document.getElementById('ef-place').value = obj.place || '';
    document.getElementById('ef-cause').value = evIdx === 'DEAT' ? (obj.cause || '') : '';
    initSrcWidget('ef', obj.sources || [], obj.sourcePages || {});
    document.querySelector('#modalEvent .sheet-title').textContent = _SPECIAL_LBL[evIdx] + ' bearbeiten';
    document.getElementById('saveEventBtn').textContent = 'Speichern';
  } else {
    const ev = isExisting ? p.events[evIdx] : null;
    typeEl.disabled = false;
    typeEl.value = ev?.type || 'OCCU';
    document.getElementById('ef-val').value   = ev?.value || '';
    document.getElementById('ef-date').value  = ev?.date  || '';
    document.getElementById('ef-place').value = ev?.place || '';
    document.getElementById('ef-cause').value = '';
    document.getElementById('ef-addr').value  = ev?.addr  || '';
    initSrcWidget('ef', ev?.sources || [], ev?.sourcePages || {});
    document.querySelector('#modalEvent .sheet-title').textContent = ev ? 'Ereignis bearbeiten' : 'Ereignis hinzufÃ¼gen';
    document.getElementById('saveEventBtn').textContent = ev ? 'Speichern' : 'HinzufÃ¼gen';
  }
  onEventTypeChange();
  openModal('modalEvent');
}

function saveEvent() {
  const pid = document.getElementById('ef-pid').value;
  const p = db.individuals[pid];
  if (!p) return;
  const type = document.getElementById('ef-type').value;

  if (type in _SPECIAL_OBJ) {
    const key = _SPECIAL_OBJ[type];
    p[key] = { ...(p[key] || {}),
      date:        document.getElementById('ef-date').value.trim(),
      place:       document.getElementById('ef-place').value.trim(),
      sources:     [...(srcState['ef'] || [])],
      sourcePages: { ...(srcPageState['ef'] || {}) }
    };
    if (type === 'DEAT') p[key].cause = document.getElementById('ef-cause').value.trim();
  } else {
    const evIdxRaw = document.getElementById('ef-evidx').value;
    const evIdx    = evIdxRaw !== '' ? parseInt(evIdxRaw) : null;
    const ev = {
      type,
      value:     document.getElementById('ef-val').value.trim(),
      date:      document.getElementById('ef-date').value.trim(),
      place:     document.getElementById('ef-place').value.trim(),
      addr:      document.getElementById('ef-addr').value.trim(),
      lati: null, long: null, eventType: '', note: '',
      sources:     [...(srcState['ef'] || [])],
      sourcePages: { ...(srcPageState['ef'] || {}) }
    };
    if (evIdx !== null && p.events[evIdx]) {
      ev.lati      = p.events[evIdx].lati;
      ev.long      = p.events[evIdx].long;
      ev.eventType = p.events[evIdx].eventType || '';
      ev.note      = p.events[evIdx].note      || '';
      p.events[evIdx] = ev;
    } else {
      p.events.push(ev);
    }
  }

  closeModal('modalEvent');
  markChanged(); updateStats();
  showToast('âœ“ Ereignis gespeichert');
  if (currentPersonId === pid) showDetail(pid);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MODAL HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) {
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
// Close on backdrop click
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});
// Close on Escape key
document.addEventListener('keydown', e => {
  if (e.key !== 'Escape') return;
  const open = document.querySelector('.modal-overlay.open');
  if (open) open.classList.remove('open');
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ Extra-Places Persistenz â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadExtraPlaces() {
  try {
    const r = localStorage.getItem('stammbaum_extraplaces');
    return r ? JSON.parse(r).reduce((o, p) => { o[p.name] = p; return o; }, {}) : {};
  } catch(e) { return {}; }
}
function saveExtraPlaces() {
  try { localStorage.setItem('stammbaum_extraplaces', JSON.stringify(Object.values(db.extraPlaces))); } catch(e) {}
}

function debounce(fn, ms) {
  let t;
  return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
}
const filterPersonsDebounced  = debounce(filterPersons,  200);
const filterFamiliesDebounced = debounce(filterFamilies, 200);
const filterSourcesDebounced  = debounce(filterSources,  200);
const filterPlacesDebounced   = debounce(filterPlaces,   200);

function esc(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PLACE AUTOCOMPLETE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initPlaceAutocomplete(inputId, ddId) {
  const input = document.getElementById(inputId);
  const dd    = document.getElementById(ddId);
  if (!input || !dd) return;

  input.addEventListener('input', () => {
    const q = input.value.toLowerCase().trim();
    dd.innerHTML = '';
    if (!q) { dd.style.display = 'none'; return; }
    const names = [...collectPlaces().values()]
      .map(p => p.name)
      .filter(n => n.toLowerCase().includes(q))
      .sort((a, b) => {
        const aStart = a.toLowerCase().startsWith(q);
        const bStart = b.toLowerCase().startsWith(q);
        if (aStart !== bStart) return aStart ? -1 : 1;
        return a.localeCompare(b, 'de');
      })
      .slice(0, 12);
    if (!names.length) { dd.style.display = 'none'; return; }
    names.forEach(name => {
      const item = document.createElement('div');
      item.className = 'place-dropdown-item';
      item.textContent = name;
      item.addEventListener('mousedown', () => {
        input.value = name;
        dd.style.display = 'none';
      });
      dd.appendChild(item);
    });
    dd.style.display = 'block';
  });

  input.addEventListener('blur',  () => setTimeout(() => { dd.style.display = 'none'; }, 150));
  input.addEventListener('focus', () => { if (dd.children.length) dd.style.display = 'block'; });
}

// Autocomplete fÃ¼r alle Ortsfelder einmalig initialisieren
initPlaceAutocomplete('ef-place',  'ef-place-dd');
initPlaceAutocomplete('ff-mplace', 'ff-mplace-dd');
initPlaceAutocomplete('np-name',   'np-name-dd');
</script>
</body>
</html>
