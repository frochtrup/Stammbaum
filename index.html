<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Stammbaum">
<title>Stammbaum</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:        #18140f;
  --surface:   #211c14;
  --surface2:  #2a2318;
  --surface3:  #342c1e;
  --border:    #3e3424;
  --gold:      #c8a84a;
  --gold-lt:   #e5c96e;
  --gold-dim:  #7a6328;
  --gold-glow: rgba(200,168,74,0.15);
  --text:      #f2e8d4;
  --text-dim:  #a0906e;
  --text-muted:#5a4e38;
  --blue:      #4a7ab5;
  --blue-dim:  #2a4a72;
  --pink:      #a84a6e;
  --pink-dim:  #6e2a42;
  --green:     #4a9060;
  --red:       #c04040;
  --radius:    14px;
  --radius-sm: 9px;
}

* { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Source Serif 4', serif;
  font-weight: 300;
  min-height: 100dvh;
  overscroll-behavior: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOPBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  position: sticky; top: 0; z-index: 200;
  background: rgba(24,20,15,0.96);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  padding: env(safe-area-inset-top, 0px) 16px 0;
  display: flex; align-items: center;
  min-height: 52px;
  gap: 10px;
}
.topbar-inner {
  display: flex; align-items: center; gap: 10px;
  width: 100%; padding: 10px 0;
}
.topbar-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.05rem; color: var(--gold);
  letter-spacing: 0.06em; flex: 1;
}
.topbar-btn {
  background: none; border: none;
  color: var(--gold); font-size: 0.9rem;
  cursor: pointer; padding: 6px 10px;
  border-radius: var(--radius-sm);
  font-family: 'Source Serif 4', serif;
  transition: background 0.15s;
  white-space: nowrap;
}
.topbar-btn:active { background: var(--surface2); }
.topbar-btn.back { color: var(--text-dim); }
.topbar-btn.primary { color: var(--gold-lt); font-weight: 600; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIEWS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.view { display: none; }
.view.active { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#v-landing {
  display: none; flex-direction: column;
  align-items: center; justify-content: center;
  min-height: 100dvh; gap: 28px;
  padding: 48px 24px;
  text-align: center;
}
#v-landing.active { display: flex; }

.brand h1 {
  font-family: 'Playfair Display', serif;
  font-size: 3rem; font-weight: 700;
  color: var(--gold); letter-spacing: 0.04em;
  line-height: 1;
}
.brand p {
  margin-top: 8px; color: var(--text-dim);
  font-style: italic; font-size: 0.95rem;
}
.ornament { color: var(--gold-dim); letter-spacing: 0.4em; font-size: 1.2rem; }

.upload-box {
  width: 100%; max-width: 340px;
  border: 2px dashed var(--gold-dim);
  border-radius: var(--radius);
  padding: 32px 20px; cursor: pointer;
  background: var(--surface);
  transition: all 0.2s;
}
.upload-box:active, .upload-box.drag { border-color: var(--gold); background: var(--surface2); }
.upload-box .ub-icon { font-size: 2.2rem; margin-bottom: 10px; }
.upload-box h3 {
  font-family: 'Playfair Display', serif;
  color: var(--gold-lt); font-size: 1rem; margin-bottom: 5px;
}
.upload-box p { color: var(--text-muted); font-size: 0.82rem; line-height: 1.5; }
#fileInput { display: none; }

.icloud-hint {
  max-width: 340px; text-align: left;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  font-size: 0.82rem; color: var(--text-dim);
  line-height: 1.6;
}
.icloud-hint strong { color: var(--gold-lt); }

.btn-ghost {
  background: none; border: 1px solid var(--border);
  color: var(--text-muted); padding: 8px 22px;
  border-radius: 20px; cursor: pointer;
  font-family: 'Source Serif 4', serif;
  font-size: 0.85rem; transition: all 0.2s;
}
.btn-ghost:active { border-color: var(--gold-dim); color: var(--text-dim); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-bar {
  display: flex; gap: 0;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
}
.stat {
  flex: 1; text-align: center;
  padding: 10px 4px;
  border-right: 1px solid var(--border);
}
.stat:last-child { border-right: none; }
.stat-num {
  font-family: 'Playfair Display', serif;
  font-size: 1.3rem; color: var(--gold);
}
.stat-lbl {
  font-size: 0.65rem; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.1em;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEARCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.search-wrap {
  padding: 10px 14px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
}
.search-input {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 9px 13px;
  color: var(--text);
  font-family: 'Source Serif 4', serif;
  font-size: 0.95rem; outline: none;
  transition: border-color 0.2s;
}
.search-input:focus { border-color: var(--gold-dim); }
.search-input::placeholder { color: var(--text-muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSON LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#personList { padding-bottom: 100px; }

.alpha-sep {
  padding: 4px 14px;
  font-size: 0.68rem; color: var(--gold-dim);
  background: var(--bg);
  font-family: 'Playfair Display', serif;
  letter-spacing: 0.08em;
}
.person-row {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  cursor: pointer; transition: background 0.12s;
}
.person-row:active { background: var(--surface2); }
.p-avatar {
  width: 44px; height: 44px; border-radius: 50%;
  background: var(--surface2); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; flex-shrink: 0; color: var(--text-muted);
}
.p-avatar.m { border-color: var(--blue-dim); color: var(--blue); }
.p-avatar.f { border-color: var(--pink-dim); color: var(--pink); }
.p-info { flex: 1; min-width: 0; }
.p-name {
  font-family: 'Playfair Display', serif;
  font-size: 0.98rem; color: var(--text);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.p-meta {
  font-size: 0.76rem; color: var(--text-muted); margin-top: 2px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.p-arrow { color: var(--text-muted); font-size: 0.85rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#v-detail { padding-bottom: 100px; }
#v-detail.active { display: block; }

.detail-hero {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 24px 16px; text-align: center;
}
.detail-avatar {
  width: 76px; height: 76px; border-radius: 50%;
  background: var(--surface2); border: 2px solid var(--gold-dim);
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem; margin: 0 auto 14px; color: var(--gold-dim);
}
.detail-avatar.m { border-color: var(--blue); color: var(--blue); }
.detail-avatar.f { border-color: var(--pink); color: var(--pink); }
.detail-name {
  font-family: 'Playfair Display', serif;
  font-size: 1.55rem; color: var(--gold-lt); line-height: 1.2;
}
.detail-id { font-size: 0.72rem; color: var(--text-muted); margin-top: 4px; }

.section {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
}
.section-head {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 12px;
}
.section-title {
  font-size: 0.68rem; text-transform: uppercase;
  letter-spacing: 0.16em; color: var(--gold-dim);
  font-family: 'Source Serif 4', serif; font-weight: 400;
}
.section-add {
  background: none; border: 1px solid var(--border);
  color: var(--text-muted); font-size: 0.75rem;
  padding: 3px 10px; border-radius: 12px; cursor: pointer;
  font-family: 'Source Serif 4', serif; transition: all 0.15s;
}
.section-add:active { border-color: var(--gold-dim); color: var(--gold-dim); }

.fact-row {
  display: flex; gap: 10px; margin-bottom: 9px; font-size: 0.88rem;
}
.fact-lbl { color: var(--text-muted); min-width: 88px; flex-shrink: 0; font-style: italic; }
.fact-val { color: var(--text); }

.rel-row {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 0; border-bottom: 1px solid var(--border);
  cursor: pointer; transition: opacity 0.15s;
}
.rel-row:last-child { border-bottom: none; }
.rel-row:active { opacity: 0.6; }
.rel-avatar {
  width: 34px; height: 34px; border-radius: 50%;
  background: var(--surface2); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 0.9rem; flex-shrink: 0; color: var(--text-muted);
}
.rel-avatar.m { border-color: var(--blue-dim); color: var(--blue); }
.rel-avatar.f { border-color: var(--pink-dim); color: var(--pink); }
.rel-info { flex: 1; }
.rel-name {
  font-family: 'Playfair Display', serif;
  font-size: 0.92rem; color: var(--text);
}
.rel-role { font-size: 0.72rem; color: var(--text-muted); font-style: italic; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM FAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fab {
  position: fixed;
  bottom: calc(24px + env(safe-area-inset-bottom, 0px));
  right: 20px; z-index: 300;
  width: 56px; height: 56px; border-radius: 50%;
  background: var(--gold);
  border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.6rem; color: var(--bg);
  box-shadow: 0 4px 20px rgba(200,168,74,0.4);
  transition: transform 0.15s, box-shadow 0.15s;
}
.fab:active { transform: scale(0.94); box-shadow: 0 2px 10px rgba(200,168,74,0.3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL / SHEET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(0,0,0,0.7);
  display: none; align-items: flex-end;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.modal-overlay.open { display: flex; }

.sheet {
  width: 100%; background: var(--surface);
  border-radius: 20px 20px 0 0;
  border-top: 1px solid var(--border);
  padding: 0 0 env(safe-area-inset-bottom, 16px);
  max-height: 90dvh;
  overflow-y: auto;
  animation: slideUp 0.28s cubic-bezier(0.32,0.72,0,1);
}
@keyframes slideUp {
  from { transform: translateY(100%); }
  to   { transform: translateY(0); }
}

.sheet-handle {
  width: 36px; height: 4px; border-radius: 2px;
  background: var(--border); margin: 12px auto 0;
}
.sheet-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.1rem; color: var(--gold-lt);
  padding: 16px 20px 0;
}
.sheet-body { padding: 16px 20px; }

/* Form elements */
.form-group { margin-bottom: 16px; }
.form-label {
  display: block; font-size: 0.72rem;
  text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--text-muted); margin-bottom: 6px;
  font-family: 'Source Serif 4', serif;
}
.form-input, .form-select {
  width: 100%; background: var(--bg);
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 10px 12px; color: var(--text);
  font-family: 'Source Serif 4', serif; font-size: 0.95rem;
  outline: none; transition: border-color 0.2s;
  -webkit-appearance: none; appearance: none;
}
.form-input:focus, .form-select:focus { border-color: var(--gold-dim); }
.form-input::placeholder { color: var(--text-muted); }
.form-row { display: flex; gap: 10px; }
.form-row .form-group { flex: 1; }

.btn-row { display: flex; gap: 10px; margin-top: 20px; }

/* Source widget */
.src-widget { margin-bottom: 16px; }
.src-tags { display: flex; flex-wrap: wrap; gap: 6px; min-height: 28px; margin-bottom: 8px; }
.src-tag {
  display: inline-flex; align-items: center; gap: 5px;
  background: var(--surface2); border: 1px solid var(--gold-dim);
  border-radius: 20px; padding: 3px 10px 3px 12px;
  font-size: 0.78rem; color: var(--gold); cursor: default;
  font-family: 'Source Serif 4', serif;
}
.src-tag-x {
  background: none; border: none; color: var(--text-muted);
  cursor: pointer; font-size: 0.9rem; padding: 0; line-height: 1;
}
.src-tag-x:active { color: var(--red); }
.src-add-btn {
  display: inline-flex; align-items: center; gap: 4px;
  background: none; border: 1px dashed var(--border);
  border-radius: 20px; padding: 3px 10px;
  font-size: 0.78rem; color: var(--text-muted);
  cursor: pointer; font-family: 'Source Serif 4', serif;
}
.src-add-btn:active { border-color: var(--gold-dim); color: var(--gold); }
/* Source picker inside modal */
.src-picker { display:none; margin-top:6px; }
.src-picker.open { display:block; }
.src-picker-list {
  background: var(--bg); border: 1px solid var(--border);
  border-radius: var(--radius-sm); max-height: 180px; overflow-y: auto;
}
.src-picker-item {
  padding: 9px 12px; cursor: pointer; font-size: 0.85rem;
  border-bottom: 1px solid var(--border); color: var(--text-dim);
  display: flex; justify-content: space-between;
}
.src-picker-item:last-child { border-bottom: none; }
.src-picker-item:active { background: var(--surface2); }
.src-picker-item.selected { color: var(--gold); }
.src-picker-empty { padding: 12px; color: var(--text-muted); font-size: 0.82rem; text-align: center; }
.btn {
  flex: 1; padding: 12px;
  border-radius: var(--radius-sm); border: none;
  cursor: pointer; font-family: 'Source Serif 4', serif;
  font-size: 0.95rem; font-weight: 400;
  transition: opacity 0.15s;
}
.btn:active { opacity: 0.7; }
.btn-cancel { background: var(--surface2); color: var(--text-dim); }
.btn-save { background: var(--gold); color: var(--bg); font-weight: 600; }
.btn-danger { background: var(--red); color: #fff; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.export-bar {
  position: fixed;
  bottom: 0; left: 0; right: 0; z-index: 100;
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 10px 16px calc(10px + env(safe-area-inset-bottom, 0px));
  display: flex; gap: 10px;
}
.export-btn {
  flex: 1; padding: 11px;
  border-radius: var(--radius-sm); border: none;
  cursor: pointer; font-family: 'Source Serif 4', serif;
  font-size: 0.88rem; transition: opacity 0.15s;
}
.export-btn:active { opacity: 0.7; }
.export-btn.icloud { background: var(--gold); color: var(--bg); font-weight: 600; }
.export-btn.new-person { background: var(--surface2); color: var(--text-dim); border: 1px solid var(--border); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast {
  position: fixed; bottom: 80px; left: 50%;
  transform: translateX(-50%);
  background: var(--surface2); border: 1px solid var(--gold-dim);
  color: var(--text); padding: 9px 18px; border-radius: 20px;
  font-size: 0.83rem; opacity: 0; transition: opacity 0.25s;
  z-index: 1000; white-space: nowrap; pointer-events: none;
}
.toast.show { opacity: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOURCES VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.source-card {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  cursor: pointer; transition: background 0.12s;
}
.source-card:active { background: var(--surface2); }
.source-title {
  font-family: 'Playfair Display', serif;
  font-size: 0.95rem; color: var(--text);
}
.source-meta { font-size: 0.76rem; color: var(--text-muted); margin-top: 3px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHANGED INDICATOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.changed-dot {
  display: inline-block; width: 7px; height: 7px;
  border-radius: 50%; background: var(--gold);
  margin-left: 6px; vertical-align: middle;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabs {
  display: flex; background: var(--surface);
  border-bottom: 1px solid var(--border);
}
.tab {
  flex: 1; padding: 11px 4px; text-align: center;
  font-size: 0.78rem; color: var(--text-muted);
  cursor: pointer; border: none; background: none;
  font-family: 'Source Serif 4', serif;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
}
.tab.active { color: var(--gold); border-bottom-color: var(--gold); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty { padding: 40px 24px; text-align: center; color: var(--text-muted); font-style: italic; font-size: 0.9rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeUp {
  from { opacity:0; transform:translateY(12px); }
  to   { opacity:1; transform:translateY(0); }
}
.fade-up { animation: fadeUp 0.3s ease both; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LANDING VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="v-landing" class="view active">
  <div class="brand">
    <div class="ornament">âœ¦  âœ¦  âœ¦</div>
    <h1>Stammbaum</h1>
    <p>GEDCOM Â· Viewer &amp; Editor</p>
  </div>

  <div class="upload-box" id="uploadBox">
    <div class="ub-icon">ğŸ“œ</div>
    <h3>GEDCOM-Datei Ã¶ffnen</h3>
    <p>Tippen Sie hier oder ziehen Sie<br>eine .ged Datei hierher</p>
    <input type="file" id="fileInput" accept="*/*">
  </div>

  <div class="icloud-hint">
    <strong>ğŸ“± iPhone:</strong><br>
    Tippen Sie auf â€GEDCOM-Datei Ã¶ffnen" â†’ im Dateipicker zu iCloud Drive â†’ Genealogie â†’ <em>meinStammbaum.ged</em> navigieren.<br><br>
    <strong>ğŸ”’ Ihre Daten bleiben auf Ihrem GerÃ¤t.</strong> Nichts wird hochgeladen oder geteilt.<br><br>
    <strong>â˜ï¸ Speichern:</strong> Tippen Sie auf â€Speichern" â†’ die .ged Datei wird heruntergeladen â†’ in iCloud Drive ablegen â†’ fertig.
  </div>

  <button class="btn-ghost" onclick="loadDemo()">Demo-Daten laden</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN VIEW (Tabs: Personen / Quellen)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="v-main" class="view">
  <div class="topbar">
    <div class="topbar-inner">
      <span class="topbar-title">âš˜ Stammbaum <span id="changedIndicator" style="display:none" class="changed-dot"></span></span>
      <button class="topbar-btn" onclick="exportGEDCOM()" title="Speichern">â˜ï¸</button>
      <button class="topbar-btn" onclick="openModal('modalMenu')" title="MenÃ¼" style="font-size:1.2rem; padding: 6px 8px;">â˜°</button>
    </div>
  </div>

  <div class="stats-bar">
    <div class="stat"><div class="stat-num" id="sPersons">0</div><div class="stat-lbl">Personen</div></div>
    <div class="stat"><div class="stat-num" id="sFamilies">0</div><div class="stat-lbl">Familien</div></div>
    <div class="stat"><div class="stat-num" id="sEvents">0</div><div class="stat-lbl">Ereignisse</div></div>
    <div class="stat"><div class="stat-num" id="sSources">0</div><div class="stat-lbl">Quellen</div></div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('persons')">Personen</button>
    <button class="tab" onclick="switchTab('families')">Familien</button>
    <button class="tab" onclick="switchTab('sources')">Quellen</button>
    <button class="tab" onclick="switchTab('places')">Orte</button>
  </div>

  <div id="tab-persons">
    <div class="search-wrap">
      <input class="search-input" type="search" id="searchInput" placeholder="Name, Ort, Datum, Berufâ€¦" oninput="filterPersons(this.value)">
    </div>
    <div id="personList"></div>
  </div>

  <div id="tab-families" style="display:none"></div>
  <div id="tab-sources" style="display:none"></div>
  <div id="tab-places" style="display:none"></div>

  <button class="fab" id="fabBtn" onclick="showAddSheet()" title="Neu hinzufÃ¼gen">ï¼‹</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DETAIL VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="v-detail" class="view">
  <div class="topbar">
    <div class="topbar-inner">
      <button class="topbar-btn back" onclick="showMain()">â† ZurÃ¼ck</button>
      <span class="topbar-title" id="detailTopTitle"></span>
      <button class="topbar-btn primary" onclick="showEditSheet()" id="editBtn">Bearbeiten</button>
    </div>
  </div>
  <div id="detailContent"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Add chooser -->
<div class="modal-overlay" id="modalAdd">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Neu hinzufÃ¼gen</div>
    <div class="sheet-body">
      <div class="btn-row" style="flex-direction:column; gap:10px">
        <button class="btn btn-save" onclick="closeModal('modalAdd'); showPersonForm(null)">ğŸ‘¤ Neue Person</button>
        <button class="btn btn-save" style="background:var(--surface2);color:var(--text-dim);border:1px solid var(--border)" onclick="closeModal('modalAdd'); showFamilyForm(null)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Neue Familie</button>
        <button class="btn btn-save" style="background:var(--surface2);color:var(--text-dim);border:1px solid var(--border)" onclick="closeModal('modalAdd'); showSourceForm(null)">ğŸ“– Neue Quelle</button>
        <button class="btn btn-cancel" onclick="closeModal('modalAdd')">Abbrechen</button>
      </div>
    </div>
  </div>
</div>

<!-- Person form -->
<div class="modal-overlay" id="modalPerson">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="personFormTitle">Person bearbeiten</div>
    <div class="sheet-body">
      <input type="hidden" id="pf-id">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Vorname</label>
          <input class="form-input" id="pf-given" placeholder="Anna">
        </div>
        <div class="form-group">
          <label class="form-label">Nachname</label>
          <input class="form-input" id="pf-surname" placeholder="MÃ¼ller">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Geschlecht</label>
        <select class="form-select" id="pf-sex">
          <option value="U">Unbekannt</option>
          <option value="M">MÃ¤nnlich</option>
          <option value="F">Weiblich</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Beruf</label>
        <input class="form-input" id="pf-occu" placeholder="BÃ¤ckermeister">
      </div>
      <div class="form-group">
        <label class="form-label">Notiz</label>
        <input class="form-input" id="pf-note" placeholder="Weitere Informationenâ€¦">
      </div>
      <div class="src-widget" id="pf-src-widget">
        <label class="form-label">Quellen</label>
        <div class="src-tags" id="pf-src-tags"></div>
        <button type="button" class="src-add-btn" onclick="toggleSrcPicker('pf')">ï¼‹ Quelle hinzufÃ¼gen</button>
        <div class="src-picker" id="pf-src-picker">
          <div class="src-picker-list" id="pf-src-list"></div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-cancel" onclick="closeModal('modalPerson')">Abbrechen</button>
        <button class="btn btn-save" onclick="savePerson()">Speichern</button>
      </div>
      <div style="margin-top:10px">
        <button class="btn btn-danger" id="deletePersonBtn" onclick="deletePerson()" style="width:100%">Person lÃ¶schen</button>
      </div>
    </div>
  </div>
</div>

<!-- Family form -->
<div class="modal-overlay" id="modalFamily">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="familyFormTitle">Familie bearbeiten</div>
    <div class="sheet-body">
      <input type="hidden" id="ff-id">
      <div class="form-group">
        <label class="form-label">Ehemann / Vater</label>
        <select class="form-select" id="ff-husb"><option value="">â€“ keiner â€“</option></select>
      </div>
      <div class="form-group">
        <label class="form-label">Ehefrau / Mutter</label>
        <select class="form-select" id="ff-wife"><option value="">â€“ keine â€“</option></select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Heiratsdatum</label>
          <input class="form-input" id="ff-mdate" placeholder="10 JUN 1920">
        </div>
        <div class="form-group">
          <label class="form-label">Heiratsort</label>
          <input class="form-input" id="ff-mplace" placeholder="MÃ¼nchen">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Kinder (IDs, kommagetrennt)</label>
        <input class="form-input" id="ff-children" placeholder="@I003@, @I004@">
      </div>
      <div class="src-widget" id="ff-src-widget">
        <label class="form-label">Quellen (Heirat)</label>
        <div class="src-tags" id="ff-src-tags"></div>
        <button type="button" class="src-add-btn" onclick="toggleSrcPicker('ff')">ï¼‹ Quelle hinzufÃ¼gen</button>
        <div class="src-picker" id="ff-src-picker">
          <div class="src-picker-list" id="ff-src-list"></div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-cancel" onclick="closeModal('modalFamily')">Abbrechen</button>
        <button class="btn btn-save" onclick="saveFamily()">Speichern</button>
      </div>
      <div style="margin-top:10px">
        <button class="btn btn-danger" id="deleteFamilyBtn" onclick="deleteFamily()" style="width:100%">Familie lÃ¶schen</button>
      </div>
    </div>
  </div>
</div>

<!-- Source form -->
<div class="modal-overlay" id="modalSource">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="sourceFormTitle">Quelle bearbeiten</div>
    <div class="sheet-body">
      <input type="hidden" id="sf-id">
      <div class="form-group">
        <label class="form-label">Titel</label>
        <input class="form-input" id="sf-title" placeholder="Kirchenbuch MÃ¼nchen 1850â€“1900">
      </div>
      <div class="form-group">
        <label class="form-label">Autor / Institution</label>
        <input class="form-input" id="sf-auth" placeholder="Pfarramt St. Peter">
      </div>
      <div class="form-group">
        <label class="form-label">Datum / Jahr</label>
        <input class="form-input" id="sf-date" placeholder="1890">
      </div>
      <div class="form-group">
        <label class="form-label">Ort / Aufbewahrung</label>
        <input class="form-input" id="sf-repo" placeholder="Stadtarchiv MÃ¼nchen">
      </div>
      <div class="form-group">
        <label class="form-label">Notiz / Beschreibung</label>
        <input class="form-input" id="sf-text" placeholder="Weitere Detailsâ€¦">
      </div>
      <div class="btn-row">
        <button class="btn btn-cancel" onclick="closeModal('modalSource')">Abbrechen</button>
        <button class="btn btn-save" onclick="saveSource()">Speichern</button>
      </div>
      <div style="margin-top:10px">
        <button class="btn btn-danger" id="deleteSourceBtn" onclick="deleteSource()" style="width:100%">Quelle lÃ¶schen</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Event to person -->
<div class="modal-overlay" id="modalEvent">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Ereignis hinzufÃ¼gen</div>
    <div class="sheet-body">
      <input type="hidden" id="ef-pid">
      <input type="hidden" id="ef-evidx">
      <div class="form-group">
        <label class="form-label">Ereignistyp</label>
        <select class="form-select" id="ef-type" onchange="onEventTypeChange()">
          <option value="BIRT">Geburt</option>
          <option value="CHR">Taufe</option>
          <option value="DEAT">Tod</option>
          <option value="BURI">Beerdigung</option>
          <option value="OCCU">Beruf</option>
          <option value="RESI">Wohnort</option>
          <option value="EDUC">Bildung</option>
          <option value="RELI">Religion</option>
          <option value="EMIG">Auswanderung</option>
          <option value="IMMI">Einwanderung</option>
          <option value="NATU">EinbÃ¼rgerung</option>
          <option value="EVEN">Sonstiges</option>
        </select>
      </div>
      <div class="form-group" id="ef-val-group">
        <label class="form-label">Wert / Beschreibung</label>
        <input class="form-input" id="ef-val" placeholder="z.B. Schreiner">
      </div>
      <div class="form-group" id="ef-cause-group" style="display:none">
        <label class="form-label">Todesursache</label>
        <input class="form-input" id="ef-cause" placeholder="z.B. Typhus">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Datum</label>
          <input class="form-input" id="ef-date" placeholder="1910">
        </div>
        <div class="form-group">
          <label class="form-label">Ort</label>
          <input class="form-input" id="ef-place" placeholder="MÃ¼nchen">
        </div>
      </div>
      <div class="src-widget" id="ef-src-widget">
        <label class="form-label">Quellen</label>
        <div class="src-tags" id="ef-src-tags"></div>
        <button type="button" class="src-add-btn" onclick="toggleSrcPicker('ef')">ï¼‹ Quelle hinzufÃ¼gen</button>
        <div class="src-picker" id="ef-src-picker">
          <div class="src-picker-list" id="ef-src-list"></div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-cancel" onclick="closeModal('modalEvent')">Abbrechen</button>
        <button class="btn btn-save" id="saveEventBtn" onclick="saveEvent()">HinzufÃ¼gen</button>
      </div>
    </div>
  </div>
</div>

<!-- Place rename form -->
<div class="modal-overlay" id="modalPlace">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Ort umbenennen</div>
    <div class="sheet-body">
      <input type="hidden" id="pl-old">
      <div class="form-group">
        <label class="form-label">Ortsname</label>
        <input class="form-input" id="pl-name">
      </div>
      <div class="btn-row">
        <button class="btn btn-cancel" onclick="closeModal('modalPlace')">Abbrechen</button>
        <button class="btn btn-save" onclick="savePlace()">Speichern</button>
      </div>
    </div>
  </div>
</div>

<!-- Menu drawer -->
<div class="modal-overlay" id="modalMenu">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">MenÃ¼</div>
    <div class="sheet-body">
      <div class="btn-row" style="flex-direction:column; gap:10px">
        <button class="btn" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);text-align:left;padding:14px 16px;" onclick="closeModal('modalMenu'); document.getElementById('fileInput2').click()">
          ğŸ“‚ &nbsp; Andere Datei laden
        </button>
        <button class="btn" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);text-align:left;padding:14px 16px;" onclick="closeModal('modalMenu'); exportGEDCOM()">
          â˜ï¸ &nbsp; Als GEDCOM speichern
        </button>
        <button id="backupMenuBtn" class="btn" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);text-align:left;padding:14px 16px;" onclick="closeModal('modalMenu'); downloadBackup()">
          ğŸ—„ &nbsp; <span>Original-Backup herunterladen</span>
        </button>
        <button id="dirMenuBtn" class="btn" style="display:none;background:var(--surface2);color:var(--text);border:1px solid var(--border);text-align:left;padding:14px 16px;" onclick="closeModal('modalMenu'); pickSaveDir()">
          ğŸ“ &nbsp; <span id="dirMenuLabel">Speicher-Verzeichnis wÃ¤hlen</span>
        </button>
        <button class="btn" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);text-align:left;padding:14px 16px;" onclick="closeModal('modalMenu'); loadDemo()">
          ğŸ—‚ &nbsp; Demo-Daten laden
        </button>
        <button class="btn" style="background:var(--surface2);color:var(--text-muted);border:1px solid var(--border);text-align:left;padding:14px 16px;" onclick="closeModal('modalMenu'); confirmNewFile()">
          ğŸ—‘ &nbsp; Datei schlieÃŸen / neu beginnen
        </button>
        <button class="btn btn-cancel" onclick="closeModal('modalMenu')">Abbrechen</button>
      </div>
    </div>
  </div>
</div>
<input type="file" id="fileInput2" accept="*/*" style="display:none">

<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let db = { individuals: {}, families: {}, sources: {} };
let changed = false;
let _originalGedText = null;   // In-memory backup des zuletzt geladenen Originals
let _dirHandle = null;         // FileSystemDirectoryHandle (Desktop-Speichern)
let currentPersonId = null;
let currentFamilyId = null;
let currentSourceId = null;
let currentTab = 'persons';
let idCounter = 1000;

function nextId(prefix) {
  idCounter++;
  return `@${prefix}${idCounter}@`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GEDCOM PARSER  (v3 â€“ geo fixed)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseGEDCOM(text) {
  text = text.replace(/^\uFEFF/, '');
  const lines = text.split(/\r?\n/);

  const individuals = {}, families = {}, sources = {}, notes = {};
  let cur = null, curType = null;
  // Simple flat context tracking
  let lv1tag = '';   // current level-1 tag
  let lv2tag = '';   // current level-2 tag
  let lv3tag = '';   // current level-3 tag
  let evIdx  = -1;   // current event index in cur.events
  let inMap  = false; // are we inside a MAP block?
  let mapParent = ''; // which lv1 tag owns current MAP (BIRT/DEAT/etc.)

  for (let raw of lines) {
    const line = raw.trim();
    if (!line) continue;
    const m = line.match(/^(\d+)\s+(\S+)(.*)?$/);
    if (!m) continue;
    const lv  = parseInt(m[1]);
    const tag = m[2].trim();
    const val = (m[3] || '').trim();

    // â”€â”€ Level 0 â”€â”€
    if (lv === 0) {
      lv1tag = lv2tag = lv3tag = '';
      evIdx = -1; inMap = false; mapParent = '';
      if (tag.startsWith('@') && val.trim() === 'INDI') {
        cur = {
          id: tag, name:'', surname:'', given:'', prefix:'', suffix:'',
          sex:'U', uid:'', topSources:[],
          birth:{ date:'', place:'', lati:null, long:null, sources:[] },
          death:{ date:'', place:'', lati:null, long:null, sources:[], cause:'' },
          chr:{ date:'', place:'', lati:null, long:null, sources:[] },
          buri:{ date:'', place:'', lati:null, long:null, sources:[] },
          events:[], famc:[], fams:[],
          noteRefs:[], noteText:'',
          media:[], titl:'', reli:'', lastChanged:'',
          nameSources:[], sourceRefs: new Set()
        };
        individuals[tag] = cur; curType = 'INDI';
      } else if (tag.startsWith('@') && val.trim() === 'FAM') {
        cur = { id:tag, husb:null, wife:null, children:[], marr:{date:'',place:'',lati:null,long:null}, engag:{}, noteText:'', sourceRefs: new Set() };
        families[tag] = cur; curType = 'FAM';
      } else if (tag.startsWith('@') && val.trim() === 'SOUR') {
        cur = { id:tag, title:'', abbr:'', author:'', date:'', publ:'', repo:'', text:'', media:[] };
        sources[tag] = cur; curType = 'SOUR';
      } else if (tag.startsWith('@') && val.trim() === 'NOTE') {
        cur = { id:tag, text:'' };
        notes[tag] = cur; curType = 'NOTE';
      } else { curType = null; cur = null; }
      continue;
    }
    if (!cur) continue;

    // Track context tags
    if (lv === 1) { lv1tag = tag; lv2tag = ''; lv3tag = ''; inMap = false; mapParent = ''; }
    if (lv === 2) { lv2tag = tag; lv3tag = ''; if (tag !== 'MAP') inMap = false; }
    if (lv === 3) { lv3tag = tag; if (tag === 'MAP') { inMap = true; mapParent = lv1tag; } else { inMap = false; } }

    // â”€â”€ INDIVIDUAL â”€â”€
    if (curType === 'INDI') {

      if (lv === 1) {
        evIdx = -1;
        if (tag === 'NAME') {
          const sn = val.match(/\/([^\/]*)\//) || [];
          cur.surname = sn[1] ? sn[1].trim() : '';
          cur.given   = val.replace(/\/[^\/]*\//, '').trim();
          cur.name    = (cur.given + (cur.surname ? ' ' + cur.surname : '')).trim() || val.replace(/\//g,'').trim();
        }
        else if (tag === 'SEX')  cur.sex  = val;
        else if (tag === 'TITL') cur.titl = val;
        else if (tag === 'RELI') cur.reli = val;
        else if (tag === 'FAMC') cur.famc.push({ famId:val, frel:'', mrel:'' });
        else if (tag === 'FAMS') cur.fams.push(val);
        else if (tag === 'NOTE') { if (!val.startsWith('@')) cur.noteText += val; else cur.noteRefs.push(val); }
        else if (tag === '_UID') cur.uid = val;
        else if (tag === 'SOUR' && val.startsWith('@')) { cur.topSources.push(val); cur.sourceRefs.add(val); }
        else if (tag === 'OBJE') cur.media.push({ file:'', title:'' });
        else if (['OCCU','RESI','EDUC','EMIG','IMMI','NATU','EVEN','GRAD','ADOP'].includes(tag)) {
          cur.events.push({ type:tag, value:val, date:'', place:'', lati:null, long:null, eventType:'', note:'', sources:[] });
          evIdx = cur.events.length - 1;
        }
      }

      else if (lv === 2) {
        // Name parts
        if (lv1tag === 'NAME') {
          if (tag === 'GIVN') { cur.given = val; cur.name = (cur.given + (cur.surname ? ' '+cur.surname : '')).trim(); }
          if (tag === 'SURN') { cur.surname = val; cur.name = (cur.given + (cur.surname ? ' '+cur.surname : '')).trim(); }
          if (tag === 'NPFX') cur.prefix = val;
          if (tag === 'NSFX') cur.suffix = val;
          if (tag === 'SOUR' && val.startsWith('@')) { cur.nameSources.push(val); cur.sourceRefs.add(val); }
        }
        // Vital events
        else if (lv1tag === 'BIRT') {
          if (tag==='DATE') cur.birth.date=val;
          if (tag==='PLAC') cur.birth.place=val;
          if (tag==='SOUR' && val.startsWith('@')) { cur.birth.sources.push(val); cur.sourceRefs.add(val); }
        }
        else if (lv1tag === 'DEAT') {
          if (tag==='DATE') cur.death.date=val;
          if (tag==='PLAC') cur.death.place=val;
          if (tag==='CAUS') cur.death.cause=val;
          if (tag==='SOUR' && val.startsWith('@')) { cur.death.sources.push(val); cur.sourceRefs.add(val); }
        }
        else if (lv1tag === 'CHR') {
          if (tag==='DATE') cur.chr.date=val;
          if (tag==='PLAC') cur.chr.place=val;
          if (tag==='SOUR' && val.startsWith('@')) { cur.chr.sources.push(val); cur.sourceRefs.add(val); }
        }
        else if (lv1tag === 'BURI') {
          if (tag==='DATE') cur.buri.date=val;
          if (tag==='PLAC') cur.buri.place=val;
          if (tag==='SOUR' && val.startsWith('@')) { cur.buri.sources.push(val); cur.sourceRefs.add(val); }
        }
        // Other events
        else if (evIdx >= 0 && cur.events[evIdx]) {
          const ev = cur.events[evIdx];
          if (tag==='DATE')  ev.date = val;
          if (tag==='PLAC')  ev.place = val;
          if (tag==='TYPE')  ev.eventType = val;
          if (tag==='NOTE')  ev.note = val;
          if (tag==='CONC'||tag==='CONT') ev.value += (tag==='CONT'?'\n':'') + val;
          if (tag==='SOUR' && val.startsWith('@')) { ev.sources.push(val); cur.sourceRefs.add(val); }
        }
        // Family relationship
        if (lv1tag === 'FAMC' && cur.famc.length) {
          const fref = cur.famc[cur.famc.length-1];
          if (tag==='_FREL') fref.frel = val;
          if (tag==='_MREL') fref.mrel = val;
        }
        // Media
        if (lv1tag === 'OBJE' && cur.media.length) {
          if (tag==='FILE') cur.media[cur.media.length-1].file = val;
        }
        // Last changed
        if (lv1tag === 'CHAN' && tag==='DATE') cur.lastChanged = val;
        // Collect source references at level 2
        if (tag === 'SOUR' && val.startsWith('@')) cur.sourceRefs.add(val);
      }

      else if (lv === 3) {
        // Media title/form
        if (lv1tag === 'OBJE' && lv2tag === 'FILE' && tag === 'TITL' && cur.media.length)
          cur.media[cur.media.length-1].title = val;
        if (lv1tag === 'OBJE' && tag === 'TITL' && cur.media.length)
          cur.media[cur.media.length-1].title = val;
        // Event note continuation
        if (evIdx >= 0 && lv2tag === 'NOTE' && (tag==='CONC'||tag==='CONT'))
          cur.events[evIdx].note += (tag==='CONT'?'\n':'') + val;
        // Collect source references at level 3
        if (tag === 'SOUR' && val.startsWith('@')) cur.sourceRefs.add(val);
      }

      else if (lv === 4) {
        // GEO: MAP is at lv3, so LATI/LONG are at lv4
        if (inMap) {
          const coord = parseGeoCoord(val);
          if (mapParent === 'BIRT') { if (tag==='LATI') cur.birth.lati=coord; if (tag==='LONG') cur.birth.long=coord; }
          else if (mapParent === 'DEAT') { if (tag==='LATI') cur.death.lati=coord; if (tag==='LONG') cur.death.long=coord; }
          else if (mapParent === 'CHR')  { if (tag==='LATI') cur.chr.lati=coord;   if (tag==='LONG') cur.chr.long=coord; }
          else if (mapParent === 'BURI') { if (tag==='LATI') cur.buri.lati=coord;  if (tag==='LONG') cur.buri.long=coord; }
          else if (evIdx >= 0 && cur.events[evIdx]) {
            if (tag==='LATI') cur.events[evIdx].lati = coord;
            if (tag==='LONG') cur.events[evIdx].long = coord;
          }
        }
        // Collect source references at level 4
        if (tag === 'SOUR' && val.startsWith('@')) cur.sourceRefs.add(val);
      }

      // CONC/CONT for inline notes at any level
      if (lv1tag === 'NOTE' && lv > 1 && (tag==='CONC'||tag==='CONT'))
        cur.noteText += (tag==='CONT'?'\n':'') + val;
    }

    // â”€â”€ FAMILY â”€â”€
    if (curType === 'FAM') {
      if (lv === 1) {
        if (tag==='HUSB') cur.husb = val;
        else if (tag==='WIFE') cur.wife = val;
        else if (tag==='CHIL') cur.children.push(val);
        else if (tag==='NOTE') { if (!val.startsWith('@')) cur.noteText = val; }
        else if (tag==='SOUR' && val.startsWith('@')) cur.sourceRefs.add(val);
      }
      else if (lv === 2) {
        if (lv1tag==='MARR') {
          if (tag==='DATE') cur.marr.date=val;
          if (tag==='PLAC') cur.marr.place=val;
          if (tag==='SOUR' && val.startsWith('@')) { cur.marr.sources = cur.marr.sources||[]; cur.marr.sources.push(val); cur.sourceRefs.add(val); }
        }
        if (lv1tag==='ENGA') {
          if (tag==='DATE') cur.engag.date = val;
          if (tag==='PLAC') cur.engag.place = val;
        }
        if (lv1tag==='NOTE' && (tag==='CONC'||tag==='CONT')) cur.noteText += (tag==='CONT'?'\n':'') + val;
        if (tag==='SOUR' && val.startsWith('@')) cur.sourceRefs.add(val);
      }
      else if (lv === 3) {
        if (tag==='SOUR' && val.startsWith('@')) cur.sourceRefs.add(val);
      }
      else if (lv === 4 && inMap && mapParent === 'MARR') {
        const coord = parseGeoCoord(val);
        if (tag==='LATI') cur.marr.lati = coord;
        if (tag==='LONG') cur.marr.long = coord;
      }
    }

    // â”€â”€ SOURCE â”€â”€
    if (curType === 'SOUR') {
      if (lv === 1) {
        if (tag==='TITL')      cur.title  = val;
        else if (tag==='ABBR') cur.abbr   = val;
        else if (tag==='AUTH') cur.author = val;
        else if (tag==='DATE') cur.date   = val;
        else if (tag==='PUBL') cur.publ   = val;
        else if (tag==='REPO') cur.repo   = val;
        else if (tag==='TEXT') cur.text   = val;
        else if (tag==='OBJE') cur.media.push({ file:'', title:'' });
      }
      else if (lv === 2) {
        if (lv1tag==='TITL' && (tag==='CONC'||tag==='CONT')) cur.title += (tag==='CONT'?'\n':'') + val;
        if (lv1tag==='OBJE' && cur.media.length) {
          if (tag==='FILE') cur.media[cur.media.length-1].file  = val;
          if (tag==='TITL') cur.media[cur.media.length-1].title = val;
        }
      }
    }

    // â”€â”€ NOTE record â”€â”€
    if (curType === 'NOTE') {
      if (tag==='CONC') cur.text += val;
      else if (tag==='CONT') cur.text += '\n' + val;
    }
  }

  // Resolve NOTE references
  for (const p of Object.values(individuals)) {
    for (const ref of p.noteRefs) {
      if (ref && notes[ref]) p.noteText += (p.noteText ? '\n' : '') + notes[ref].text;
    }
  }

  return { individuals, families, sources, notes };
}



// Parse GEDCOM geo coordinate: N52.15 â†’ 52.15, W3.48 â†’ -3.48
function parseGeoCoord(val) {
  if (!val) return null;
  const m = val.match(/^([NSEW])([\d.]+)$/i);
  if (!m) return parseFloat(val) || null;
  const sign = (m[1].toUpperCase() === 'S' || m[1].toUpperCase() === 'W') ? -1 : 1;
  return sign * parseFloat(m[2]);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GEDCOM WRITER  (v2 â€“ vollstÃ¤ndig)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function writeGEDCOM() {
  const lines = [];
  const d = new Date();
  const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  const dateStr = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;

  lines.push('0 HEAD');
  lines.push('1 SOUR Stammbaum-App');
  lines.push('2 VERS 1.0');
  lines.push('1 GEDC');
  lines.push('2 VERS 5.5.1');
  lines.push('1 CHAR UTF-8');
  lines.push(`1 DATE ${dateStr}`);

  function geoLines(obj, indent) {
    if (obj && obj.lati !== null && obj.long !== null) {
      lines.push(`${indent} MAP`);
      const latStr = (obj.lati >= 0 ? 'N' : 'S') + Math.abs(obj.lati);
      const lonStr = (obj.long >= 0 ? 'E' : 'W') + Math.abs(obj.long);
      lines.push(`${indent+1} LATI ${latStr}`);
      lines.push(`${indent+1} LONG ${lonStr}`);
    }
  }

  function eventBlock(tag, obj, lv) {
    if (!obj || (!obj.date && !obj.place && !obj.cause && !(obj.sources && obj.sources.length))) return;
    lines.push(`${lv} ${tag}`);
    if (obj.date)  lines.push(`${lv+1} DATE ${obj.date}`);
    if (obj.cause) lines.push(`${lv+1} CAUS ${obj.cause}`);
    if (obj.place) {
      lines.push(`${lv+1} PLAC ${obj.place}`);
      geoLines(obj, lv+2);
    }
    if (obj.sources) for (const s of obj.sources) lines.push(`${lv+1} SOUR ${s}`);
  }

  for (const p of Object.values(db.individuals)) {
    lines.push(`0 ${p.id} INDI`);
    // Name with sub-tags
    const nameStr = (p.given || '') + (p.surname ? ' /' + p.surname + '/' : '');
    lines.push(`1 NAME ${nameStr.trim()}`);
    if (p.given)   lines.push(`2 GIVN ${p.given}`);
    if (p.surname) lines.push(`2 SURN ${p.surname}`);
    if (p.prefix)  lines.push(`2 NPFX ${p.prefix}`);
    if (p.suffix)  lines.push(`2 NSFX ${p.suffix}`);
    for (const s of (p.nameSources || [])) lines.push(`2 SOUR ${s}`);
    if (p.titl)    lines.push(`1 TITL ${p.titl}`);
    if (p.reli)    lines.push(`1 RELI ${p.reli}`);
    if (p.sex && p.sex !== 'U') lines.push(`1 SEX ${p.sex}`);
    for (const s of (p.topSources || [])) lines.push(`1 SOUR ${s}`);

    eventBlock('BIRT', p.birth, 1);
    eventBlock('CHR',  p.chr,   1);
    eventBlock('DEAT', p.death, 1);
    eventBlock('BURI', p.buri,  1);

    for (const ev of p.events) {
      lines.push(`1 ${ev.type}${ev.value ? ' ' + ev.value : ''}`);
      if (ev.eventType) lines.push(`2 TYPE ${ev.eventType}`);
      if (ev.date)  lines.push(`2 DATE ${ev.date}`);
      if (ev.place) {
        lines.push(`2 PLAC ${ev.place}`);
        geoLines(ev, 3);
      }
      if (ev.note) {
        const nl = ev.note.split('\n');
        lines.push(`2 NOTE ${nl[0]}`);
        for (let i = 1; i < nl.length; i++) lines.push(`3 CONT ${nl[i]}`);
      }
      if (ev.sources) for (const s of ev.sources) lines.push(`2 SOUR ${s}`);
    }

    if (p.noteText) {
      const noteLines = p.noteText.split('\n');
      lines.push(`1 NOTE ${noteLines[0]}`);
      for (let i = 1; i < noteLines.length; i++) lines.push(`2 CONT ${noteLines[i]}`);
    }

    for (const fref of p.famc) {
      const famId = typeof fref === 'string' ? fref : fref.famId;
      lines.push(`1 FAMC ${famId}`);
      if (typeof fref === 'object' && fref.frel) lines.push(`2 _FREL ${fref.frel}`);
      if (typeof fref === 'object' && fref.mrel) lines.push(`2 _MREL ${fref.mrel}`);
    }
    for (const f of p.fams) lines.push(`1 FAMS ${f}`);
    for (const m of p.media) {
      lines.push(`1 OBJE`);
      if (m.file)  lines.push(`2 FILE ${m.file}`);
      if (m.title) lines.push(`3 TITL ${m.title}`);
    }
    if (p.uid) lines.push(`1 _UID ${p.uid}`);
    if (p.lastChanged) {
      lines.push(`1 CHAN`);
      lines.push(`2 DATE ${p.lastChanged}`);
    }
  }

  for (const f of Object.values(db.families)) {
    lines.push(`0 ${f.id} FAM`);
    if (f.husb) lines.push(`1 HUSB ${f.husb}`);
    if (f.wife) lines.push(`1 WIFE ${f.wife}`);
    for (const c of f.children) lines.push(`1 CHIL ${c}`);
    eventBlock('MARR', f.marr, 1);
    if (f.engag && (f.engag.date || f.engag.place)) {
      lines.push(`1 ENGA`);
      if (f.engag.date)  lines.push(`2 DATE ${f.engag.date}`);
      if (f.engag.place) lines.push(`2 PLAC ${f.engag.place}`);
    }
    if (f.noteText) {
      const noteLines = f.noteText.split('\n');
      lines.push(`1 NOTE ${noteLines[0]}`);
      for (let i = 1; i < noteLines.length; i++) lines.push(`2 CONT ${noteLines[i]}`);
    }
  }

  for (const s of Object.values(db.sources)) {
    lines.push(`0 ${s.id} SOUR`);
    if (s.abbr)   lines.push(`1 ABBR ${s.abbr}`);
    if (s.title)  lines.push(`1 TITL ${s.title}`);
    if (s.author) lines.push(`1 AUTH ${s.author}`);
    if (s.date)   lines.push(`1 DATE ${s.date}`);
    if (s.publ)   lines.push(`1 PUBL ${s.publ}`);
    if (s.repo)   lines.push(`1 REPO ${s.repo}`);
    if (s.text)   lines.push(`1 TEXT ${s.text}`);
  }

  lines.push('0 TRLR');
  return lines.join('\r\n');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  INDEXEDDB HELPERS (fÃ¼r Dir-Handle)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _idb = null;
function _getIDB() {
  if (_idb) return Promise.resolve(_idb);
  return new Promise((res, rej) => {
    const r = indexedDB.open('stammbaum_app', 1);
    r.onupgradeneeded = e => e.target.result.createObjectStore('kv');
    r.onsuccess = e => { _idb = e.target.result; res(_idb); };
    r.onerror = rej;
  });
}
function idbGet(key) {
  return _getIDB().then(d => new Promise((res, rej) => {
    const r = d.transaction('kv','readonly').objectStore('kv').get(key);
    r.onsuccess = e => res(e.target.result); r.onerror = rej;
  }));
}
function idbPut(key, val) {
  return _getIDB().then(d => new Promise((res, rej) => {
    const r = d.transaction('kv','readwrite').objectStore('kv').put(val, key);
    r.onsuccess = () => res(); r.onerror = rej;
  }));
}
function idbDel(key) {
  return _getIDB().then(d => new Promise((res, rej) => {
    const r = d.transaction('kv','readwrite').objectStore('kv').delete(key);
    r.onsuccess = () => res(); r.onerror = rej;
  }));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FILE SYSTEM ACCESS (Desktop-Speichern)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDirMenuBtn() {
  const btn = document.getElementById('dirMenuBtn');
  if (!btn || !('showDirectoryPicker' in window)) return;
  btn.style.display = '';
  document.getElementById('dirMenuLabel').textContent =
    _dirHandle ? `Speicher-Verzeichnis: ${_dirHandle.name}` : 'Speicher-Verzeichnis wÃ¤hlen';
}

async function restoreDirHandle() {
  if (!('showDirectoryPicker' in window)) return;
  try {
    const h = await idbGet('dirHandle');
    if (!h) return;
    const perm = await h.queryPermission({ mode: 'readwrite' });
    if (perm === 'granted') { _dirHandle = h; updateDirMenuBtn(); }
  } catch(e) {}
}

async function pickSaveDir() {
  if (!('showDirectoryPicker' in window)) return;
  try {
    _dirHandle = await window.showDirectoryPicker({ mode: 'readwrite', startIn: 'documents' });
    await idbPut('dirHandle', _dirHandle);
    updateDirMenuBtn();
    showToast('âœ“ Verzeichnis: ' + _dirHandle.name);
  } catch(e) {
    if (e.name !== 'AbortError') showToast('âš  Kein Verzeichnis gewÃ¤hlt');
  }
}

async function saveToDirectory() {
  const gedText  = writeGEDCOM();
  const filename = localStorage.getItem('stammbaum_filename') || 'stammbaum.ged';
  const basename = filename.replace(/\.ged$/i, '');

  // Verzeichnis holen (einmalig wÃ¤hlen)
  if (!_dirHandle) {
    try {
      _dirHandle = await window.showDirectoryPicker({ mode: 'readwrite', startIn: 'documents' });
      await idbPut('dirHandle', _dirHandle);
      updateDirMenuBtn();
    } catch(e) {
      if (e.name !== 'AbortError') showToast('âš  Kein Verzeichnis gewÃ¤hlt');
      return false;
    }
  }

  // Schreibrecht sicherstellen
  let perm = await _dirHandle.queryPermission({ mode: 'readwrite' });
  if (perm === 'prompt') perm = await _dirHandle.requestPermission({ mode: 'readwrite' });
  if (perm !== 'granted') {
    _dirHandle = null; await idbDel('dirHandle'); updateDirMenuBtn();
    showToast('âš  Kein Schreibzugriff â€“ bitte Verzeichnis neu wÃ¤hlen');
    return false;
  }

  try {
    // 1. Hauptdatei Ã¼berschreiben
    const mainHandle = await _dirHandle.getFileHandle(filename, { create: true });
    const mainWriter = await mainHandle.createWritable();
    await mainWriter.write(gedText);
    await mainWriter.close();

    // 2. backup/-Unterordner anlegen
    const backupDir = await _dirHandle.getDirectoryHandle('backup', { create: true });

    // 3. NÃ¤chste Versionsnummer ermitteln
    const today  = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    const prefix = `${basename}_${today}_`;
    let n = 1;
    for await (const name of backupDir.keys()) {
      if (name.startsWith(prefix) && name.endsWith('.ged')) n++;
    }
    const backupName = `${prefix}${String(n).padStart(3, '0')}.ged`;

    // 4. Versioniertes Backup schreiben
    const backupHandle = await backupDir.getFileHandle(backupName, { create: true });
    const backupWriter = await backupHandle.createWritable();
    await backupWriter.write(gedText);
    await backupWriter.close();

    // 5. State
    try { localStorage.setItem('stammbaum_ged', gedText); } catch(e) {}
    changed = false; updateChangedIndicator();
    showToast(`âœ“ ${filename} Â· Backup: backup/${backupName}`);
    return true;
  } catch(e) {
    showToast('âš  Fehler: ' + e.message);
    return false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  EXPORT / DOWNLOAD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportGEDCOM() {
  // Desktop mit File System Access API â†’ direkt ins Verzeichnis
  if ('showDirectoryPicker' in window) {
    saveToDirectory();
    return;
  }

  // iOS / Fallback
  const content  = writeGEDCOM();
  const filename = localStorage.getItem('stammbaum_filename') || 'stammbaum.ged';
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

  if (isIOS && navigator.canShare) {
    const basename   = filename.replace(/\.ged$/i, '');
    const now        = new Date();
    const today      = now.toISOString().slice(0, 10);
    const time       = now.toTimeString().slice(0, 8).replace(/:/g, '');
    const backupName = `${basename}_${today}_${time}.ged`;
    const mainFile   = new File([content], filename,   { type: 'text/plain' });
    const backupFile = new File([content], backupName, { type: 'text/plain' });
    if (navigator.canShare({ files: [mainFile] })) {
      navigator.share({ files: [mainFile, backupFile], title: filename })
        .then(() => { changed = false; updateChangedIndicator(); showToast('âœ“ Gespeichert'); })
        .catch(err => { if (err.name !== 'AbortError') showToast('âš  Fehler beim Teilen'); });
      return;
    }
  }

  // Download-Fallback
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = filename; a.style.display = 'none';
  document.body.appendChild(a); a.click();
  setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 200);
  changed = false; updateChangedIndicator();
  try { localStorage.setItem('stammbaum_ged', content); } catch(e) {}
  showToast('âœ“ Datei heruntergeladen');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FILE LOADING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('uploadBox').addEventListener('click', () => document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change', e => {
  if (e.target.files[0]) readFile(e.target.files[0]);
});
document.getElementById('uploadBox').addEventListener('dragover', e => {
  e.preventDefault(); e.currentTarget.classList.add('drag');
});
document.getElementById('uploadBox').addEventListener('dragleave', e => e.currentTarget.classList.remove('drag'));
document.getElementById('uploadBox').addEventListener('drop', e => {
  e.preventDefault(); e.currentTarget.classList.remove('drag');
  if (e.dataTransfer.files[0]) readFile(e.dataTransfer.files[0]);
});

document.getElementById('fileInput2').addEventListener('change', e => {
  if (e.target.files[0]) readFile(e.target.files[0]);
});

function confirmNewFile() {
  if (changed) {
    if (!confirm('Sie haben ungespeicherte Ã„nderungen. Trotzdem fortfahren?')) return;
  }
  db = { individuals: {}, families: {}, sources: {} };
  changed = false;
  updateChangedIndicator();
  _originalGedText = null;
  try {
    localStorage.removeItem('stammbaum_ged'); localStorage.removeItem('stammbaum_filename');
    localStorage.removeItem('stammbaum_ged_backup'); localStorage.removeItem('stammbaum_backup_filename'); localStorage.removeItem('stammbaum_backup_date');
  } catch(e) {}
  updateBackupBtn();
  showView('v-landing');
}

function readFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    try {
      db = parseGEDCOM(e.target.result);
      _originalGedText = e.target.result;
      const backupDate = new Date().toLocaleDateString('de-DE');
      try {
        localStorage.setItem('stammbaum_ged', e.target.result);
        localStorage.setItem('stammbaum_filename', file.name);
        localStorage.setItem('stammbaum_ged_backup', e.target.result);
        localStorage.setItem('stammbaum_backup_filename', file.name);
        localStorage.setItem('stammbaum_backup_date', backupDate);
      } catch(e) { /* storage full â€“ ignore */ }
      updateBackupBtn();
      showMain(); showToast('âœ“ ' + file.name + ' geladen');
    } catch(err) { showToast('âš  Fehler beim Laden'); }
  };
  reader.readAsText(file, 'UTF-8');
}

function loadDemo() {
  const demo = `0 HEAD\n1 SOUR Demo\n1 GEDC\n2 VERS 5.5.1\n1 CHAR UTF-8\n0 @I001@ INDI\n1 NAME Johann /MÃ¼ller/\n1 SEX M\n1 BIRT\n2 DATE 12 MAR 1845\n2 PLAC MÃ¼nchen, Bayern\n1 DEAT\n2 DATE 3 NOV 1912\n2 PLAC MÃ¼nchen, Bayern\n1 OCCU BÃ¤ckermeister\n1 FAMS @F001@\n0 @I002@ INDI\n1 NAME Maria /Huber/\n1 SEX F\n1 BIRT\n2 DATE 5 JUN 1850\n2 PLAC Augsburg, Bayern\n1 DEAT\n2 DATE 20 FEB 1930\n2 PLAC MÃ¼nchen, Bayern\n1 FAMS @F001@\n0 @I003@ INDI\n1 NAME Heinrich /MÃ¼ller/\n1 SEX M\n1 BIRT\n2 DATE 8 JAN 1872\n2 PLAC MÃ¼nchen, Bayern\n1 DEAT\n2 DATE 15 APR 1940\n2 PLAC MÃ¼nchen, Bayern\n1 OCCU Kaufmann\n1 FAMC @F001@\n1 FAMS @F002@\n0 @I004@ INDI\n1 NAME Anna /Schmidt/\n1 SEX F\n1 BIRT\n2 DATE 22 SEP 1875\n2 PLAC NÃ¼rnberg, Bayern\n1 FAMS @F002@\n0 @I005@ INDI\n1 NAME Karl /MÃ¼ller/\n1 SEX M\n1 BIRT\n2 DATE 14 JUL 1900\n2 PLAC MÃ¼nchen, Bayern\n1 FAMC @F002@\n0 @I006@ INDI\n1 NAME Elisabeth /MÃ¼ller/\n1 SEX F\n1 BIRT\n2 DATE 3 MAR 1903\n2 PLAC MÃ¼nchen, Bayern\n1 FAMC @F002@\n0 @S001@ SOUR\n1 TITL Kirchenbuch MÃ¼nchen St. Peter\n1 AUTH Stadtarchiv MÃ¼nchen\n1 DATE 1845-1912\n0 @F001@ FAM\n1 HUSB @I001@\n1 WIFE @I002@\n1 CHIL @I003@\n1 MARR\n2 DATE 10 JUN 1870\n2 PLAC MÃ¼nchen, Bayern\n0 @F002@ FAM\n1 HUSB @I003@\n1 WIFE @I004@\n1 CHIL @I005@\n1 CHIL @I006@\n1 MARR\n2 DATE 5 APR 1898\n2 PLAC MÃ¼nchen, Bayern\n0 TRLR`;
  db = parseGEDCOM(demo);
  showMain(); showToast('âœ“ Demo geladen');
}

// Auto-load last file from localStorage on startup
function tryAutoLoad() {
  try {
    const saved = localStorage.getItem('stammbaum_ged');
    const fname = localStorage.getItem('stammbaum_filename') || 'gespeicherte Datei';
    if (saved && saved.length > 10) {
      db = parseGEDCOM(saved);
      _originalGedText = localStorage.getItem('stammbaum_ged_backup') || saved;
      showMain();
      updateBackupBtn();
      showToast('âœ“ ' + fname + ' automatisch geladen');
      return true;
    }
  } catch(e) { /* no storage or parse error */ }
  return false;
}
window.addEventListener('load', () => { tryAutoLoad(); restoreDirHandle(); updateDirMenuBtn(); });

function updateBackupBtn() {
  const btn = document.getElementById('backupMenuBtn');
  if (!btn) return;
  const fname = localStorage.getItem('stammbaum_backup_filename') || '';
  const date  = localStorage.getItem('stammbaum_backup_date') || '';
  const hasBackup = !!(_originalGedText || localStorage.getItem('stammbaum_ged_backup'));
  btn.style.opacity = hasBackup ? '1' : '0.4';
  btn.querySelector('span').textContent = hasBackup
    ? `Original-Backup herunterladen${date ? ' (' + date + ')' : ''}`
    : 'Original-Backup (keines vorhanden)';
}

function downloadBackup() {
  const backup = _originalGedText || localStorage.getItem('stammbaum_ged_backup');
  if (!backup) { showToast('âš  Kein Backup vorhanden'); return; }
  const fname = localStorage.getItem('stammbaum_backup_filename') || 'stammbaum.ged';
  const backupName = fname.replace(/\.ged$/i, '') + '_original.ged';
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  if (isIOS && navigator.canShare) {
    const file = new File([backup], backupName, { type: 'text/plain' });
    if (navigator.canShare({ files: [file] })) {
      navigator.share({ files: [file], title: backupName }).catch(() => {});
      return;
    }
  }
  const blob = new Blob([backup], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = backupName; a.style.display = 'none';
  document.body.appendChild(a); a.click();
  setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 200);
  showToast('âœ“ Original-Backup heruntergeladen');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  NAVIGATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
}

function showMain() {
  showView('v-main');
  updateStats();
  renderTab();
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', ['persons','families','sources','places'][i] === tab);
  });
  document.getElementById('tab-persons').style.display = tab === 'persons' ? 'block' : 'none';
  document.getElementById('tab-families').style.display = tab === 'families' ? 'block' : 'none';
  document.getElementById('tab-sources').style.display = tab === 'sources' ? 'block' : 'none';
  document.getElementById('tab-places').style.display = tab === 'places' ? 'block' : 'none';
  renderTab();
}

function renderTab() {
  if (currentTab === 'persons') renderPersonList(Object.values(db.individuals));
  else if (currentTab === 'families') renderFamilyList();
  else if (currentTab === 'sources') renderSourceList();
  else if (currentTab === 'places') renderPlaceList();
}

function updateStats() {
  const persons = Object.values(db.individuals);
  const families = Object.values(db.families);
  let events = 0;
  persons.forEach(p => {
    if (p.birth.date || p.birth.place) events++;
    if (p.death.date || p.death.place) events++;
    events += p.events.length;
  });
  families.forEach(f => { if (f.marr.date || f.marr.place) events++; });
  document.getElementById('sPersons').textContent = persons.length;
  document.getElementById('sFamilies').textContent = families.length;
  document.getElementById('sEvents').textContent = events;
  document.getElementById('sSources').textContent = Object.keys(db.sources).length;
}

function updateChangedIndicator() {
  document.getElementById('changedIndicator').style.display = changed ? 'inline-block' : 'none';
}

function markChanged() { changed = true; updateChangedIndicator(); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PERSON LIST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPersonList(persons) {
  const sorted = [...persons].sort((a, b) =>
    (a.surname || a.given || a.name || '').localeCompare(b.surname || b.given || b.name || '', 'de')
  );
  const list = document.getElementById('personList');
  if (!sorted.length) { list.innerHTML = '<div class="empty">Noch keine Personen</div>'; return; }

  let html = '', lastLetter = '';
  for (const p of sorted) {
    const fl = (p.surname || p.given || p.name || '?')[0].toUpperCase();
    if (fl !== lastLetter) { html += `<div class="alpha-sep">${fl}</div>`; lastLetter = fl; }
    const sc = p.sex === 'M' ? 'm' : p.sex === 'F' ? 'f' : '';
    const ic = p.sex === 'M' ? 'â™‚' : p.sex === 'F' ? 'â™€' : 'â—‡';
    let meta = '';
    if (p.birth.date) meta += '* ' + p.birth.date;
    if (p.birth.place) meta += (meta ? ', ' : '') + p.birth.place;
    if (p.death.date) meta += (meta ? '  â€  ' : 'â€  ') + p.death.date;
    html += `<div class="person-row" onclick="showDetail('${p.id}')">
      <div class="p-avatar ${sc}">${ic}</div>
      <div class="p-info">
        <div class="p-name">${esc(p.name || p.id)}</div>
        <div class="p-meta">${esc(meta) || '&nbsp;'}</div>
      </div>
      <span class="p-arrow">â€º</span>
    </div>`;
  }
  list.innerHTML = html;
}

function filterPersons(q) {
  const lower = q.toLowerCase().trim();
  const all = Object.values(db.individuals);
  if (!lower) { renderPersonList(all); return; }

  renderPersonList(all.filter(p => {
    // Name
    if ((p.name||'').toLowerCase().includes(lower)) return true;
    if ((p.surname||'').toLowerCase().includes(lower)) return true;
    if ((p.given||'').toLowerCase().includes(lower)) return true;
    if ((p.prefix||'').toLowerCase().includes(lower)) return true;
    if ((p.titl||'').toLowerCase().includes(lower)) return true;
    // Birth / death / burial / chr
    if ((p.birth.date||'').toLowerCase().includes(lower)) return true;
    if ((p.birth.place||'').toLowerCase().includes(lower)) return true;
    if ((p.death.date||'').toLowerCase().includes(lower)) return true;
    if ((p.death.place||'').toLowerCase().includes(lower)) return true;
    if ((p.chr.place||'').toLowerCase().includes(lower)) return true;
    if ((p.buri.place||'').toLowerCase().includes(lower)) return true;
    // Events: value, place, date, eventType
    for (const ev of p.events) {
      if ((ev.value||'').toLowerCase().includes(lower)) return true;
      if ((ev.place||'').toLowerCase().includes(lower)) return true;
      if ((ev.date||'').toLowerCase().includes(lower)) return true;
      if ((ev.eventType||'').toLowerCase().includes(lower)) return true;
    }
    // Notes
    if ((p.noteText||'').toLowerCase().includes(lower)) return true;
    // Religion
    if ((p.reli||'').toLowerCase().includes(lower)) return true;
    return false;
  }));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FAMILY LIST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFamilyList() {
  const el = document.getElementById('tab-families');
  const fams = Object.values(db.families);
  if (!fams.length) { el.innerHTML = '<div class="empty">Noch keine Familien</div>'; return; }

  let html = '';
  for (const f of fams) {
    const husb = f.husb ? db.individuals[f.husb] : null;
    const wife = f.wife ? db.individuals[f.wife] : null;
    const title = [husb?.name, wife?.name].filter(Boolean).join(' & ') || f.id;
    let meta = '';
    if (f.marr.date) meta += 'âš­ ' + f.marr.date;
    if (f.marr.place) meta += (meta ? ', ' : 'âš­ ') + f.marr.place;
    if (f.children.length) meta += (meta ? '  ' : '') + f.children.length + ' Kind' + (f.children.length > 1 ? 'er' : '');
    html += `<div class="person-row" onclick="showFamilyDetail('${f.id}')">
      <div class="p-avatar">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
      <div class="p-info">
        <div class="p-name">${esc(title)}</div>
        <div class="p-meta">${esc(meta) || '&nbsp;'}</div>
      </div>
      <span class="p-arrow">â€º</span>
    </div>`;
  }
  el.innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SOURCE LIST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSourceList() {
  const el = document.getElementById('tab-sources');
  const srcs = Object.values(db.sources);
  if (!srcs.length) { el.innerHTML = '<div class="empty">Noch keine Quellen</div>'; return; }

  let html = '';
  for (const s of srcs) {
    const refCount = Object.values(db.individuals).filter(p => p.sourceRefs && p.sourceRefs.has(s.id)).length
                   + Object.values(db.families).filter(f => f.sourceRefs && f.sourceRefs.has(s.id)).length;
    html += `<div class="source-card" onclick="showSourceDetail('${s.id}')">
      <div class="source-title">${esc(s.abbr || s.title || s.id)}</div>
      <div class="source-meta">${esc([s.author, s.date].filter(Boolean).join(' Â· ')) || '&nbsp;'}${refCount ? ` Â· ${refCount} Ref.` : ''}</div>
    </div>`;
  }
  el.innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PLACE LIST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function collectPlaces() {
  const places = new Map();

  function addPlace(placeName, personId, eventType, lati, long) {
    if (!placeName || !placeName.trim()) return;
    const key = placeName.trim();
    if (!places.has(key)) places.set(key, { name: key, personIds: new Set(), eventTypes: new Set(), lati: null, long: null });
    const pl = places.get(key);
    if (personId) pl.personIds.add(personId);
    if (eventType) pl.eventTypes.add(eventType);
    // Store first found geo coords
    if (pl.lati === null && lati !== null && lati !== undefined) { pl.lati = lati; pl.long = long; }
  }

  for (const p of Object.values(db.individuals)) {
    addPlace(p.birth.place, p.id, 'Geburt', p.birth.lati, p.birth.long);
    addPlace(p.death.place, p.id, 'Tod', p.death.lati, p.death.long);
    addPlace(p.chr.place,   p.id, 'Taufe', null, null);
    addPlace(p.buri.place,  p.id, 'Beerdigung', p.buri.lati, p.buri.long);
    for (const ev of p.events) addPlace(ev.place, p.id, ev.eventType || ev.type, ev.lati, ev.long);
  }
  for (const f of Object.values(db.families)) {
    addPlace(f.marr.place, f.husb, 'Heirat', f.marr.lati, f.marr.long);
    addPlace(f.marr.place, f.wife, 'Heirat', f.marr.lati, f.marr.long);
  }
  return places;
}

function renderPlaceList() {
  const el = document.getElementById('tab-places');
  const places = collectPlaces();

  if (!places.size) {
    el.innerHTML = '<div class="empty">Keine Orte in den Daten gefunden</div>';
    return;
  }

  const sorted = [...places.values()].sort((a, b) => a.name.localeCompare(b.name, 'de'));
  let html = '';
  let lastLetter = '';

  for (const place of sorted) {
    const fl = place.name[0].toUpperCase();
    if (fl !== lastLetter) { html += `<div class="alpha-sep">${fl}</div>`; lastLetter = fl; }
    const count = place.personIds.size;
    const hasGeo = place.lati !== null;
    const geoIcon = hasGeo ? 'ğŸ“' : 'Â·';
    html += `<div class="person-row" onclick="showPlaceDetail('${esc(place.name)}')">
      <div class="p-avatar" style="font-size:1.1rem">${geoIcon}</div>
      <div class="p-info">
        <div class="p-name">${esc(place.name)}</div>
        <div class="p-meta">${count} Person${count !== 1 ? 'en' : ''}${hasGeo ? ' Â· Karte verfÃ¼gbar' : ''}</div>
      </div>
      <span class="p-arrow">â€º</span>
    </div>`;
  }
  el.innerHTML = html;
}

function showPlaceForm(placeName) {
  document.getElementById('pl-old').value  = placeName;
  document.getElementById('pl-name').value = placeName;
  openModal('modalPlace');
}

function savePlace() {
  const oldName = document.getElementById('pl-old').value;
  const newName = document.getElementById('pl-name').value.trim();
  if (!newName) { showToast('âš  Ortsname darf nicht leer sein'); return; }
  closeModal('modalPlace');
  if (newName === oldName) return;
  for (const p of Object.values(db.individuals)) {
    if (p.birth.place  === oldName) p.birth.place  = newName;
    if (p.chr.place    === oldName) p.chr.place    = newName;
    if (p.death.place  === oldName) p.death.place  = newName;
    if (p.buri.place   === oldName) p.buri.place   = newName;
    for (const ev of p.events) if (ev.place === oldName) ev.place = newName;
  }
  for (const f of Object.values(db.families)) {
    if (f.marr.place        === oldName) f.marr.place        = newName;
    if (f.engag?.place      === oldName) f.engag.place       = newName;
  }
  markChanged();
  showToast('âœ“ Ort umbenannt');
  showPlaceDetail(newName);
}

function showPlaceDetail(placeName) {
  const places = collectPlaces();
  const place = places.get(placeName);
  if (!place) return;

  currentPersonId = null; currentFamilyId = null; currentSourceId = null;
  document.getElementById('detailTopTitle').textContent = 'ğŸ“ Ort';
  document.getElementById('editBtn').style.display = '';
  document.getElementById('editBtn').onclick = () => showPlaceForm(placeName);

  let html = `<div class="detail-hero fade-up">
    <div class="detail-avatar" style="font-size:1.8rem; border-color:var(--gold-dim)">ğŸ“</div>
    <div class="detail-name">${esc(placeName)}</div>
    <div class="detail-id">${place.personIds.size} Person${place.personIds.size !== 1 ? 'en' : ''}</div>
  </div>`;

  // Map link if geo available
  if (place.lati !== null) {
    html += `<div class="section fade-up">
      <div class="section-title">Standort</div>
      <a href="https://maps.apple.com/?ll=${place.lati},${place.long}&q=${encodeURIComponent(placeName)}"
         target="_blank"
         style="display:flex;align-items:center;gap:10px;padding:10px 0;color:var(--gold);text-decoration:none;font-size:0.9rem">
        ğŸ—º In Apple Maps Ã¶ffnen
        <span style="font-size:0.75rem;color:var(--text-muted)">${place.lati.toFixed(4)}, ${place.long.toFixed(4)}</span>
      </a>
    </div>`;
  }

  // Build detailed list: person + which event connects them to this place
  const evLabels = { Geburt:'Geburt', Tod:'Tod', Taufe:'Taufe', Beerdigung:'Beerdigung', Heirat:'Heirat', OCCU:'Beruf', RESI:'Wohnort', EDUC:'Bildung', RELI:'Religion', EMIG:'Auswanderung', IMMI:'Einwanderung', EVEN:'Ereignis' };
  const entries = [];
  for (const p of Object.values(db.individuals)) {
    if (p.birth.place && p.birth.place.trim() === placeName)
      entries.push({ person: p, role: 'Geburt' + (p.birth.date ? ' Â· ' + p.birth.date : '') });
    if (p.death.place && p.death.place.trim() === placeName)
      entries.push({ person: p, role: 'Tod' + (p.death.date ? ' Â· ' + p.death.date : '') });
    if (p.chr.place && p.chr.place.trim() === placeName)
      entries.push({ person: p, role: 'Taufe' + (p.chr.date ? ' Â· ' + p.chr.date : '') });
    if (p.buri.place && p.buri.place.trim() === placeName)
      entries.push({ person: p, role: 'Beerdigung' + (p.buri.date ? ' Â· ' + p.buri.date : '') });
    for (const ev of p.events) {
      if (ev.place && ev.place.trim() === placeName)
        entries.push({ person: p, role: (ev.eventType || evLabels[ev.type] || ev.type) + (ev.date ? ' Â· ' + ev.date : '') });
    }
  }
  for (const f of Object.values(db.families)) {
    if (f.marr.place && f.marr.place.trim() === placeName) {
      for (const pid of [f.husb, f.wife]) {
        if (!pid) continue;
        const p = db.individuals[pid];
        if (p) entries.push({ person: p, role: 'Heirat' + (f.marr.date ? ' Â· ' + f.marr.date : '') });
      }
    }
  }

  entries.sort((a, b) => (a.person.name || '').localeCompare(b.person.name || '', 'de'));

  html += `<div class="section fade-up">
    <div class="section-title">Personen an diesem Ort</div>`;
  for (const e of entries) {
    html += relRow(e.person, e.role);
  }
  html += `</div>`;

  document.getElementById('detailContent').innerHTML = html;
  showView('v-detail');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DETAIL: PERSON
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDetail(id) {
  const p = db.individuals[id];
  if (!p) return;
  currentPersonId = id;
  currentFamilyId = null;
  currentSourceId = null;

  document.getElementById('detailTopTitle').textContent = p.name || id;
  document.getElementById('editBtn').style.display = '';
  document.getElementById('editBtn').onclick = () => showPersonForm(id);

  const sc = p.sex === 'M' ? 'm' : p.sex === 'F' ? 'f' : '';
  const ic = p.sex === 'M' ? 'â™‚' : p.sex === 'F' ? 'â™€' : 'â—‡';

  const fullName = [p.prefix, p.name].filter(Boolean).join(' ');

  let html = `<div class="detail-hero fade-up">
    <div class="detail-avatar ${sc}">${ic}</div>
    <div class="detail-name">${esc(fullName || id)}</div>
    <div class="detail-id">${id}${p.lastChanged ? ' Â· geÃ¤ndert ' + p.lastChanged : ''}</div>
  </div>`;

  // Life data
  html += `<div class="section fade-up">
    <div class="section-head">
      <div class="section-title">Lebensdaten</div>
      <button class="section-add" onclick="showEventForm('${id}')">+ Ereignis</button>
    </div>`;

  if (p.birth.date || p.birth.place) {
    const geoBtn = (p.birth.lati !== null && p.birth.lati !== undefined)
      ? `<a href="https://maps.apple.com/?ll=${p.birth.lati},${p.birth.long}" target="_blank" style="color:var(--gold-dim);font-size:0.75rem;text-decoration:none;margin-left:5px">ğŸ“</a>` : '';
    html += `<div class="fact-row" onclick="showEventForm('${id}','BIRT')" style="cursor:pointer"><span class="fact-lbl">Geburt</span><span class="fact-val">${esc([p.birth.date, p.birth.place].filter(Boolean).join(', '))}${geoBtn}</span></div>`;
    html += sourceTagsHtml(p.birth.sources);
  }
  if (p.chr.date || p.chr.place) {
    html += `<div class="fact-row" onclick="showEventForm('${id}','CHR')" style="cursor:pointer"><span class="fact-lbl">Taufe</span><span class="fact-val">${esc([p.chr.date, p.chr.place].filter(Boolean).join(', '))}</span></div>`;
    html += sourceTagsHtml(p.chr.sources);
  }
  if (p.death.date || p.death.place) {
    const geoBtn = (p.death.lati !== null && p.death.lati !== undefined)
      ? `<a href="https://maps.apple.com/?ll=${p.death.lati},${p.death.long}" target="_blank" style="color:var(--gold-dim);font-size:0.75rem;text-decoration:none;margin-left:5px">ğŸ“</a>` : '';
    html += `<div class="fact-row" onclick="showEventForm('${id}','DEAT')" style="cursor:pointer"><span class="fact-lbl">Tod</span><span class="fact-val">${esc([p.death.date, p.death.place, p.death.cause].filter(Boolean).join(', '))}${geoBtn}</span></div>`;
    html += sourceTagsHtml(p.death.sources);
  }
  if (p.buri.date || p.buri.place) {
    const geoBtn = (p.buri.lati !== null && p.buri.lati !== undefined)
      ? `<a href="https://maps.apple.com/?ll=${p.buri.lati},${p.buri.long}" target="_blank" style="color:var(--gold-dim);font-size:0.75rem;text-decoration:none;margin-left:5px">ğŸ“</a>` : '';
    html += `<div class="fact-row" onclick="showEventForm('${id}','BURI')" style="cursor:pointer"><span class="fact-lbl">Beerdigung</span><span class="fact-val">${esc([p.buri.date, p.buri.place].filter(Boolean).join(', '))}${geoBtn}</span></div>`;
    html += sourceTagsHtml(p.buri.sources);
  }

  const evLabels = { OCCU:'Beruf', RESI:'Wohnort', EDUC:'Bildung', RELI:'Religion',
    EMIG:'Auswanderung', IMMI:'Einwanderung', NATU:'EinbÃ¼rgerung', EVEN:'Ereignis',
    GRAD:'Abschluss', ADOP:'Adoption', TITL:'Titel' };
  p.events.forEach((ev, idx) => {
    const label = ev.eventType || evLabels[ev.type] || ev.type;
    const geoBtn = (ev.lati !== null && ev.lati !== undefined)
      ? `<a href="https://maps.apple.com/?ll=${ev.lati},${ev.long}" target="_blank" style="color:var(--gold-dim);font-size:0.75rem;text-decoration:none;margin-left:5px">ğŸ“</a>` : '';
    const parts = [ev.value, ev.date, ev.place].filter(Boolean).join(', ');
    html += `<div class="fact-row" onclick="showEventForm('${id}',${idx})" style="cursor:pointer">
      <span class="fact-lbl">${esc(label)}</span>
      <span class="fact-val">${esc(parts)}${geoBtn}</span>
    </div>`;
    html += sourceTagsHtml(ev.sources || []);
  });

  if (p.titl) html += factRow('Titel', p.titl);
  if (p.reli) html += factRow('Religion', p.reli);

  if (!p.birth.date && !p.death.date && !p.events.length && !p.chr.date && !p.buri.date)
    html += `<div style="color:var(--text-muted);font-style:italic;font-size:0.85rem">Keine Lebensdaten eingetragen</div>`;

  html += `</div>`;

  // Notes
  if (p.noteText) {
    html += `<div class="section fade-up"><div class="section-title">Notizen</div>
      <div style="font-size:0.88rem;color:var(--text-dim);line-height:1.6;white-space:pre-wrap">${esc(p.noteText)}</div>
    </div>`;
  }

  // Media
  if (p.media && p.media.length) {
    html += `<div class="section fade-up"><div class="section-title">Medien (${p.media.length})</div>`;
    for (const m of p.media) {
      const fname = m.file ? m.file.split(/[\\/]/).pop() : 'â€“';
      html += `<div class="fact-row">
        <span class="fact-lbl">ğŸ“·</span>
        <span class="fact-val" style="font-size:0.82rem">${esc(m.title || fname)}</span>
      </div>`;
    }
    html += `</div>`;
  }

  // As spouse
  if (p.fams.length) {
    html += `<div class="section fade-up">
      <div class="section-head"><div class="section-title">Ehepartner &amp; Kinder</div></div>`;
    for (const famId of p.fams) {
      const fam = db.families[famId];
      if (!fam) continue;
      const partnerId = p.sex === 'M' ? fam.wife : fam.husb;
      const partner = partnerId ? db.individuals[partnerId] : null;
      if (partner) html += relRow(partner, 'Ehepartner' + (fam.marr.date ? ' Â· ' + fam.marr.date : ''));
      for (const cid of fam.children) {
        const child = db.individuals[cid];
        if (child) html += relRow(child, 'Kind' + (child.birth.date ? ' Â· * ' + child.birth.date : ''));
      }
    }
    html += `</div>`;
  }

  // Parents
  if (p.famc.length) {
    html += `<div class="section fade-up"><div class="section-head"><div class="section-title">Eltern</div></div>`;
    for (const fref of p.famc) {
      const famId = typeof fref === 'string' ? fref : fref.famId;
      const fam = db.families[famId];
      if (!fam) continue;
      for (const pid of [fam.husb, fam.wife]) {
        if (!pid) continue;
        const parent = db.individuals[pid];
        if (parent) html += relRow(parent, parent.sex === 'M' ? 'Vater' : parent.sex === 'F' ? 'Mutter' : 'Elternteil');
      }
    }
    html += `</div>`;
  }

  document.getElementById('detailContent').innerHTML = html;
  showView('v-detail');
}

function showFamilyDetail(id) {
  const f = db.families[id];
  if (!f) return;
  currentFamilyId = id;
  currentPersonId = null;
  currentSourceId = null;

  const husb = f.husb ? db.individuals[f.husb] : null;
  const wife = f.wife ? db.individuals[f.wife] : null;
  const title = [husb?.name, wife?.name].filter(Boolean).join(' & ') || id;

  document.getElementById('detailTopTitle').textContent = 'Familie';
  document.getElementById('editBtn').style.display = '';
  document.getElementById('editBtn').onclick = () => showFamilyForm(id);

  let html = `<div class="detail-hero fade-up">
    <div class="detail-avatar" style="font-size:1.8rem">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
    <div class="detail-name">${esc(title)}</div>
    <div class="detail-id">${id}</div>
  </div>`;

  if (f.marr.date || f.marr.place) {
    html += `<div class="section fade-up"><div class="section-title">Heirat</div>`;
    if (f.marr.date) html += factRow('Datum', f.marr.date);
    if (f.marr.place) {
      const geoBtn = (f.marr.lati !== null && f.marr.lati !== undefined)
        ? `<a href="https://maps.apple.com/?ll=${f.marr.lati},${f.marr.long}" target="_blank" style="color:var(--gold-dim);font-size:0.75rem;text-decoration:none;margin-left:5px">ğŸ“</a>` : '';
      html += factRow('Ort', f.marr.place, geoBtn);
    }
    html += sourceTagsHtml(f.marr.sources || [...(f.sourceRefs||[])]);
    html += `</div>`;
  }

  html += `<div class="section fade-up"><div class="section-title">Mitglieder</div>`;
  if (husb) html += relRow(husb, 'Ehemann / Vater');
  if (wife) html += relRow(wife, 'Ehefrau / Mutter');
  for (const cid of f.children) {
    const child = db.individuals[cid];
    if (child) html += relRow(child, 'Kind');
  }
  html += `</div>`;

  document.getElementById('detailContent').innerHTML = html;
  showView('v-detail');
}

function showSourceDetail(id) {
  const s = db.sources[id];
  if (!s) return;
  currentSourceId = id;
  currentPersonId = null;
  currentFamilyId = null;

  document.getElementById('detailTopTitle').textContent = 'Quelle';
  document.getElementById('editBtn').style.display = '';
  document.getElementById('editBtn').onclick = () => showSourceForm(id);

  // Collect all persons and families referencing this source
  const refPersons = Object.values(db.individuals).filter(p => p.sourceRefs && p.sourceRefs.has(id));
  const refFamilies = Object.values(db.families).filter(f => f.sourceRefs && f.sourceRefs.has(id));

  let html = `<div class="detail-hero fade-up">
    <div class="detail-avatar" style="font-size:1.8rem">ğŸ“–</div>
    <div class="detail-name">${esc(s.abbr || s.title || id)}</div>
    <div class="detail-id">${id} Â· ${refPersons.length + refFamilies.length} Referenzen</div>
  </div>`;

  // Source details
  html += `<div class="section fade-up"><div class="section-title">Details</div>`;
  if (s.title && s.abbr && s.title !== s.abbr) html += factRow('Titel', s.title);
  if (s.author) html += factRow('Autor', s.author);
  if (s.publ)   html += factRow('Verlag', s.publ);
  if (s.date)   html += factRow('Datum', s.date);
  if (s.repo)   html += factRow('Aufbewahrung', s.repo);
  if (s.text)   html += factRow('Notiz', s.text);
  html += `</div>`;

  // Referencing persons
  if (refPersons.length) {
    const sorted = [...refPersons].sort((a, b) => (a.name||'').localeCompare(b.name||'', 'de'));
    html += `<div class="section fade-up">
      <div class="section-title">Personen (${refPersons.length})</div>`;
    for (const p of sorted) {
      let meta = '';
      if (p.birth.date) meta += '* ' + p.birth.date;
      if (p.death.date) meta += (meta ? '  â€  ' : 'â€  ') + p.death.date;
      html += relRow(p, meta || 'â€“');
    }
    html += `</div>`;
  }

  // Referencing families
  if (refFamilies.length) {
    html += `<div class="section fade-up">
      <div class="section-title">Familien (${refFamilies.length})</div>`;
    for (const f of refFamilies) {
      const husb = f.husb ? db.individuals[f.husb] : null;
      const wife = f.wife ? db.individuals[f.wife] : null;
      const title = [husb?.name, wife?.name].filter(Boolean).join(' & ') || f.id;
      const meta = f.marr.date ? 'âš­ ' + f.marr.date : '';
      html += `<div class="rel-row" onclick="showFamilyDetail('${f.id}')">
        <div class="rel-avatar" style="font-size:0.9rem">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
        <div class="rel-info">
          <div class="rel-name">${esc(title)}</div>
          <div class="rel-role">${esc(meta) || 'â€“'}</div>
        </div>
        <span class="p-arrow">â€º</span>
      </div>`;
    }
    html += `</div>`;
  }

  if (!refPersons.length && !refFamilies.length) {
    html += `<div class="section fade-up"><div class="empty" style="padding:16px 0">Keine Referenzen gefunden</div></div>`;
  }

  document.getElementById('detailContent').innerHTML = html;
  showView('v-detail');
}

function factRow(label, value, rawSuffix) {
  return `<div class="fact-row"><span class="fact-lbl">${esc(label)}</span><span class="fact-val">${esc(value)}${rawSuffix||''}</span></div>`;
}

// Render small source badge links for a list of source IDs
function sourceTagsHtml(sourceIds) {
  if (!sourceIds) return '';
  const ids = sourceIds instanceof Set ? [...sourceIds] : (Array.isArray(sourceIds) ? sourceIds : []);
  if (!ids.length) return '';
  const tags = ids.map(sid => {
    const s = db.sources[sid];
    if (!s) return '';
    const label = (s.abbr || s.title || sid).substring(0, 25);
    return `<span onclick="showSourceDetail('${sid}')" style="display:inline-block;background:var(--surface2);border:1px solid var(--gold-dim);border-radius:12px;padding:2px 8px;font-size:0.72rem;color:var(--gold-dim);cursor:pointer;margin:2px 3px 2px 0;font-family:'Source Serif 4',serif">ğŸ“– ${esc(label)}</span>`;
  }).filter(Boolean).join('');
  return tags ? `<div style="margin-top:4px">${tags}</div>` : '';
}

function relRow(person, role) {
  const sc = person.sex === 'M' ? 'm' : person.sex === 'F' ? 'f' : '';
  const ic = person.sex === 'M' ? 'â™‚' : person.sex === 'F' ? 'â™€' : 'â—‡';
  return `<div class="rel-row" onclick="showDetail('${person.id}')">
    <div class="rel-avatar ${sc}">${ic}</div>
    <div class="rel-info">
      <div class="rel-name">${esc(person.name || person.id)}</div>
      <div class="rel-role">${esc(role)}</div>
    </div>
    <span class="p-arrow">â€º</span>
  </div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SOURCE WIDGET
//  srcState[prefix] = Set of source IDs currently selected
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const srcState = {};

function initSrcWidget(prefix, selectedIds) {
  const ids = selectedIds instanceof Set ? [...selectedIds] : (Array.isArray(selectedIds) ? selectedIds : []);
  srcState[prefix] = new Set(ids);
  renderSrcTags(prefix);
  renderSrcPicker(prefix);
  document.getElementById(prefix + '-src-picker').classList.remove('open');
}

function renderSrcTags(prefix) {
  const container = document.getElementById(prefix + '-src-tags');
  const selected = srcState[prefix] || new Set();
  if (!selected.size) {
    container.innerHTML = '<span style="font-size:0.8rem;color:var(--text-muted);font-style:italic">Keine Quellen zugewiesen</span>';
    return;
  }
  container.innerHTML = [...selected].map(sid => {
    const s = db.sources[sid];
    const label = s ? (s.abbr || s.title || sid) : sid;
    return `<span class="src-tag">
      ${esc(label.length > 30 ? label.slice(0,28)+'â€¦' : label)}
      <button type="button" onclick="removeSrc('${prefix}','${sid}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;padding:0 0 0 4px;font-size:0.85rem">âœ•</button>
    </span>`;
  }).join('');
}

function renderSrcPicker(prefix) {
  const list = document.getElementById(prefix + '-src-list');
  const selected = srcState[prefix] || new Set();
  const srcs = Object.values(db.sources).sort((a,b) => (a.abbr||a.title||'').localeCompare(b.abbr||b.title||'','de'));
  if (!srcs.length) {
    list.innerHTML = '<div class="src-picker-empty">Noch keine Quellen vorhanden</div>';
    return;
  }
  list.innerHTML = srcs.map(s => {
    const label = s.abbr || s.title || s.id;
    const isSel = selected.has(s.id);
    return `<div class="src-picker-item ${isSel ? 'selected' : ''}" onclick="toggleSrc('${prefix}','${s.id}')">
      ${isSel ? 'âœ“ ' : ''}${esc(label)}
    </div>`;
  }).join('');
}

function toggleSrcPicker(prefix) {
  const picker = document.getElementById(prefix + '-src-picker');
  picker.classList.toggle('open');
  if (picker.classList.contains('open')) renderSrcPicker(prefix);
}

function toggleSrc(prefix, sid) {
  const set = srcState[prefix] || (srcState[prefix] = new Set());
  if (set.has(sid)) set.delete(sid); else set.add(sid);
  renderSrcTags(prefix);
  renderSrcPicker(prefix);
}

function removeSrc(prefix, sid) {
  if (srcState[prefix]) srcState[prefix].delete(sid);
  renderSrcTags(prefix);
  renderSrcPicker(prefix);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FORMS: PERSON
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAddSheet() { openModal('modalAdd'); }
function showEditSheet() {
  if (currentPersonId) showPersonForm(currentPersonId);
  else if (currentFamilyId) showFamilyForm(currentFamilyId);
  else if (currentSourceId) showSourceForm(currentSourceId);
}

function showPersonForm(id) {
  closeModal('modalAdd');
  const p = id ? db.individuals[id] : null;
  document.getElementById('personFormTitle').textContent = p ? 'Person bearbeiten' : 'Neue Person';
  document.getElementById('pf-id').value = id || '';
  document.getElementById('pf-given').value = p?.given || '';
  document.getElementById('pf-surname').value = p?.surname || '';
  document.getElementById('pf-sex').value = p?.sex || 'U';
  document.getElementById('pf-occu').value = p?.events?.find(e => e.type === 'OCCU')?.value || '';
  document.getElementById('pf-note').value = p?.noteText || '';
  document.getElementById('deletePersonBtn').style.display = p ? 'block' : 'none';
  initSrcWidget('pf', p?.sourceRefs || []);
  openModal('modalPerson');
}

function savePerson() {
  const id = document.getElementById('pf-id').value || nextId('I');
  const given = document.getElementById('pf-given').value.trim();
  const surname = document.getElementById('pf-surname').value.trim();
  const sex = document.getElementById('pf-sex').value;
  const occu = document.getElementById('pf-occu').value.trim();
  const note = document.getElementById('pf-note').value.trim();

  if (!given && !surname) { showToast('âš  Bitte Namen eingeben'); return; }

  const existing = db.individuals[id] || {};
  const events = existing.events ? existing.events.filter(e => e.type !== 'OCCU') : [];
  if (occu) events.unshift({ type: 'OCCU', value: occu, date: '', place: '', lati:null, long:null, eventType:'' });

  db.individuals[id] = {
    ...existing,
    id, given, surname,
    name: (given + (surname ? ' ' + surname : '')).trim(),
    sex,
    birth: existing.birth || { date:'', place:'', lati:null, long:null, sources:[] },
    death: existing.death || { date:'', place:'', lati:null, long:null, sources:[], cause:'' },
    chr: existing.chr || { date:'', place:'' },
    buri: existing.buri || { date:'', place:'' },
    events,
    noteText: note,
    noteRefs: existing.noteRefs || [],
    famc: existing.famc || [],
    fams: existing.fams || [],
    media: existing.media || [],
    titl: existing.titl || '',
    reli: existing.reli || '',
    lastChanged: existing.lastChanged || '',
    sourceRefs: srcState['pf'] || new Set()
  };

  closeModal('modalPerson');
  markChanged();
  updateStats();
  renderTab();
  showToast('âœ“ Person gespeichert');

  if (currentPersonId === id) showDetail(id);
}

function deletePerson() {
  const id = document.getElementById('pf-id').value;
  if (!id || !db.individuals[id]) return;
  if (!confirm(`${db.individuals[id].name || id} wirklich lÃ¶schen?`)) return;

  // Remove from families
  for (const f of Object.values(db.families)) {
    if (f.husb === id) f.husb = null;
    if (f.wife === id) f.wife = null;
    f.children = f.children.filter(c => c !== id);
  }
  delete db.individuals[id];
  closeModal('modalPerson');
  markChanged(); updateStats();
  showMain(); showToast('âœ“ Person gelÃ¶scht');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FORMS: FAMILY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showFamilyForm(id) {
  closeModal('modalAdd');
  const f = id ? db.families[id] : null;
  document.getElementById('familyFormTitle').textContent = f ? 'Familie bearbeiten' : 'Neue Familie';
  document.getElementById('ff-id').value = id || '';

  // Populate person selects
  const persons = Object.values(db.individuals).sort((a,b) => (a.name||'').localeCompare(b.name||'','de'));
  const optionsAll = '<option value="">â€“ keine â€“</option>' + persons.map(p =>
    `<option value="${p.id}">${esc(p.name || p.id)}</option>`
  ).join('');
  document.getElementById('ff-husb').innerHTML = optionsAll;
  document.getElementById('ff-wife').innerHTML = optionsAll;

  document.getElementById('ff-husb').value = f?.husb || '';
  document.getElementById('ff-wife').value = f?.wife || '';
  document.getElementById('ff-mdate').value = f?.marr?.date || '';
  document.getElementById('ff-mplace').value = f?.marr?.place || '';
  document.getElementById('ff-children').value = f?.children?.join(', ') || '';
  document.getElementById('deleteFamilyBtn').style.display = f ? 'block' : 'none';
  initSrcWidget('ff', f?.marr?.sources || f?.sourceRefs || []);
  openModal('modalFamily');
}

function saveFamily() {
  const id = document.getElementById('ff-id').value || nextId('F');
  const husb = document.getElementById('ff-husb').value || null;
  const wife = document.getElementById('ff-wife').value || null;
  const mdate = document.getElementById('ff-mdate').value.trim();
  const mplace = document.getElementById('ff-mplace').value.trim();
  const childrenRaw = document.getElementById('ff-children').value;
  const children = childrenRaw.split(',').map(s => s.trim()).filter(Boolean);

  const existingFam = db.families[id] || {};
  db.families[id] = {
    ...existingFam,
    id, husb, wife, children,
    marr: { ...(existingFam.marr||{}), date: mdate, place: mplace, sources: [...(srcState['ff'] || [])] },
    noteText: existingFam.noteText || '',
    sourceRefs: srcState['ff'] || new Set()
  };

  // Update FAMS/FAMC references
  for (const p of Object.values(db.individuals)) {
    p.fams = p.fams.filter(f => f !== id);
    p.famc = p.famc.filter(f => f !== id);
  }
  if (husb && db.individuals[husb]) { if (!db.individuals[husb].fams.includes(id)) db.individuals[husb].fams.push(id); }
  if (wife && db.individuals[wife]) { if (!db.individuals[wife].fams.includes(id)) db.individuals[wife].fams.push(id); }
  for (const cid of children) {
    if (db.individuals[cid]) { if (!db.individuals[cid].famc.includes(id)) db.individuals[cid].famc.push(id); }
  }

  closeModal('modalFamily');
  markChanged(); updateStats();
  renderTab();
  showToast('âœ“ Familie gespeichert');
  if (currentFamilyId === id) showFamilyDetail(id);
}

function deleteFamily() {
  const id = document.getElementById('ff-id').value;
  if (!id) return;
  if (!confirm('Familie wirklich lÃ¶schen?')) return;
  for (const p of Object.values(db.individuals)) {
    p.fams = p.fams.filter(f => f !== id);
    p.famc = p.famc.filter(f => f !== id);
  }
  delete db.families[id];
  closeModal('modalFamily');
  markChanged(); updateStats();
  showMain(); showToast('âœ“ Familie gelÃ¶scht');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FORMS: SOURCE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSourceForm(id) {
  closeModal('modalAdd');
  const s = id ? db.sources[id] : null;
  document.getElementById('sourceFormTitle').textContent = s ? 'Quelle bearbeiten' : 'Neue Quelle';
  document.getElementById('sf-id').value = id || '';
  document.getElementById('sf-title').value = s?.title || '';
  document.getElementById('sf-auth').value = s?.author || '';
  document.getElementById('sf-date').value = s?.date || '';
  document.getElementById('sf-repo').value = s?.repo || '';
  document.getElementById('sf-text').value = s?.text || '';
  document.getElementById('deleteSourceBtn').style.display = s ? 'block' : 'none';
  openModal('modalSource');
}

function saveSource() {
  const id = document.getElementById('sf-id').value || nextId('S');
  db.sources[id] = {
    id,
    title: document.getElementById('sf-title').value.trim(),
    author: document.getElementById('sf-auth').value.trim(),
    date: document.getElementById('sf-date').value.trim(),
    repo: document.getElementById('sf-repo').value.trim(),
    text: document.getElementById('sf-text').value.trim()
  };
  closeModal('modalSource');
  markChanged(); updateStats();
  renderTab();
  showToast('âœ“ Quelle gespeichert');
  if (currentSourceId === id) showSourceDetail(id);
}

function deleteSource() {
  const id = document.getElementById('sf-id').value;
  if (!id) return;
  if (!confirm('Quelle wirklich lÃ¶schen?')) return;
  delete db.sources[id];
  closeModal('modalSource');
  markChanged(); updateStats();
  showMain(); showToast('âœ“ Quelle gelÃ¶scht');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FORMS: EVENT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _SPECIAL_OBJ = { BIRT:'birth', CHR:'chr', DEAT:'death', BURI:'buri' };
const _SPECIAL_LBL = { BIRT:'Geburt', CHR:'Taufe', DEAT:'Tod', BURI:'Beerdigung' };

function onEventTypeChange() {
  const t = document.getElementById('ef-type').value;
  document.getElementById('ef-val-group').style.display   = (t in _SPECIAL_OBJ) ? 'none' : '';
  document.getElementById('ef-cause-group').style.display = (t === 'DEAT')       ? ''     : 'none';
}

function showEventForm(personId, evIdx) {
  const p = db.individuals[personId];
  const isSpecial  = typeof evIdx === 'string' && evIdx in _SPECIAL_OBJ;
  const isExisting = typeof evIdx === 'number';
  const typeEl = document.getElementById('ef-type');

  document.getElementById('ef-pid').value    = personId;
  document.getElementById('ef-evidx').value  = isExisting ? evIdx : '';

  if (isSpecial) {
    const obj = p[_SPECIAL_OBJ[evIdx]] || {};
    typeEl.value = evIdx; typeEl.disabled = true;
    document.getElementById('ef-val').value   = '';
    document.getElementById('ef-date').value  = obj.date  || '';
    document.getElementById('ef-place').value = obj.place || '';
    document.getElementById('ef-cause').value = evIdx === 'DEAT' ? (obj.cause || '') : '';
    initSrcWidget('ef', obj.sources || []);
    document.querySelector('#modalEvent .sheet-title').textContent = _SPECIAL_LBL[evIdx] + ' bearbeiten';
    document.getElementById('saveEventBtn').textContent = 'Speichern';
  } else {
    const ev = isExisting ? p.events[evIdx] : null;
    typeEl.disabled = false;
    typeEl.value = ev?.type || 'OCCU';
    document.getElementById('ef-val').value   = ev?.value || '';
    document.getElementById('ef-date').value  = ev?.date  || '';
    document.getElementById('ef-place').value = ev?.place || '';
    document.getElementById('ef-cause').value = '';
    initSrcWidget('ef', ev?.sources || []);
    document.querySelector('#modalEvent .sheet-title').textContent = ev ? 'Ereignis bearbeiten' : 'Ereignis hinzufÃ¼gen';
    document.getElementById('saveEventBtn').textContent = ev ? 'Speichern' : 'HinzufÃ¼gen';
  }
  onEventTypeChange();
  openModal('modalEvent');
}

function saveEvent() {
  const pid = document.getElementById('ef-pid').value;
  const p = db.individuals[pid];
  if (!p) return;
  const type = document.getElementById('ef-type').value;

  if (type in _SPECIAL_OBJ) {
    const key = _SPECIAL_OBJ[type];
    p[key] = { ...(p[key] || {}),
      date:    document.getElementById('ef-date').value.trim(),
      place:   document.getElementById('ef-place').value.trim(),
      sources: [...(srcState['ef'] || [])]
    };
    if (type === 'DEAT') p[key].cause = document.getElementById('ef-cause').value.trim();
  } else {
    const evIdxRaw = document.getElementById('ef-evidx').value;
    const evIdx    = evIdxRaw !== '' ? parseInt(evIdxRaw) : null;
    const ev = {
      type,
      value:     document.getElementById('ef-val').value.trim(),
      date:      document.getElementById('ef-date').value.trim(),
      place:     document.getElementById('ef-place').value.trim(),
      lati: null, long: null, eventType: '', note: '',
      sources:   [...(srcState['ef'] || [])]
    };
    if (evIdx !== null && p.events[evIdx]) {
      ev.lati      = p.events[evIdx].lati;
      ev.long      = p.events[evIdx].long;
      ev.eventType = p.events[evIdx].eventType || '';
      ev.note      = p.events[evIdx].note      || '';
      p.events[evIdx] = ev;
    } else {
      p.events.push(ev);
    }
  }

  closeModal('modalEvent');
  markChanged(); updateStats();
  if (currentPersonId === pid) showDetail(pid);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MODAL HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) {
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
// Close on backdrop click
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}
</script>
</body>
</html>
